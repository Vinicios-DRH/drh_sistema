{% extends "base.html" %}

{% block head %}
<style>
  :root {
    --brand-red: #B5121B;
    --brand-red-600: #9F1119;
    --ink-200: #e8eef6;
    --glass-brd: rgba(255, 255, 255, .12);
  }

  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  .page-wrap {
    padding: 16px 10px
  }

  /* Cartão “glass” principal */
  .glass-card {
    background: rgba(255, 255, 255, .96);
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
    overflow: hidden;
  }

  /* Cabeçalho brand */
  .brand-top {
    background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
    border-bottom: 1px solid var(--glass-brd);
    color: var(--ink-200);
    padding: 18px;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .brand-top h4 {
    margin: 0;
    font-weight: 800
  }

  .brand-top-contrast {
    background: linear-gradient(90deg, #0b2e4f 0%, #0b3a63 100%);
    border-bottom: 1px solid rgba(0, 0, 0, .06);
    color: #fff;
  }

  .brand-top-contrast h4 {
    color: #fff;
  }

  .brand-top-contrast .muted,
  .brand-top-contrast .small {
    color: rgba(255, 255, 255, .9) !important;
    opacity: 1;
  }

  .muted {
    opacity: .85
  }

  /* Resumo */
  .meta-grid {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  @media (max-width: 768px) {
    .meta-grid {
      grid-template-columns: 1fr
    }
  }

  .meta-item {
    border: 1px solid rgba(0, 0, 0, .08);
    border-radius: 14px;
    background: #fff;
    padding: 12px 14px;
  }

  .meta-item .label {
    font-size: .85rem;
    opacity: .8
  }

  .meta-item .value {
    font-weight: 800
  }

  .status-badge {
    font-weight: 800;
    letter-spacing: .2px
  }

  /* Arquivos */
  .files-card {
    border: 1px solid rgba(0, 0, 0, .08);
    border-radius: 16px;
    background: #fff;
    overflow: hidden;
  }

  .files-card .head {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
    background: rgba(248, 249, 250, .85);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }

  .file-row {
    padding: 12px 16px;
    border-top: 1px solid rgba(0, 0, 0, .06);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  .file-row:first-child {
    border-top: none
  }

  .file-name {
    font-weight: 700
  }

  .file-key {
    font-size: .85rem;
    opacity: .75;
    word-break: break-all
  }

  .btns {
    display: flex;
    gap: 8px;
    flex-wrap: wrap
  }

  .truncate {
    max-width: 520px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis
  }

  /* Stack de ações */
  .actions-stack {
    display: flex;
    gap: 10px;
    flex-wrap: wrap
  }

  .actions-stack .btn {
    min-width: 220px
  }

  /* Botões topo */
  .top-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap
  }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid page-wrap">

  <!-- Topo: título + ações -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h4 class="mb-0" style="color: #e8eef6;">Protocolo: <span class="fw-bold">{{ p.protocolo }}</span></h4>
      <div class="muted small" style="color: #e8eef6;">Detalhes do envio e arquivos anexados para conferência DP.</div>
    </div>
    <div class="top-actions">
      <a class="btn btn-outline-secondary" href="{{ url_for('dep.drh_lista_processos') }}">← Voltar</a>
      <button class="btn btn-outline-primary" type="button" onclick="location.reload()">⟳ Atualizar</button>
    </div>
  </div>

  <!-- Resumo do Processo -->
  <div class="glass-card mb-3">
    <div class="brand-top brand-top-contrast d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <h4>Resumo do Processo</h4>
        <div class="muted small">Confira dados, abra anexos e finalize o check (ou indefira).</div>
      </div>
      <div class="text-end">
        {% set st = (p.status or 'ENVIADO')|upper %}
        {% if st == 'ENVIADO' %}
        <span class="badge bg-warning text-dark status-badge">ENVIADO</span>
        {% elif st == 'EM_ANALISE' or st == 'EM_ANÁLISE' %}
        <span class="badge bg-info text-dark status-badge">EM ANÁLISE</span>
        {% elif st == 'DEFERIDO' %}
        <span class="badge bg-success status-badge">DEFERIDO</span>
        {% elif st == 'INDEFERIDO' %}
        <span class="badge bg-danger status-badge">INDEFERIDO</span>
        {% else %}
        <span class="badge bg-secondary status-badge">{{ st }}</span>
        {% endif %}
        <div class="small muted mt-1">Ano (pasta): <b>{{ p.ano }}</b></div>
      </div>
    </div>

    <div class="p-3 p-md-4">
      <div class="meta-grid">
        <!-- Militar -->
        <div class="meta-item">
          <div class="label">Militar</div>
          <div class="value">{{ p.militar.nome_completo if p.militar else "—" }}</div>
          <div class="muted small">Matrícula: <b>{{ p.militar.matricula if p.militar else "—" }}</b></div>
          <div class="muted small">
            CPF:
            <b>
              <span class="cpf" data-cpf="{{ p.militar.cpf if p.militar else '' }}">
                {{ p.militar.cpf if p.militar else "—" }}
              </span>
            </b>
          </div>
        </div>

        <!-- Envio -->
        <div class="meta-item">
          <div class="label">Envio</div>
          <div class="value">
            {% if p.enviado_em %}{{ p.enviado_em.strftime("%d/%m/%Y %H:%M") }}{% else %}—{% endif %}
          </div>
          <div class="muted small">IP: <b>{{ p.enviado_ip or "—" }}</b></div>
        </div>

        <!-- Conferência -->
        <div class="meta-item">
          <div class="label">Conferência DRH</div>
          <div class="value">
            {% if p.conferido_em %}{{ p.conferido_em.strftime("%d/%m/%Y %H:%M") }}{% else %}—{% endif %}
          </div>
          <div class="muted small">
            Por: <b>
              {% if p.conferido_por %}
              {{ p.conferido_por.nome if p.conferido_por.nome else 'Usuário #' ~ p.conferido_por.id }}
              {% else %}—{% endif %}
            </b>
          </div>
          <div class="muted small">IP: <b>{{ p.conferido_ip or "—" }}</b></div>
        </div>

        <!-- Ações -->
        <div class="meta-item">
          <div class="label">Ações</div>
          <div class="muted small mb-2">Valide os anexos e finalize.</div>

          <div class="actions-stack">
            <!-- CHECK / CONFERIR -->
            <form method="POST" action="{{ url_for('dep.drh_conferir_processo', processo_id=p.id) }}"
              onsubmit="return confirmConferir()" class="flex-grow-1">
              <button id="btnCheck" class="btn btn-success w-100" type="submit">✅ Dar CHECK (Conferido)</button>
            </form>

            <!-- INDEFERIR (modal) -->
            <button class="btn btn-danger flex-grow-1" type="button" data-bs-toggle="modal"
              data-bs-target="#modalIndeferir">
              ❌ Indeferir (faltou doc)
            </button>

            <!-- DEFERIR -->
            <form method="POST" action="{{ url_for('dep.drh_deferir_processo', processo_id=p.id) }}"
              onsubmit="return confirmDeferir()" class="flex-grow-1">
              <button id="btnDeferir" class="btn btn-primary w-100" type="submit">✅ Deferir</button>
            </form>
          </div>

          <div class="muted small mt-2">Ao confirmar, será registrado: usuário, data/hora (Manaus) e IP.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Arquivos anexados -->
  <div class="files-card">
    <div class="head">
      <div>
        <div class="fw-bold">Arquivos anexados ({{ arquivos|length }})</div>
        <div class="muted small">Links temporários (expiram). Abra e confira antes de finalizar.</div>
      </div>
      <div class="btns">
        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="expandKeys()">Mostrar/ocultar
          keys</button>
      </div>
    </div>

    {% if arquivos|length == 0 %}
    <div class="p-4 text-center muted">Nenhum arquivo registrado neste protocolo.</div>
    {% else %}
    {% for a in arquivos %}
    <div class="file-row">
      <div style="min-width:0;">
        <div class="file-name truncate">{{ a.nome or "Arquivo" }}</div>
        <div class="file-key d-none fileKey">{{ a.key }}</div>
      </div>
      <div class="btns">
        <a class="btn btn-sm btn-primary" href="{{ a.url }}" target="_blank" rel="noopener">Abrir/baixar</a>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyText('{{ a.key|e }}')">Copiar
          key</button>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyText('{{ a.url|e }}')">Copiar
          URL</button>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

</div>

<!-- MODAL INDEFERIR -->
<div class="modal fade" id="modalIndeferir" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="POST" action="{{ url_for('dep.drh_indeferir_processo', processo_id=p.id) }}"
      onsubmit="return confirmIndeferir()">
      <div class="modal-header">
        <h5 class="modal-title">Indeferir protocolo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning small mb-3">
          Use quando <b>faltarem documentos</b> ou houver inconsistência. Informe o motivo para ficar registrado.
        </div>

        <label class="form-label">Motivo do indeferimento</label>
        <textarea id="motivoIndeferir" name="motivo" class="form-control" rows="4"
          placeholder="Ex.: Faltou certidão de nascimento do dependente + documento X..." required></textarea>

        <div class="form-text">Isso será registrado no log com data/hora (Manaus), usuário e IP.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnIndeferir" type="submit" class="btn btn-danger">Confirmar indeferimento</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ---- confirmações e prevenção de duplo clique ----
  function lockBtn(btn) {
    try { btn.disabled = true; btn.dataset.originalText = btn.textContent; btn.textContent = 'Processando...'; } catch (e) { }
    setTimeout(() => { try { btn.disabled = false; btn.textContent = btn.dataset.originalText || 'Enviar'; } catch (e) { } }, 4000);
  }

  function confirmConferir() {
    const st = "{{ (p.status or 'ENVIADO')|upper }}";
    const btn = document.getElementById('btnCheck');
    if (st === "DEFERIDO" || st === "INDEFERIDO") {
      const ok = confirm("Este processo já parece finalizado. Deseja marcar como conferido novamente?");
      if (ok) lockBtn(btn);
      return ok;
    }
    const ok = confirm("Confirma que conferiu os anexos e deseja dar CHECK?");
    if (ok) lockBtn(btn);
    return ok;
  }

  function confirmDeferir() {
    const btn = document.getElementById('btnDeferir');
    const ok = confirm("Confirma o DEFERIMENTO deste protocolo?");
    if (ok) lockBtn(btn);
    return ok;
  }

  function confirmIndeferir() {
    const motivo = (document.getElementById("motivoIndeferir")?.value || "").trim();
    const btn = document.getElementById('btnIndeferir');
    if (!motivo) { alert("Informe o motivo do indeferimento."); return false; }
    const ok = confirm("Confirma INDEFERIR este protocolo? Essa ação ficará registrada.");
    if (ok) lockBtn(btn);
    return ok;
  }

  // ---- utilidades UI ----
  function expandKeys() {
    document.querySelectorAll(".fileKey").forEach(el => el.classList.toggle("d-none"));
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      toast("Copiado!");
    } catch (e) {
      const t = document.createElement("textarea");
      t.value = text; document.body.appendChild(t); t.select();
      document.execCommand("copy"); t.remove();
      toast("Copiado!");
    }
  }

  function toast(msg) {
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.position = "fixed"; el.style.bottom = "18px"; el.style.left = "50%";
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(0,0,0,.85)"; el.style.color = "#fff";
    el.style.padding = "10px 14px"; el.style.borderRadius = "999px";
    el.style.zIndex = 9999; el.style.fontSize = ".95rem";
    document.body.appendChild(el); setTimeout(() => el.remove(), 1400);
  }

  // ---- formatação visual do CPF exibido ----
  (function () {
    const fmt = v => {
      const d = String(v || "").replace(/\D+/g, "").slice(0, 11);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.replace(/(\d{3})(\d+)/, "$1.$2");
      if (d.length <= 9) return d.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
      return d.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
    };
    document.querySelectorAll(".cpf[data-cpf]").forEach(el => {
      const raw = el.getAttribute("data-cpf") || "";
      if (raw) el.textContent = fmt(raw);
    });
  })();
</script>
{% endblock %}