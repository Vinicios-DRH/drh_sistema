{% extends "base.html" %}

{% block head %}
<style>
  :root {
    --brand-red: #B5121B;
    --brand-red-600: #9F1119;
    --ink-200: #e8eef6;
    --glass-brd: rgba(255, 255, 255, .12);
  }

  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  /* Cabe√ßalho */
  .brand-top {
    background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
    border: 1px solid var(--glass-brd);
    border-radius: 14px;
    color: var(--ink-200);
    box-shadow: 0 8px 22px rgba(0, 0, 0, .35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .brand-top h4 {
    margin: 0;
    font-weight: 800
  }

  .muted {
    opacity: .85
  }

  /* Painel principal ‚Äúglass‚Äù */
  .glass-panel {
    background: rgba(255, 255, 255, .96);
    color: #111;
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
    background: rgba(255, 255, 255, .65)
  }

  .toolbar .input-group-text {
    background: var(--brand-red);
    color: #fff;
    border-color: var(--brand-red)
  }

  .toolbar .form-control {
    border-radius: .6rem
  }

  .btn-outline-primary {
    font-weight: 600
  }

  /* KPIs */
  .kpi {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
    background: #f8fafc
  }

  .pill {
    border: 1px solid rgba(0, 0, 0, .08);
    border-radius: 999px;
    padding: 6px 10px;
    background: #fff;
    font-weight: 600
  }

  /* Tabela */
  .table-wrap {
    padding: 12px
  }

  .table-responsive {
    max-height: clamp(420px, 70dvh, 78dvh);
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .08)
  }

  .table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: #f8fafc !important;
    color: #334155;
    text-transform: uppercase;
    font-size: .74rem;
    letter-spacing: .02em;
    border-bottom: 1px solid rgba(0, 0, 0, .06)
  }

  .table-hover tbody tr:hover {
    background: rgba(181, 18, 27, .06)
  }

  .table td,
  .table th {
    vertical-align: middle
  }

  .table .small2 {
    font-size: .88rem
  }

  .nowrap {
    white-space: nowrap
  }

  .truncate {
    max-width: 360px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap
  }

  @media (max-width:576px) {
    .truncate {
      max-width: 220px
    }
  }

  .row-link {
    cursor: pointer
  }

  .row-disabled {
    cursor: default;
    opacity: .92
  }

  /* Badges de status */
  .status-badge {
    font-weight: 700;
    letter-spacing: .2px
  }

  /* Pager */
  .pager {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    padding: 12px;
    border-top: 1px solid rgba(0, 0, 0, .06);
    background: rgba(255, 255, 255, .65)
  }

  .pager .meta {
    font-size: .92rem;
    opacity: .9
  }

  /* Anima√ß√£o de entrada */
  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(6px)
    }

    to {
      opacity: 1;
      transform: translateY(0)
    }
  }

  tbody tr {
    opacity: 0
  }

  tbody tr.show {
    animation: fadeUp .35s ease-out forwards
  }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid py-3 px-2 px-md-3">
  <!-- Cabe√ßalho -->
  <div class="brand-top p-3 p-md-4 mb-3">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <h4>DP ‚Ä¢ Inclus√£o de Dependentes</h4>
        <div class="muted small">Central de recebimento e confer√™ncia de protocolos enviados pelos militares.</div>
      </div>
      <div class="text-end">
        <span class="badge bg-primary">CBMAM</span>
        <div class="small muted mt-1">Atualize a lista quando necess√°rio.</div>
      </div>
    </div>
  </div>

  <!-- Painel -->
  <div class="glass-panel">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="input-group" style="max-width:720px; flex:1 1 420px;">
        <span class="input-group-text">üîé</span>
        <input id="searchInput" class="form-control"
          placeholder="Buscar por protocolo, nome, CPF, matr√≠cula, status...">
        <button id="btnClear" class="btn btn-outline-secondary" type="button">Limpar</button>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <select id="filterStatus" class="form-select" style="min-width:220px">
          <option value="">Todos os status</option>
          <option value="NAO_ENVIADO">N√ÉO ENVIADO</option>
          <option value="ENVIADO">ENVIADO</option>
          <option value="EM_ANALISE">EM_AN√ÅLISE</option>
          <option value="DEFERIDO">DEFERIDO</option>
          <option value="INDEFERIDO">INDEFERIDO</option>
        </select>

        <button id="btnRefresh" class="btn btn-outline-primary" type="button" onclick="location.reload()">‚ü≥
          Atualizar</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi">
      <div class="pill">Total: <b id="kpiTotal">{{ resultados|length }}</b></div>
      <div class="pill">N√ÉO ENVIADO: <b id="kpiNaoEnviado">0</b></div>
      <div class="pill">ENVIADO: <b id="kpiEnviado">0</b></div>
      <div class="pill">EM AN√ÅLISE: <b id="kpiAnalise">0</b></div>
      <div class="pill">DEFERIDO: <b id="kpiDeferido">0</b></div>
      <div class="pill">INDEFERIDO: <b id="kpiIndeferido">0</b></div>
      <div class="pill">Exibindo: <b id="kpiExibindo">{{ resultados|length }}</b></div>
    </div>

    <!-- Tabela -->
    <div class="table-wrap">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="nowrap">Protocolo</th>
              <th>Militar</th>
              <th class="nowrap">Matr√≠cula</th>
              <th class="nowrap">Enviado em</th>
              <th class="nowrap">Status</th>
              <th class="nowrap">Conferido por</th>
              <th class="nowrap text-end">A√ß√µes</th>
            </tr>
          </thead>

          <tbody id="tbody">
            {% for militar, p in resultados %}
            {% set has_p = (p is not none) %}
            {% set st = (p.status if has_p else 'NAO_ENVIADO')|upper %}

            <tr class="{% if has_p %}row-link{% else %}row-disabled{% endif %}"
              data-hasprocess="{{ '1' if has_p else '0' }}" data-status="{{ st }}"
              data-protocolo="{{ p.protocolo if has_p else '' }}" data-nome="{{ (militar.nome_completo or '')|lower }}"
              data-cpf="{{ militar.cpf or '' }}" data-matricula="{{ militar.matricula or '' }}" {% if has_p %}
              onclick="window.location.href='{{ url_for('dep.drh_detalhe_processo', processo_id=p.id) }}'" {% endif %}>
              <td class="nowrap">
                {% if has_p %}
                <span class="fw-bold">{{ p.protocolo }}</span>
                <div class="small muted">ID: {{ p.id }}</div>
                {% else %}
                <span class="muted">‚Äî</span>
                <div class="small muted">Sem protocolo</div>
                {% endif %}
              </td>

              <td>
                <div class="fw-semibold truncate">{{ militar.nome_completo or "‚Äî" }}</div>
                <div class="small2 muted">CPF: {{ militar.cpf or "‚Äî" }}</div>
              </td>

              <td class="nowrap">{{ militar.matricula or "‚Äî" }}</td>

              <td class="nowrap">
                {% if has_p and p.enviado_em %}
                {{ p.enviado_em.strftime("%d/%m/%Y %H:%M") }}
                <div class="small muted">IP: {{ p.enviado_ip or "‚Äî" }}</div>
                {% else %}
                ‚Äî
                {% endif %}
              </td>

              <td class="nowrap">
                {% if st == 'NAO_ENVIADO' %}
                <span class="badge bg-secondary status-badge">N√ÉO ENVIADO</span>
                {% elif st == 'ENVIADO' %}
                <span class="badge bg-warning text-dark status-badge">ENVIADO</span>
                {% elif st == 'EM_ANALISE' or st == 'EM_AN√ÅLISE' %}
                <span class="badge bg-info text-dark status-badge">EM AN√ÅLISE</span>
                {% elif st == 'DEFERIDO' %}
                <span class="badge bg-success status-badge">DEFERIDO</span>
                {% elif st == 'INDEFERIDO' %}
                <span class="badge bg-danger status-badge">INDEFERIDO</span>
                {% else %}
                <span class="badge bg-secondary status-badge">{{ st }}</span>
                {% endif %}
              </td>

              <td class="nowrap">
                {% if has_p and p.conferido_por %}
                <div class="fw-semibold">
                  {{ p.conferido_por.nome if p.conferido_por.nome else 'Usu√°rio #' ~ p.conferido_por.id }}
                </div>
                <div class="small muted">{{ p.conferido_em.strftime("%d/%m/%Y %H:%M") if p.conferido_em else "" }}</div>
                {% else %}
                <span class="muted">‚Äî</span>
                {% endif %}
              </td>

              <td class="text-end nowrap" onclick="event.stopPropagation()">
                {% if has_p %}
                <a class="btn btn-sm btn-outline-primary"
                  href="{{ url_for('dep.drh_detalhe_processo', processo_id=p.id) }}">
                  Abrir
                </a>
                {% else %}
                <span class="text-muted small">Aguardando envio</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if resultados|length == 0 %}
        <div class="p-4 text-center muted">Nenhum registro encontrado.</div>
        {% endif %}
      </div>
    </div>

    <!-- Pagina√ß√£o -->
    <div class="pager">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div class="meta">Mostrando <b id="showFrom">0</b>‚Äì<b id="showTo">0</b> de <b id="showTotal">0</b></div>
        <div class="d-flex align-items-center gap-2">
          <label class="small muted mb-0">Itens/p√°gina</label>
          <select id="pageSize" class="form-select form-select-sm" style="width:110px">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button id="btnPrev" class="btn btn-outline-secondary btn-sm" type="button">‚Üê Anterior</button>
        <span class="meta">P√°gina <b id="pageNow">1</b> / <b id="pageTotal">1</b></span>
        <button id="btnNext" class="btn btn-outline-secondary btn-sm" type="button">Pr√≥xima ‚Üí</button>
      </div>
    </div>

  </div>
</div>

<script>
  (function () {
    const allRows = Array.from(document.querySelectorAll("#tbody tr"));
    const searchInput = document.getElementById("searchInput");
    const filterStatus = document.getElementById("filterStatus");
    const btnClear = document.getElementById("btnClear");
    const pageSizeEl = document.getElementById("pageSize");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiNaoEnviado = document.getElementById("kpiNaoEnviado");
    const kpiEnviado = document.getElementById("kpiEnviado");
    const kpiAnalise = document.getElementById("kpiAnalise");
    const kpiDeferido = document.getElementById("kpiDeferido");
    const kpiIndeferido = document.getElementById("kpiIndeferido");
    const kpiExibindo = document.getElementById("kpiExibindo");

    const showFrom = document.getElementById("showFrom");
    const showTo = document.getElementById("showTo");
    const showTotal = document.getElementById("showTotal");
    const pageNow = document.getElementById("pageNow");
    const pageTotal = document.getElementById("pageTotal");

    let filtered = [...allRows];
    let currentPage = 1;

    // Remo√ß√£o de acentos + normaliza√ß√£o
    const deaccent = (s) => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const norm = (s) => deaccent(String(s).toLowerCase().trim());

    // KPIs por status (total do dataset)
    function calcKPIsBase() {
      let cNE = 0, cEnv = 0, cAna = 0, cDef = 0, cInd = 0;
      allRows.forEach(r => {
        const st = (r.dataset.status || "").toUpperCase();
        if (st === "NAO_ENVIADO") cNE++;
        else if (st === "ENVIADO") cEnv++;
        else if (st === "EM_ANALISE" || st === "EM_AN√ÅLISE") cAna++;
        else if (st === "DEFERIDO") cDef++;
        else if (st === "INDEFERIDO") cInd++;
      });
      kpiNaoEnviado.textContent = cNE;
      kpiEnviado.textContent = cEnv;
      kpiAnalise.textContent = cAna;
      kpiDeferido.textContent = cDef;
      kpiIndeferido.textContent = cInd;
      kpiTotal.textContent = allRows.length; // garante consist√™ncia
    }

    function applyFilters() {
      const q = norm(searchInput.value);
      const stf = (filterStatus.value || "").toUpperCase();

      filtered = allRows.filter(r => {
        const st = (r.dataset.status || "").toUpperCase();
        const hay = [
          r.dataset.protocolo,
          r.dataset.nome,
          r.dataset.cpf,
          r.dataset.matricula,
          st
        ].map(norm).join(" | ");

        const okQ = !q || hay.includes(q);
        const okS = !stf || st === stf;
        return okQ && okS;
      });

      currentPage = 1;
      render();
    }

    function render() {
      const pageSize = parseInt(pageSizeEl.value || "25", 10);
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));

      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;

      // esconde tudo
      allRows.forEach(r => { r.style.display = "none"; r.classList.remove('show'); });
      // mostra s√≥ a p√°gina atual + anima√ß√£o
      filtered.slice(start, end).forEach((r, i) => {
        r.style.display = "";
        setTimeout(() => r.classList.add('show'), i * 15);
      });

      // KPIs exibindo
      kpiExibindo.textContent = total;

      // footer
      showTotal.textContent = total;
      showFrom.textContent = total === 0 ? 0 : (start + 1);
      showTo.textContent = Math.min(end, total);
      pageNow.textContent = total === 0 ? 0 : currentPage;
      pageTotal.textContent = total === 0 ? 0 : totalPages;

      btnPrev.disabled = (currentPage <= 1);
      btnNext.disabled = (currentPage >= totalPages) || (total === 0);
    }

    // Handlers
    let t;
    const debouncedFilter = () => {
      clearTimeout(t);
      t = setTimeout(applyFilters, 180);
    };

    btnPrev.addEventListener("click", () => { currentPage = Math.max(1, currentPage - 1); render(); });
    btnNext.addEventListener("click", () => {
      const pageSize = parseInt(pageSizeEl.value || "25", 10);
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      currentPage = Math.min(totalPages, currentPage + 1);
      render();
    });

    pageSizeEl.addEventListener("change", () => { currentPage = 1; render(); });

    btnClear.addEventListener("click", () => {
      searchInput.value = ""; filterStatus.value = "";
      applyFilters(); searchInput.focus();
    });

    searchInput.addEventListener("input", debouncedFilter);
    filterStatus.addEventListener("change", applyFilters);

    // Init
    calcKPIsBase();
    applyFilters();
  })();
</script>
{% endblock %}