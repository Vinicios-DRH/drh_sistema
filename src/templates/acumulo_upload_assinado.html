{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    :root {
        --brand-red: #B5121B;
        --brand-red-600: #9f1119;
        --ink-100: #f6f8fb;
        --ink-200: #e8eef6;
        --ink-300: #cfe4ff;
        --ink-400: #c0cfda;
        --glass-bg: rgba(255, 255, 255, .06);
        --glass-brd: rgba(255, 255, 255, .18);
    }

    body {
        background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
    }

    .btn-primary {
        background: var(--brand-red);
        border-color: var(--brand-red);
    }

    .btn-primary:hover {
        background: var(--brand-red-600);
        border-color: var(--brand-red-600);
    }

    .btn-outline-primary {
        color: var(--brand-red);
        border-color: var(--brand-red);
    }

    .btn-outline-primary:hover {
        color: #fff;
        background: var(--brand-red);
    }

    .brand-header {
        background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        color: var(--ink-200);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }

    .glass-card {
        background: var(--glass-bg);
        color: var(--ink-200);
        border: 1px solid var(--glass-brd);
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }

    .muted {
        color: var(--ink-300)
    }

    .upload-zone {
        border: 2px dashed var(--glass-brd);
        border-radius: 14px;
        background: rgba(255, 255, 255, .04);
        padding: 1.25rem;
        text-align: center;
        transition: .15s ease;
    }

    .upload-zone.dragover {
        border-color: var(--brand-red);
        background: rgba(181, 18, 27, .08);
    }

    .upload-zone .icon {
        font-size: 2rem;
        display: block;
        margin-bottom: .35rem;
        opacity: .9
    }

    .upload-zone input[type="file"] {
        display: none;
    }

    .file-pill {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        padding: .35rem .6rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, .12);
        border: 1px solid var(--glass-brd);
        color: var(--ink-200);
        font-size: .9rem;
    }

    .requirements li {
        margin: .2rem 0;
    }

    .action-bar {
        position: sticky;
        bottom: 8px;
        z-index: 4;
        background: rgba(181, 18, 27, .12);
        border: 1px solid var(--glass-brd);
        border-radius: 14px;
        padding: .65rem;
        display: flex;
        gap: .5rem;
        justify-content: flex-end;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
    <div class="container-xxl">

        <!-- Cabeçalho -->
        <div class="brand-header p-3 p-md-4 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded"
                        alt="CBMAM">
                    <div>
                        <h1 class="h5 mb-1">Enviar documentos assinados — {{ ano }}</h1>
                        <div class="small text-light opacity-75">
                            {% if tipo == 'positiva' %}
                            Envie <strong>dois PDFs</strong>: (1) o <strong>modelo assinado por você</strong> e (2) a
                            <strong>declaração do órgão público</strong>.
                            {% else %}
                            Envie o <strong>modelo assinado por você</strong> (PDF).
                            {% endif %}
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('acumulo.novo', militar_id=militar.id) }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>

        <!-- Card -->
        <div class="glass-card p-3 p-md-4">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                <div class="row g-3">

                    <!-- Coluna uploads -->
                    <div class="col-lg-8">

                        <!-- Upload 1: Modelo assinado pelo militar -->
                        <label class="form-label">1) Modelo assinado pelo militar (PDF)</label>
                        <label class="upload-zone w-100" id="dropArea1">
                            <i class="bi bi-cloud-arrow-up icon"></i>
                            <div class="mb-1">Arraste o arquivo aqui ou <span class="text-decoration-underline">clique
                                    para selecionar</span></div>
                            <div class="small muted">Apenas PDF • máx. <span id="maxMbLabel1">20</span> MB</div>
                            <input type="file" id="fileInput1" name="arquivo_modelo_assinado"
                                accept="application/pdf,.pdf" required>
                        </label>
                        <div id="fileInfo1" class="mt-2 d-none">
                            <span class="file-pill">
                                <i class="bi bi-file-earmark-pdf-fill"></i>
                                <span id="fileName1">arquivo.pdf</span>
                                <span class="opacity-75">•</span>
                                <span id="fileSize1">0 MB</span>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1" id="btnClear1">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </span>
                        </div>
                        <div id="fileError1" class="text-danger small mt-2 d-none"></div>

                        <!-- Upload 2: Declaração do órgão público (obrigatório só quando positiva) -->
                        <div id="orgaoBlock" class="mt-4 {% if tipo != 'positiva' %}d-none{% endif %}">
                            <label class="form-label">2) Declaração do órgão público (PDF)</label>
                            <label class="upload-zone w-100" id="dropArea2">
                                <i class="bi bi-cloud-arrow-up icon"></i>
                                <div class="mb-1">Arraste o arquivo aqui ou <span
                                        class="text-decoration-underline">clique para selecionar</span></div>
                                <div class="small muted">Apenas PDF • máx. <span id="maxMbLabel2">20</span> MB</div>
                                <input type="file" id="fileInput2" name="arquivo_declaracao_orgao"
                                    accept="application/pdf,.pdf" {% if tipo=='positiva' %}required{% endif %}>
                            </label>
                            <div id="fileInfo2" class="mt-2 d-none">
                                <span class="file-pill">
                                    <i class="bi bi-file-earmark-pdf-fill"></i>
                                    <span id="fileName2">arquivo.pdf</span>
                                    <span class="opacity-75">•</span>
                                    <span id="fileSize2">0 MB</span>
                                    <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1"
                                        id="btnClear2">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </span>
                            </div>
                            <div id="fileError2" class="text-danger small mt-2 d-none"></div>
                        </div>
                    </div>

                    <!-- Coluna requisitos -->
                    <div class="col-lg-4">
                        <div class="p-3 rounded-3"
                            style="background:rgba(255,255,255,.06); border:1px solid var(--glass-brd)">
                            <div class="fw-semibold mb-2">Requisitos</div>
                            <ul class="requirements small muted mb-0">
                                <li>Formato <strong>PDF</strong>.</li>
                                <li>Documentos legíveis e assinados.</li>
                                {% if tipo == 'positiva' %}
                                <li>Enviar <strong>ambos</strong> os arquivos.</li>
                                {% endif %}
                                <li>Tamanho máximo: <strong><span class="maxMbLabel">20</span> MB</strong> por arquivo.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- barra de ação -->
                <div class="action-bar mt-3">
                    <a href="{{ url_for('acumulo.novo', militar_id=militar.id) }}"
                        class="btn btn-outline-light">Cancelar</a>
                    <button class="btn btn-primary" type="submit" id="btnSubmit" disabled>
                        <span class="spinner-border spinner-border-sm me-1 d-none" id="upSpinner" role="status"
                            aria-hidden="true"></span>
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
    (() => {
        // ===== Config =====
        const MAX_MB = 20;
        const ACCEPT_MIME = 'application/pdf';
        const isPositiva = {{ (tipo == 'positiva') | tojson
    }};

    // ===== Helpers =====
    const bytesToMB = b => (b / (1024 * 1024));
    const setTxt = (sel, txt) => { const el = document.querySelector(sel); if (el) el.textContent = txt; }

    // Set labels
    setTxt('#maxMbLabel1', MAX_MB);
    setTxt('#maxMbLabel2', MAX_MB);
    document.querySelectorAll('.maxMbLabel').forEach(el => el.textContent = MAX_MB);

    function initUpload(zoneId, inputId, infoId, nameId, sizeId, clearId, errorId) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        const info = document.getElementById(infoId);
        const name = document.getElementById(nameId);
        const size = document.getElementById(sizeId);
        const clear = document.getElementById(clearId);
        const err = document.getElementById(errorId);

        function showError(msg) {
            if (!err) return;
            err.textContent = msg || '';
            err.classList.toggle('d-none', !msg);
        }
        function preview(file) {
            if (!info || !name || !size) return;
            name.textContent = file.name;
            size.textContent = bytesToMB(file.size).toFixed(2) + ' MB';
            info.classList.remove('d-none');
        }
        function clearFile() {
            if (input) input.value = '';
            if (info) info.classList.add('d-none');
            showError('');
            updateSubmitState();
        }
        function validate(file) {
            if (!file) return false;
            const isPdf = (file.type === ACCEPT_MIME) || /\.pdf$/i.test(file.name);
            if (!isPdf) { showError('Apenas arquivos PDF são aceitos.'); return false; }
            if (bytesToMB(file.size) > MAX_MB) { showError(`Arquivo excede ${MAX_MB} MB.`); return false; }
            showError('');
            return true;
        }

        ['dragenter', 'dragover'].forEach(evt => {
            zone?.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); zone.classList.add('dragover'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
            zone?.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); zone.classList.remove('dragover'); });
        });
        zone?.addEventListener('drop', e => {
            const f = e.dataTransfer.files?.[0];
            if (!f) return;
            if (validate(f)) { input.files = e.dataTransfer.files; preview(f); }
            updateSubmitState();
        });

        input?.addEventListener('change', () => {
            const f = input.files?.[0];
            if (!f) { clearFile(); return; }
            if (validate(f)) { preview(f); }
            updateSubmitState();
        });

        clear?.addEventListener('click', e => { e.preventDefault(); clearFile(); });

        return { input };
    }

    // Instâncias
    const up1 = initUpload('dropArea1', 'fileInput1', 'fileInfo1', 'fileName1', 'fileSize1', 'btnClear1', 'fileError1');
    const up2 = initUpload('dropArea2', 'fileInput2', 'fileInfo2', 'fileName2', 'fileSize2', 'btnClear2', 'fileError2');

    const btnSubmit = document.getElementById('btnSubmit');
    const spinner = document.getElementById('upSpinner');

    function updateSubmitState() {
        const has1 = !!(up1?.input?.files && up1.input.files.length);
        const has2 = !!(up2?.input?.files && up2.input.files.length);
        const ok = isPositiva ? (has1 && has2) : has1;
        if (btnSubmit) btnSubmit.disabled = !ok;
    }
    updateSubmitState();

    // Submissão com feedback
    const form = document.getElementById('uploadForm');
    form?.addEventListener('submit', () => {
        btnSubmit.disabled = true;
        spinner?.classList.remove('d-none');
    });
}) ();
</script>
{% endblock %}