{% extends "base.html" %}

{% block head %}
<style>
  :root{
    --brand-blue-700:#0d2036;
    --brand-blue-600:#0c3761;
  }

  /* fundo padrão */
  body{
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  .page-wrap{ padding:18px 10px; }

  /* ===== ALERTA FLUTUANTE À FRENTE DA NAVBAR ===== */
  .alert-stack{
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: min(960px, 96vw);
    z-index: 99999;           /* maior que navbar, dropdowns, offcanvas e até modal padrão */
    pointer-events: none;     /* evita bloquear cliques fora do alerta */
  }
  .alert-stack .alert{
    pointer-events: auto;     /* permite clicar no X do alerta */
    box-shadow: 0 10px 24px rgba(0,0,0,.18);
    border-radius: 12px;
    margin-bottom: 8px;
  }

  /* Card principal (padrão) */
  .glass-card{
    background:rgba(255,255,255,.96);
    border:1px solid rgba(0,0,0,.06);
    border-radius:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.12);
    overflow:hidden;
  }

  /* Cabeçalho com alto contraste */
  .brand-top{
    background:linear-gradient(90deg, var(--brand-blue-700) 0%, var(--brand-blue-600) 100%);
    color:#fff; padding:16px 18px;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .brand-top h4{ margin:0; font-weight:900; }

  .muted{ opacity:.85; }
  .section-title{ font-weight:800; font-size:1.05rem; margin:10px 0 6px; }
  .hint{ font-size:.9rem; opacity:.85; }
  .btn-primary{ font-weight:700; }

  @media (max-width:576px){
    .form-label{ font-size:.92rem; }
  }
</style>
{% endblock %}

{% block body %}

{# ======= PILHA DE AVISOS (sempre na frente da navbar) ======= #}
<div class="alert-stack" id="alertStack" aria-live="polite" aria-atomic="true">
  {% if aviso %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      {{ aviso|safe }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
  {% endif %}

  {% with msgs=get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      {% for category, msg in msgs %}
        {% set cat = category if category in ['primary','secondary','success','danger','warning','info','light','dark'] else 'info' %}
        <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
          {{ msg|safe }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="container-fluid page-wrap">
  <div class="glass-card">
    <div class="brand-top d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <h4>Requerimento – Inclusão de Dependente</h4>
        <div class="muted small">
          Preencha e clique em <b>Gerar e baixar</b>. Após baixar, você será levado ao upload.
        </div>
      </div>
      <span class="badge bg-primary">CBMAM</span>
    </div>

    <div class="p-3 p-md-4">
      <form id="formReq" novalidate>
        <input type="hidden" name="militar_id" value="{{ militar.id }}">

        <div class="row g-3">
          <div class="col-md-3">
            <label for="inpAno" class="form-label">Ano (pasta)</label>
            <input id="inpAno" name="ano" class="form-control"
                   inputmode="numeric" pattern="[0-9]{4}" maxlength="4"
                   placeholder="AAAA" value="{{ ano_default }}" required>
            <div class="form-text">Use 4 dígitos (ex.: {{ ano_default }}).</div>
          </div>

          <div class="col-md-9 d-none d-md-block"></div>

          <div class="col-md-6">
            <label class="form-label">Nome completo</label>
            <input class="form-control" value="{{ militar.nome_completo }}" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">RG</label>
            <input class="form-control" value="{{ militar.rg }}" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">CPF</label>
            <input class="form-control cpf-view" data-raw="{{ militar.cpf }}" value="{{ militar.cpf }}" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Matrícula</label>
            <input class="form-control" value="{{ militar.matricula }}" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">OBM</label>
            <input class="form-control" value="{{ obm_sigla }}" readonly>
          </div>

          <div class="col-12">
            <div class="section-title">Finalidade</div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="fim_imposto_renda" id="ir">
              <label class="form-check-label" for="ir">Dedução do dependente no Imposto de Renda</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="fim_cadastro_sistema" id="cfpp">
              <label class="form-check-label" for="cfpp">Cadastro no sistema CFPP/CBMAM</label>
            </div>
          </div>

          <div class="col-12"><div class="section-title">Dados do dependente</div></div>
          <div class="col-md-6">
            <label for="inpNomeDep" class="form-label">Nome do dependente</label>
            <input id="inpNomeDep" name="nome_dependente" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label for="inpParentesco" class="form-label">Grau de parentesco</label>
            <input id="inpParentesco" name="grau_parentesco" class="form-control"
                   placeholder="Filho(a), Cônjuge..." required>
          </div>
          <div class="col-md-2">
            <label for="inpIdade" class="form-label">Idade</label>
            <input id="inpIdade" name="idade_dependente" class="form-control"
                   inputmode="numeric" pattern="[0-9]{1,3}" maxlength="3" placeholder="Ex.: 12" required>
          </div>

          <div class="col-12 d-flex gap-2 mt-2">
            <button id="btnGerar" type="submit" class="btn btn-primary">
              <span class="btn-text">Gerar e baixar</span>
            </button>
            <a class="btn btn-outline-secondary" href="{{ url_for('dep.upload_page') }}">Ir para upload</a>
          </div>

          <div id="status" class="hint mt-2" aria-live="polite"></div>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  (function () {
    // Garante que o banner fique no topo do <body>, fora de qualquer stacking context do layout
    const stack = document.getElementById('alertStack');
    if (stack && stack.parentElement !== document.body) {
      document.body.appendChild(stack);
    }

    const form = document.getElementById("formReq");
    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btnGerar");
    const btnText = btn.querySelector('.btn-text');

    const firstEditable = form.querySelector('[required]:not([readonly])');
    if (firstEditable) firstEditable.focus();

    const fmtCPF = (v) => {
      const d = String(v || "").replace(/\D+/g, "").slice(0, 11);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.replace(/(\d{3})(\d+)/, "$1.$2");
      if (d.length <= 9) return d.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
      return d.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2}).*/, "$1.$2.$3-$4");
    };
    document.querySelectorAll('.cpf-view[data-raw]').forEach(el => {
      const raw = el.getAttribute('data-raw') || "";
      el.value = fmtCPF(raw);
    });

    const onlyDigits = (e) => e.target.value = (e.target.value || "").replace(/\D+/g, "");
    document.getElementById('inpAno')?.addEventListener('input', onlyDigits);
    document.getElementById('inpIdade')?.addEventListener('input', onlyDigits);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!form.checkValidity()) { form.reportValidity(); return; }

      const lock = (on) => { btn.disabled = !!on; btnText.textContent = on ? 'Gerando...' : 'Gerar e baixar'; };
      lock(true);
      statusEl.innerHTML = '<span class="text-muted">Gerando documento...</span>';

      try {
        const fd = new FormData(form);
        const resp = await fetch("{{ url_for('dep.gerar_docx_api') }}", {
          method: "POST",
          body: fd,
          credentials: "same-origin", // <-- importante pro Safari/Edge com sessão
        });
        if (!resp.ok) {
          const txt = await resp.text().catch(()=> "");
          throw new Error(txt || `Falha ao gerar o DOCX (HTTP ${resp.status}).`);
        }

        const token = resp.headers.get("X-DEP-TOKEN") || "";
        const protocolo = resp.headers.get("X-DEP-PROTOCOLO") || "PROTOCOLO";

        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);

        const cd = resp.headers.get("Content-Disposition") || "";
        let filename = `REQUERIMENTO_${protocolo}.docx`;
        const m = cd.match(/filename="(.+?)"/);
        if (m) filename = m[1];

        const a = document.createElement("a");
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        window.URL.revokeObjectURL(url);

        statusEl.innerHTML = '<span class="text-success">Download iniciado. Redirecionando para upload...</span>';

        setTimeout(() => {
          const q = token ? ("?t=" + encodeURIComponent(token)) : "";
          window.location.href = "{{ url_for('dep.upload_page') }}" + q;
        }, 400);

      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<div class="alert alert-danger mt-2 mb-0">Erro: ${err.message || err}</div>`;
        lock(false);
      }
    });
  })();
</script>
{% endblock %}
