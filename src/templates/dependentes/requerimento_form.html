{% extends "base.html" %}
{% block head %}
<style>
  .card-form{
    background:#fff;border-radius:16px;padding:24px;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    border:1px solid rgba(0,0,0,.06);
  }
  .section-title{font-weight:800;font-size:1.05rem;margin:18px 0 10px}
  .hint{font-size:.9rem;opacity:.8}
</style>
{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="card-form">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h4 class="mb-1">Requerimento – Inclusão de Dependente</h4>
        <div class="hint">Preencha e clique em <b>Gerar e baixar</b>. Após baixar, você será levado ao upload.</div>
      </div>
      <span class="badge bg-primary">CBMAM</span>
    </div>

    <hr class="my-3">

    <form id="formReq">
      <!-- se você tiver current_user, pode preencher hidden automaticamente -->
      <input type="hidden" name="militar_id" value="{{ militar.id }}">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Ano (pasta)</label>
            <input name="ano" class="form-control" value="{{ ano_default }}" required>
        </div>

        <div class="col-md-6"></div>

        <div class="col-md-6">
            <label class="form-label">Nome completo</label>
            <input class="form-control" value="{{ militar.nome_completo }}" readonly>
        </div>
        <div class="col-md-3">
            <label class="form-label">RG</label>
            <input class="form-control" value="{{ militar.rg }}" readonly>
        </div>
        <div class="col-md-3">
            <label class="form-label">CPF</label>
            <input class="form-control" value="{{ militar.cpf }}" readonly>
        </div>
        <div class="col-md-3">
            <label class="form-label">Matrícula</label>
            <input class="form-control" value="{{ militar.matricula }}" readonly>
        </div>
        <div class="col-md-3">
            <label class="form-label">OBM</label>
            <input class="form-control" value="{{ obm_sigla }}" readonly>
        </div>

        <div class="col-12">
          <div class="section-title">Finalidade</div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="fim_imposto_renda" id="ir">
            <label class="form-check-label" for="ir">Dedução do dependente no Imposto de Renda</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="fim_cadastro_sistema" id="cfpp">
            <label class="form-check-label" for="cfpp">Cadastro no sistema CFPP/CBMAM</label>
          </div>
        </div>

        <div class="col-12">
          <div class="section-title">Dados do dependente</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Nome do dependente</label>
          <input name="nome_dependente" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Grau de parentesco</label>
          <input name="grau_parentesco" class="form-control" placeholder="Filho(a), Cônjuge..." required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Idade</label>
          <input name="idade_dependente" class="form-control" placeholder="Ex: 12" required>
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button id="btnGerar" type="submit" class="btn btn-primary">
            Gerar e baixar
          </button>
          <a class="btn btn-outline-secondary" href="{{ url_for('dep.upload_page') }}">Ir para upload</a>
        </div>

        <div id="status" class="hint mt-2"></div>
      </div>
    </form>
  </div>
</div>

<script>
  const form = document.getElementById("formReq");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btnGerar");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "Gerando documento...";
    btn.disabled = true;

    try {
      const fd = new FormData(form);
      const resp = await fetch("{{ url_for('dep.gerar_docx_api') }}", { method: "POST", body: fd });
      if (!resp.ok) throw new Error("Falha ao gerar o DOCX.");

      const token = resp.headers.get("X-DEP-TOKEN");
      const protocolo = resp.headers.get("X-DEP-PROTOCOLO") || "PROTOCOLO";

      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);

      // tenta obter nome do arquivo
      const cd = resp.headers.get("Content-Disposition") || "";
      let filename = `REQUERIMENTO_${protocolo}.docx`;
      const match = cd.match(/filename="(.+?)"/);
      if (match) filename = match[1];

      // dispara download
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      statusEl.textContent = "Download iniciado. Redirecionando para upload...";
      // redireciona pro upload com token
      window.location.href = "{{ url_for('dep.upload_page') }}" + "?t=" + encodeURIComponent(token);

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Erro: " + (err.message || err);
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
