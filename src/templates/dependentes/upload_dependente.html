{% extends "base.html" %}

{% block head %}
<style>
  :root {
    --brand-red: #B5121B;
    --brand-red-600: #9F1119;
    --brand-blue-700: #0d2036;
    --brand-blue-600: #0c3761;
  }

  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  .page-wrap {
    padding: 18px 10px;
  }

  .glass-card {
    background: rgba(255, 255, 255, .96);
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
    overflow: hidden;
  }

  .brand-top {
    background: linear-gradient(90deg, var(--brand-blue-700) 0%, var(--brand-blue-600) 100%);
    color: #fff;
    padding: 16px 18px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
  }

  .brand-top h4 {
    margin: 0;
    font-weight: 900;
  }

  .muted {
    opacity: .85;
  }

  .hint {
    font-size: .92rem;
    opacity: .85;
  }

  /* Resumo */
  .summary-card {
    background: #fff;
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 6px 14px rgba(0, 0, 0, .06);
  }

  .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  @media (max-width: 768px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }
  }

  .k {
    font-size: .86rem;
    opacity: .7;
    margin-bottom: 2px;
  }

  .v {
    font-weight: 700;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, .08);
    background: #f8fafc;
    font-size: .9rem;
  }

  .pill.ok {
    background: #ecfdf5;
    border-color: rgba(16, 185, 129, .25);
  }

  .pill.no {
    background: #fef2f2;
    border-color: rgba(239, 68, 68, .25);
  }

  /* Dropzone */
  .dropzone {
    border: 2px dashed rgba(0, 0, 0, .2);
    border-radius: 12px;
    padding: 18px;
    background: #fff;
    transition: .15s ease-in-out;
    cursor: pointer;
  }

  .dropzone:hover,
  .dropzone.dragover {
    border-color: var(--brand-red);
    background: #fff6f6;
  }

  .file-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .file-chip {
    background: #f1f5f9;
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 999px;
    padding: 6px 10px;
    font-size: .9rem;
  }

  .btn-brand {
    background: var(--brand-red);
    border-color: var(--brand-red);
    color: #fff;
    font-weight: 700;
  }

  .btn-brand:hover {
    background: var(--brand-red-600);
    border-color: var(--brand-red-600);
  }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid page-wrap">
  <div class="glass-card">

    <div class="brand-top d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <h4>Upload â€“ InclusÃ£o de Dependentes</h4>
        <div class="muted small">
          Anexe o <b>DOCX assinado</b> e os demais anexos citados (certidÃ£o, RG/CPF, espelho IR, etc.).
        </div>
      </div>
      <span class="badge bg-primary">CBMAM</span>
    </div>

    <div class="p-3 p-md-4">

      {% if erro_token %}
      <div class="alert alert-danger">
        {{ erro_token }}
        <div class="small mt-1">Volte e gere o requerimento novamente.</div>
        <div class="mt-2">
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dep.requerimento_form') }}">Voltar</a>
        </div>
      </div>
      {% endif %}

      {% if resumo %}
      <div class="summary-card mb-3">
        <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
          <div>
            <div class="fw-bold">Resumo do Requerimento</div>
            <div class="small text-muted">Confira se este Ã© o protocolo correto antes de enviar.</div>
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCopyLink">Copiar link desta
              pÃ¡gina</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCopyProto">Copiar protocolo</button>
          </div>
        </div>

        <hr class="my-2">

        <div class="summary-grid">
          <div>
            <div class="k">Protocolo</div>
            <div class="v"><code id="protoText">{{ resumo.protocolo }}</code></div>
          </div>
          <div>
            <div class="k">Ano (pasta)</div>
            <div class="v">{{ resumo.ano }}</div>
          </div>

          <div>
            <div class="k">Finalidade</div>
            <div class="d-flex gap-2 flex-wrap">
              <span class="pill {{ 'ok' if resumo.fim_imposto_renda else 'no' }}">
                {{ 'âœ…' if resumo.fim_imposto_renda else 'â¬œ' }} Imposto de Renda
              </span>
              <span class="pill {{ 'ok' if resumo.fim_cadastro_sistema else 'no' }}">
                {{ 'âœ…' if resumo.fim_cadastro_sistema else 'â¬œ' }} CFPP/CBMAM
              </span>
            </div>
          </div>

          <div>
            <div class="k">Dependentes ({{ resumo.dependentes|length }})</div>
            <div class="small">
              {% if resumo.dependentes and resumo.dependentes|length > 0 %}
              <ul class="mb-0">
                {% for d in resumo.dependentes %}
                <li>
                  <b>{{ d.nome }}</b>
                  â€” {{ d.grau_parentesco }}
                  â€” {{ d.idade }}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <span class="text-muted">Nenhum dependente no token.</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0">
          Dica: se vocÃª precisar assinar fora do sistema, <b>salve este link</b> (ou copie) e volte aqui depois para
          enviar.
        </div>
      </div>
      {% endif %}

      <form id="formUpload" method="POST" action="{{ url_for('dep.upload_post') }}" enctype="multipart/form-data"
        novalidate>

        <input type="hidden" name="token" value="{{ token }}">

        <label class="form-label fw-semibold" for="arquivos">Arquivos</label>
        <div id="drop" class="dropzone mb-2" aria-describedby="hintMulti">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span>ðŸ“Ž</span>
            <div>
              <div class="fw-semibold">Clique para escolher ou arraste e solte aqui</div>
              <div id="hintMulti" class="small text-muted">VocÃª pode selecionar vÃ¡rios arquivos (PDF assinado +
                anexos).</div>
            </div>
          </div>
          <input id="arquivos" class="form-control d-none" type="file" name="arquivos" multiple>
        </div>

        <div class="d-flex gap-2 flex-wrap mb-2">
          <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddMore">
            + Adicionar mais arquivos
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearFiles">
            Limpar arquivos
          </button>
        </div>

        <div id="fileList" class="file-list"></div>

        <div class="d-flex gap-2 flex-wrap mt-3">
          <button id="btnEnviar" class="btn btn-brand" type="submit">Enviar</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('dep.requerimento_form') }}">Voltar</a>
        </div>

        <div id="status" class="hint mt-2" aria-live="polite"></div>
      </form>
    </div>

  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('formUpload');
    const input = document.getElementById('arquivos');
    const drop = document.getElementById('drop');
    const list = document.getElementById('fileList');
    const btn = document.getElementById('btnEnviar');
    const statusEl = document.getElementById('status');

    const tokenInput = form.querySelector('input[name="token"]');

    // Copiar link e protocolo (se existir resumo)
    const btnCopyLink = document.getElementById('btnCopyLink');
    const btnCopyProto = document.getElementById('btnCopyProto');
    const protoText = document.getElementById('protoText');

    const pageUrl = window.location.href;

    btnCopyLink?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(pageUrl);
        btnCopyLink.textContent = "Link copiado!";
        setTimeout(() => btnCopyLink.textContent = "Copiar link desta pÃ¡gina", 1400);
      } catch (e) {
        prompt("Copie o link:", pageUrl);
      }
    });

    btnCopyProto?.addEventListener('click', async () => {
      const proto = protoText?.textContent || "";
      if (!proto) return;
      try {
        await navigator.clipboard.writeText(proto);
        btnCopyProto.textContent = "Protocolo copiado!";
        setTimeout(() => btnCopyProto.textContent = "Copiar protocolo", 1400);
      } catch (e) {
        prompt("Copie o protocolo:", proto);
      }
    });

    // âœ… Recupera token do localStorage se o usuÃ¡rio abriu sem ?t=
    const LAST_UPLOAD_KEY = "dep_last_upload_v1";
    function recoverTokenIfMissing() {
      let t = (tokenInput?.value || "").trim();
      if (t) return true;

      try {
        const raw = localStorage.getItem(LAST_UPLOAD_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          if (data?.token) {
            tokenInput.value = String(data.token).trim();
            t = tokenInput.value;

            statusEl.innerHTML = `
              <div class="alert alert-info mt-2 mb-0">
                Recuperamos seu token automaticamente.
                ${data.protocolo ? `<div class="small mt-1">Protocolo: <code>${data.protocolo}</code></div>` : ""}
              </div>
            `;
          }
        }
      } catch (e) { }

      if (!t) {
        statusEl.innerHTML = `
          <div class="alert alert-warning mt-2 mb-0">
            Token nÃ£o encontrado. Volte ao formulÃ¡rio e gere o requerimento novamente (ou abra o link do upload).
          </div>
        `;
        return false;
      }
      return true;
    }

    recoverTokenIfMissing();

    // ===============================
    // âœ… ACUMULAR ARQUIVOS (DataTransfer)
    // ===============================
    let dt = new DataTransfer();

    const btnAddMore = document.getElementById('btnAddMore');
    const btnClearFiles = document.getElementById('btnClearFiles');

    // Abre seletor ao clicar na Ã¡rea OU no botÃ£o "Adicionar mais"
    drop.addEventListener('click', () => input.click());
    btnAddMore?.addEventListener('click', () => input.click());

    // Quando selecionar arquivos pelo input -> ACUMULA
    input.addEventListener('change', () => {
      addFiles(input.files);
    });

    // Drag & Drop com acumulo
    ['dragenter', 'dragover'].forEach(evt =>
      drop.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        drop.classList.add('dragover');
      })
    );
    ['dragleave', 'drop'].forEach(evt =>
      drop.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        drop.classList.remove('dragover');
      })
    );

    drop.addEventListener('drop', e => {
      if (e.dataTransfer?.files?.length) {
        addFiles(e.dataTransfer.files);
      }
    });

    // Limpar seleÃ§Ã£o
    btnClearFiles?.addEventListener('click', () => {
      dt = new DataTransfer();
      input.files = dt.files;
      renderList();
      statusEl.textContent = 'Arquivos limpos.';
    });

    // Adiciona arquivos, evitando duplicados (mesmo nome + tamanho)
    function addFiles(fileList) {
      const incoming = Array.from(fileList || []);
      const existing = Array.from(dt.files || []);

      for (const f of incoming) {
        const dup = existing.some(x => x.name === f.name && x.size === f.size);
        if (!dup) dt.items.add(f);
      }

      input.files = dt.files;
      renderList();
    }

    // Renderiza lista com opÃ§Ã£o de remover item
    function renderList() {
      list.innerHTML = '';
      const files = Array.from(dt.files || []);

      files.forEach((f, idx) => {
        const chip = document.createElement('span');
        chip.className = 'file-chip';
        chip.innerHTML = `
          ${escapeHtml(f.name)}
          <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-rm="${idx}" style="text-decoration:none;">
            âœ–
          </button>
        `;
        list.appendChild(chip);
      });

      // remover individual
      list.querySelectorAll('button[data-rm]').forEach(btnRm => {
        btnRm.addEventListener('click', () => {
          const i = parseInt(btnRm.getAttribute('data-rm'), 10);
          removeAt(i);
        });
      });

      statusEl.textContent = files.length ? `${files.length} arquivo(s) selecionado(s).` : '';
    }

    function removeAt(index) {
      const files = Array.from(dt.files || []);
      dt = new DataTransfer();
      files.forEach((f, i) => { if (i !== index) dt.items.add(f); });
      input.files = dt.files;
      renderList();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ValidaÃ§Ã£o e anti-duplo envio
    form.addEventListener('submit', (e) => {
      // garante token antes de enviar
      if (!recoverTokenIfMissing()) {
        e.preventDefault();
        try { localStorage.removeItem("dep_last_upload_v1"); } catch (e) { }
        alert("Token nÃ£o encontrado. Volte ao formulÃ¡rio e gere o requerimento novamente.");
        return;
      }

      // âœ… GARANTE que o input estÃ¡ com os arquivos do DataTransfer
      try { input.files = dt.files; } catch (_) { }

      // âœ… valida pelo INPUT (Ã© o que vai pro backend)
      const hasFiles = input.files && input.files.length > 0;
      if (!hasFiles) {
        e.preventDefault();
        alert('Selecione ao menos um arquivo (DOCX/PDF assinado + anexos).');
        return;
      }

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'Enviando...';
      statusEl.textContent = 'Enviando arquivos...';

      setTimeout(() => {
        try { btn.disabled = false; btn.textContent = original; } catch (_) { }
      }, 12000);
    });
  })();
</script>

{% endblock %}