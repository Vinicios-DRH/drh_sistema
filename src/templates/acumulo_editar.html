{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    :root {
        --brand-red: #B5121B;
        --brand-red-600: #9f1119;
        --ink-100: #f6f8fb;
        --ink-200: #e8eef6;
        --ink-300: #cfe4ff;
        --ink-400: #c0cfda;
        --glass-bg: rgba(255, 255, 255, .06);
        --glass-brd: rgba(255, 255, 255, .18);
    }
    body { background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed; }
    .btn-primary { background: var(--brand-red); border-color: var(--brand-red); }
    .btn-primary:hover { background: var(--brand-red-600); border-color: var(--brand-red-600); }
    .btn-outline-primary { color: var(--brand-red); border-color: var(--brand-red); }
    .btn-outline-primary:hover { color: #fff; background: var(--brand-red); }
    .brand-header {
        background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
        color: var(--ink-200); box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .glass-card {
        background: var(--glass-bg); color: var(--ink-200);
        border: 1px solid var(--glass-brd); border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,.35);
        backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .card-soft { background: rgba(255,255,255,.08); border: 1px solid var(--glass-brd); border-radius: 16px; }
    .section-title { font-weight: 600; font-size: 1rem; margin: 0; color: var(--ink-200) }
    .muted { color: var(--ink-300) }
    .form-label { color: var(--ink-300); font-weight: 600 }
    .form-control, .form-select, textarea {
        background: rgba(255,255,255,.06)!important; color: var(--ink-200)!important; border: 1px solid var(--glass-brd)!important;
    }
    .form-control::placeholder { color: var(--ink-400); opacity: .75 }
    .form-select option, .form-select optgroup { background: #fff!important; color: #111!important; }
    .form-select option:hover, .form-select option:checked { background: #eef2f7!important; color: #111!important; }
    .form-select option[disabled] { color: #94a3b8!important; }
    .vinculo-card { border: 1px dashed var(--glass-brd); border-radius: 12px; padding: 1rem; background: rgba(255,255,255,.04) }
    .vinculo-card .remove-btn { border-color: #e11d48; color: #e11d48 }
    .vinculo-card .remove-btn:hover { background: #e11d48; color: #fff }
    .action-bar {
        position: sticky; bottom: 8px; z-index: 4; background: rgba(181,18,27,.12);
        border: 1px solid var(--glass-brd); border-radius: 14px; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        padding: .65rem; display: flex; gap: .5rem; justify-content: flex-end; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
    <div class="container-xxl">

        <!-- Cabeçalho -->
        <div class="brand-header p-3 p-md-4 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded" alt="CBMAM">
                    <div>
                        <h1 class="h5 mb-1">Editar Declaração — {{ militar.nome_guerra or militar.nome_completo }}</h1>
                        <div class="small opacity-75">
                            Ano {{ ano }} · Status:
                            {% set st = (decl.status or '')|lower %}
                            <span class="badge {% if st=='validado' %}text-bg-success{% elif st=='inconforme' %}text-bg-danger{% elif st=='pendente' %}text-bg-warning text-dark{% else %}text-bg-secondary{% endif %}">
                                {{ decl.status }}
                            </span>
                        </div>
                    </div>
                </div>
                <a href="{{ url_for('home_atualizacao') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>

        {% if url_arquivo_modelo or url_arquivo_orgao %}
        <div class="glass-card p-3 p-md-4 mb-3">
            <div class="section-title mb-2">Arquivos já enviados</div>
            <ul class="m-0">
                {% if url_arquivo_modelo %}
                <li><a class="btn btn-link p-0" href="{{ url_arquivo_modelo }}" target="_blank">Modelo assinado do militar</a></li>
                {% endif %}
                {% if url_arquivo_orgao %}
                <li><a class="btn btn-link p-0" href="{{ url_arquivo_orgao }}" target="_blank">Declaração do órgão público</a></li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        <!-- FORM -->
        <form id="form-editar" class="needs-validation" novalidate>
            <input type="hidden" name="ano" value="{{ ano }}">
            <input type="hidden" name="militar_id" value="{{ militar.id }}">

            <!-- Identificação -->
            <div class="glass-card p-3 p-md-4 mb-3">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Militar</label>
                        <input class="form-control" value="{{ militar.nome_completo }}" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Posto/Graduação</label>
                        <input class="form-control" value="{{ posto_grad_sigla or '-' }}" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">OBM</label>
                        <input class="form-control" value="{{ obm_sigla or '-' }}" readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Ano</label>
                        <input class="form-control" value="{{ ano }}" readonly>
                    </div>
                </div>
            </div>

            <!-- Declaração -->
            <div class="glass-card p-3 p-md-4 mb-3">
                <h2 class="section-title mb-3">Declaração</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Tipo de declaração</label>
                        <select class="form-select" id="tipo-select" name="tipo" required>
                            <option value="" disabled {% if not decl.tipo %}selected{% endif %}>Selecione…</option>
                            <option value="positiva" {{ 'selected' if decl.tipo=='positiva' else '' }}>Com vínculo</option>
                            <option value="negativa" {{ 'selected' if decl.tipo=='negativa' else '' }}>Sem vínculo</option>
                        </select>
                        <div class="invalid-feedback">Escolha o tipo de declaração.</div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Meio de entrega</label>
                        <select class="form-select" name="meio_entrega" disabled>
                            <option value="digital" selected>Digital</option>
                            <option value="presencial">Presencial</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" rows="2" placeholder="(opcional)">{{ decl.observacoes or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Vínculos (somente órgão público) -->
            <div class="glass-card p-3 p-md-4 mb-3">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h2 class="section-title">Vínculos em órgão público</h2>
                    <div class="small muted">A natureza é sempre <strong>efetivo</strong>.</div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-vinculo">
                        <i class="bi bi-plus-lg me-1"></i>Adicionar
                    </button>
                </div>

                <div id="vinculos-container" class="d-grid gap-3">
                    {% for v in decl.vinculos %}
                    <div class="vinculo-card">
                        <div class="row g-3">
                            <input type="hidden" name="natureza_vinculo[]" value="efetivo">
                            <div class="col-md-6">
                                <label class="form-label">Órgão/Empregador</label>
                                <input class="form-control" name="empregador_nome[]" value="{{ v.empregador_nome }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Esfera do órgão</label>
                                <select class="form-select" name="empregador_tipo[]">
                                    {% set esf = (v.empregador_tipo or '')|lower %}
                                    <option value="" disabled {% if esf not in ['municipal','estadual','federal'] %}selected{% endif %}>Selecione…</option>
                                    <option value="municipal" {{ 'selected' if esf=='municipal' else '' }}>Municipal</option>
                                    <option value="estadual"  {{ 'selected' if esf=='estadual'  else '' }}>Estadual</option>
                                    <option value="federal"   {{ 'selected' if esf=='federal'   else '' }}>Federal</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Está de LTIP?</label>
                                <select class="form-select" name="licenca[]" required>
                                    <option value="" selected disabled>Selecione…</option>
                                    <option value="sim" {{ 'selected' if (v.licenca or '').lower()=='sim' else '' }}>Sim</option>
                                    <option value="nao" {{ 'selected' if (v.licenca or '').lower() in ['não','não'] else '' }}>Não</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">CNPJ/CPF</label>
                                <input class="form-control" name="empregador_doc[]" value="{{ v.empregador_doc }}"
                                       inputmode="numeric" autocomplete="off" maxlength="18" placeholder="somente dígitos">
                                <div class="invalid-feedback">Informe 11 (CPF) ou 14 (CNPJ) dígitos.</div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Jornada de trabalho</label>
                                <select class="form-select" name="jornada_trabalho[]">
                                    <option value="" disabled {{ '' if v.jornada_trabalho else 'selected' }}>Selecione…</option>
                                    <option value="escala"     {{ 'selected' if v.jornada_trabalho=='escala'     else '' }}>Escala</option>
                                    <option value="expediente" {{ 'selected' if v.jornada_trabalho=='expediente' else '' }}>Expediente</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Cargo/Função</label>
                                <input class="form-control" name="cargo_funcao[]" value="{{ v.cargo_funcao }}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Carga horária semanal (h)</label>
                                <input type="number" class="form-control" name="carga_horaria_semanal[]" min="1" max="80"
                                       value="{{ v.carga_horaria_semanal }}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Horário início</label>
                                <input type="time" class="form-control" name="horario_inicio[]"
                                       value="{{ v.horario_inicio.strftime('%H:%M') if v.horario_inicio else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Horário fim</label>
                                <input type="time" class="form-control" name="horario_fim[]"
                                       value="{{ v.horario_fim.strftime('%H:%M') if v.horario_fim else '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data de início</label>
                                <input type="date" class="form-control" name="data_inicio[]"
                                       value="{{ v.data_inicio.strftime('%Y-%m-%d') if v.data_inicio else '' }}">
                            </div>

                            <div class="col-md-3 d-flex align-items-end justify-content-end">
                                <button type="button" class="btn btn-outline-danger remove-btn">Remover</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- template p/ novos vínculos -->
                <template id="tpl-vinculo">
                    <div class="vinculo-card">
                        <div class="row g-3">
                            <input type="hidden" name="natureza_vinculo[]" value="efetivo">
                            <div class="col-md-6">
                                <label class="form-label">Órgão/Empregador</label>
                                <input class="form-control" name="empregador_nome[]">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Esfera do órgão</label>
                                <select class="form-select" name="empregador_tipo[]">
                                    <option value="" selected disabled>Selecione…</option>
                                    <option value="municipal">Municipal</option>
                                    <option value="estadual">Estadual</option>
                                    <option value="federal">Federal</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CNPJ/CPF</label>
                                <input class="form-control" name="empregador_doc[]" inputmode="numeric" autocomplete="off" maxlength="18" placeholder="somente dígitos">
                                <div class="invalid-feedback">Informe 14 dígitos.</div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Jornada de trabalho</label>
                                <select class="form-select" name="jornada_trabalho[]">
                                    <option value="" selected disabled>Selecione…</option>
                                    <option value="escala">Escala</option>
                                    <option value="expediente">Expediente</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Está de licença?</label>
                                <select class="form-select" name="licenca[]" required>
                                    <option value="" selected disabled>Selecione…</option>
                                    <option value="sim">Sim</option>
                                    <option value="não">Não</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Cargo/Função</label>
                                <input class="form-control" name="cargo_funcao[]">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Carga horária semanal (h)</label>
                                <input type="number" class="form-control" name="carga_horaria_semanal[]" min="1" max="80">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Horário início</label>
                                <input type="time" class="form-control" name="horario_inicio[]">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Horário fim</label>
                                <input type="time" class="form-control" name="horario_fim[]">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data de início</label>
                                <input type="date" class="form-control" name="data_inicio[]">
                            </div>
                            <div class="col-md-3 d-flex align-items-end justify-content-end">
                                <button type="button" class="btn btn-outline-danger remove-btn">Remover</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Ações -->
            <div class="action-bar">
                <a href="{{ url_for('acumulo.lista', ano=ano) }}" class="btn btn-outline-light">Cancelar</a>
                <button type="button" class="btn btn-outline-primary" id="btn-salvar-rascunho">
                    <i class="bi bi-cloud-check me-1"></i> Salvar rascunho
                </button>
                <button type="button" class="btn btn-primary" id="btn-gerar-modelo">
                    <i class="bi bi-filetype-docx me-1"></i> Gerar modelo preenchido (DOCX)
                </button>
            </div>
        </form>
    </div>
</section>

<script>
  const tipoSelect = document.getElementById('tipo-select');
  const container  = document.getElementById('vinculos-container');
  const addBtn     = document.getElementById('add-vinculo');
  const tpl        = document.getElementById('tpl-vinculo');
  const form       = document.getElementById('form-editar');
  const btnModelo  = document.getElementById('btn-gerar-modelo');
  const btnDraft   = document.getElementById('btn-salvar-rascunho');

  // Helpers
  const digitsOnly = v => (v || '').replace(/\D+/g, '');
  const isCpfCnpjValid = v => {
    const d = digitsOnly(v);
    return d.length === 11 || d.length === 14;
  };
  function setFieldError(el, msg) { el?.setCustomValidity(msg || ''); el?.classList.add('is-invalid'); el?.reportValidity?.(); }
  function clearFieldError(el) { el?.setCustomValidity(''); el?.classList.remove('is-invalid'); }

  // Live validation do doc
  function bindLiveDocValidation(root) {
    root.querySelectorAll('input[name="empregador_doc[]"]').forEach(inp => {
      inp.addEventListener('input', () => {
        const cur = inp.value, cleaned = digitsOnly(cur);
        if (cur !== cleaned) inp.value = cleaned;
        if (!cleaned.length) { clearFieldError(inp); return; }
        isCpfCnpjValid(cleaned) ? clearFieldError(inp) : setFieldError(inp, 'Informe 11 (CPF) ou 14 (CNPJ) dígitos.');
      });
      inp.addEventListener('blur', () => {
        const d = digitsOnly(inp.value);
        (!d || isCpfCnpjValid(d)) ? clearFieldError(inp) : setFieldError(inp, 'Informe 11 (CPF) ou 14 (CNPJ) dígitos.');
      });
    });
  }
  bindLiveDocValidation(document);

  // Liga/desliga jornada/carga/horários por cartão conforme licença
  function setWorkFieldsEnabledInCard(card, enabled) {
    const names = ['jornada_trabalho[]','carga_horaria_semanal[]','horario_inicio[]','horario_fim[]'];
    for (const n of names) {
      const el = card.querySelector(`[name="${n}"]`);
      if (!el) continue;
      el.disabled = !enabled;
      el.required = enabled;
      if (!enabled) {
        el.value = '';
        clearFieldError(el);
      }
    }
  }
  function toggleCardByLicenca(card) {
    const sel = card.querySelector('[name="licenca[]"]');
    const val = (sel?.value || '').toLowerCase();
    const isSim = (val === 'sim');
    setWorkFieldsEnabledInCard(card, !isSim);
  }

  // Habilita/Desabilita bloco de vínculos conforme tipo
  function toggleVinculos() {
    const isPositiva = tipoSelect.value === 'positiva';
    addBtn.disabled = !isPositiva;
    container.style.opacity = isPositiva ? 1 : .65;
    container.style.display = isPositiva ? '' : 'none';

    container.querySelectorAll('.vinculo-card').forEach(card => {
      card.querySelectorAll('input,select,button.remove-btn').forEach(el => {
        if (el.classList.contains('remove-btn')) el.disabled = !isPositiva;
        else el.disabled = !isPositiva;
      });

      // Required base quando positiva (sempre)
      ['empregador_nome[]','empregador_tipo[]','empregador_doc[]','licenca[]','cargo_funcao[]','data_inicio[]']
        .forEach(n => {
          const el = card.querySelector(`[name="${n}"]`);
          if (el) el.required = isPositiva;
        });

      if (isPositiva) {
        // Ajusta conforme licença do cartão
        toggleCardByLicenca(card);
      } else {
        setWorkFieldsEnabledInCard(card, false);
      }
    });
  }

  // Cria novo cartão + binds
  function addVinculo() {
    const node = tpl.content.cloneNode(true);
    const card = node.querySelector('.vinculo-card');

    node.querySelector('.remove-btn').addEventListener('click', e => {
      e.target.closest('.vinculo-card').remove();
    });

    container.appendChild(node);
    bindLiveDocValidation(container.lastElementChild);

    // licença por cartão
    const sel = card.querySelector('[name="licenca[]"]');
    sel?.addEventListener('change', () => toggleCardByLicenca(card));
    toggleCardByLicenca(card);

    toggleVinculos();
  }

  addBtn.addEventListener('click', addVinculo);
  tipoSelect.addEventListener('change', () => {
    if (tipoSelect.value === 'positiva' && container.children.length === 0) {
      addVinculo();
    }
    toggleVinculos();
  });

  // remover existentes
  container.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', e => e.target.closest('.vinculo-card').remove());
  });

  // Binds de licença nos cartões existentes (server-side)
  container.querySelectorAll('.vinculo-card').forEach(card => {
    const sel = card.querySelector('[name="licenca[]"]');
    sel?.addEventListener('change', () => toggleCardByLicenca(card));
    toggleCardByLicenca(card);
  });

  // Coleta o primeiro vínculo preenchido
  function firstFilledVinculo() {
    const cards = [...container.querySelectorAll('.vinculo-card')];
    for (const card of cards) {
      const get = n => card.querySelector(`[name="${n}[]"]`)?.value?.trim() || '';
      const nome = get('empregador_nome');
      if (nome) {
        let lic = get('licenca').toLowerCase();
        if (lic === 'não') lic = 'nao'; // normaliza se vier com acento
        return {
          empregador_nome: nome,
          empregador_tipo: get('empregador_tipo'),
          empregador_doc:  get('empregador_doc'),
          licenca: lic,
          natureza_vinculo:'efetivo',
          jornada_trabalho:get('jornada_trabalho'),
          cargo_funcao:    get('cargo_funcao'),
          carga_horaria_semanal: get('carga_horaria_semanal'),
          horario_inicio:  get('horario_inicio'),
          horario_fim:     get('horario_fim'),
          data_inicio:     get('data_inicio'),
        };
      }
    }
    return null;
  }

  // Validação mínima (condicional pela licença)
  function valida() {
    const tipo = tipoSelect.value;
    if (!tipo) return false;
    if (tipo === 'positiva') {
      const v = firstFilledVinculo();
      if (!v) return false;

      const esfera = (v.empregador_tipo || '').toLowerCase();
      if (!['municipal','estadual','federal'].includes(esfera)) return false;
      if (!isCpfCnpjValid(digitsOnly(v.empregador_doc))) return false;

      const baseReq = ['empregador_nome','empregador_tipo','empregador_doc','licenca','cargo_funcao','data_inicio'];
      if (!baseReq.every(k => v[k])) return false;

      const licIsSim = (v.licenca || '').toLowerCase() === 'sim';
      if (!licIsSim) {
        const workReq = ['jornada_trabalho','carga_horaria_semanal','horario_inicio','horario_fim'];
        if (!workReq.every(k => v[k])) return false;
      }
    }
    return true;
  }

  // === Salvar rascunho ===
  async function salvarRascunho() {
    const militarId = form.querySelector('[name="militar_id"]').value;
    const ano = form.querySelector('[name="ano"]').value;

    const vincs = [];
    [...container.querySelectorAll('.vinculo-card')].forEach(card => {
      const get = n => card.querySelector(`[name="${n}[]"]`)?.value?.trim() || '';
      const nome = get('empregador_nome');
      if (!nome) return;
      let lic = (get('licenca') || '').toLowerCase();
      if (lic === 'não') lic = 'nao';
      vincs.push({
        empregador_nome: nome,
        empregador_tipo: (get('empregador_tipo') || '').toLowerCase(),
        empregador_doc:  get('empregador_doc'),
        licenca: lic,
        natureza_vinculo:'efetivo',
        jornada_trabalho:(get('jornada_trabalho') || '').toLowerCase(),
        cargo_funcao:    get('cargo_funcao'),
        carga_horaria_semanal: get('carga_horaria_semanal'),
        horario_inicio:  get('horario_inicio'),
        horario_fim:     get('horario_fim'),
        data_inicio:     get('data_inicio'),
      });
    });

    const payload = {
      ano: Number(ano),
      tipo: (tipoSelect.value || '').toLowerCase(),
      observacoes: form.querySelector('[name="observacoes"]')?.value || '',
      vinculos: vincs
    };

    const resp = await fetch('{{ url_for("acumulo.salvar_rascunho", militar_id=0) }}'.replace('/0','/'+militarId), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=>({ok:false}));
    if (!resp.ok || !data.ok) throw new Error(data.error || 'Falha ao salvar rascunho.');
  }

  btnDraft.addEventListener('click', async () => {
    btnDraft.disabled = true;
    btnDraft.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Salvando…';
    try {
      await salvarRascunho();
      btnDraft.innerHTML = '<i class="bi bi-check2-circle me-1"></i> Rascunho salvo!';
      setTimeout(()=>{ btnDraft.innerHTML = '<i class="bi bi-cloud-check me-1"></i> Salvar rascunho'; btnDraft.disabled = false; }, 1200);
    } catch(e) {
      alert(e.message || 'Erro ao salvar rascunho.');
      btnDraft.innerHTML = '<i class="bi bi-cloud-check me-1"></i> Salvar rascunho';
      btnDraft.disabled = false;
    }
  });

  // === Geração do modelo ===
  btnModelo.addEventListener('click', async () => {
    if (!valida()) { form.classList.add('was-validated'); return; }

    const fd = new FormData();
    fd.set('ano', form.querySelector('[name="ano"]').value);
    fd.set('militar_id', form.querySelector('[name="militar_id"]').value);
    fd.set('tipo', tipoSelect.value);
    fd.set('observacoes', form.querySelector('[name="observacoes"]')?.value || '');

    if (tipoSelect.value === 'positiva') {
      const v = firstFilledVinculo();
      fd.set('empregador_nome', v.empregador_nome);
      fd.set('empregador_tipo', v.empregador_tipo);
      fd.set('empregador_doc', digitsOnly(v.empregador_doc));
      fd.set('licenca', (v.licenca || '').toLowerCase());
      fd.set('natureza_vinculo', 'efetivo');
      fd.set('jornada_trabalho', (v.jornada_trabalho || '').toLowerCase());
      fd.set('cargo_funcao', v.cargo_funcao);
      fd.set('carga_horaria_semanal', v.carga_horaria_semanal);
      fd.set('horario_inicio', v.horario_inicio);
      fd.set('horario_fim', v.horario_fim);
      fd.set('data_inicio', v.data_inicio);
    }

    try {
      const prep = await fetch('{{ url_for("acumulo.prepara_geracao") }}', { method: 'POST', body: fd });
      const data = await prep.json();
      if (!prep.ok || !data.ok) throw new Error(data.error || 'Falha ao preparar geração');

      const militarId = fd.get('militar_id');
      const p = new URLSearchParams({ ano: fd.get('ano') || '', tipo: fd.get('tipo') || '' });

      if (fd.get('tipo') === 'positiva') {
        p.set('empregador_nome', fd.get('empregador_nome') || '');
        p.set('empregador_doc', digitsOnly(fd.get('empregador_doc') || ''));
        p.set('licenca', (fd.get('licenca') || '').toLowerCase());
        p.set('natureza_vinculo', 'efetivo');
        p.set('jornada_trabalho', (fd.get('jornada_trabalho') || '').toLowerCase());
        p.set('cargo_funcao', fd.get('cargo_funcao') || '');
        p.set('carga_horaria_semanal', fd.get('carga_horaria_semanal') || '');
        p.set('horario_inicio', fd.get('horario_inicio') || '');
        p.set('horario_fim', fd.get('horario_fim') || '');
        p.set('data_inicio', fd.get('data_inicio') || '');
        p.set('empregador_tipo', (fd.get('empregador_tipo') || '').toLowerCase());
      }

      const urlUpload = '{{ url_for("acumulo.upload_assinado", militar_id=0) }}'
        .replace('/0', `/${militarId}`) + '?ano=' + encodeURIComponent(fd.get('ano'));
      p.set('return_to', urlUpload);

      const urlIntermediaria = '{{ url_for("acumulo.modelo_docx_page", militar_id=0) }}'
        .replace('/0', `/${militarId}`) + '?' + p.toString();

      const popup = window.open(urlIntermediaria, '_blank');
      if (!popup) { window.location.href = urlIntermediaria; return; }
      setTimeout(() => { window.location.href = urlUpload; }, 500);
    } catch (e) {
      alert('Erro: ' + e.message);
    }
  });

  // estado inicial
  toggleVinculos();
</script>

{% endblock %}
