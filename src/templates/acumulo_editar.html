{% extends "base.html" %}
{% block body %}

<div class="container-xxl py-3 mt-5">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h4 mb-1">Editar Declaração — {{ militar.nome_guerra or militar.nome_completo }}</h1>
            <div class="text-muted">
                Ano {{ ano }} · Status atual: <span class="badge bg-secondary">{{ decl.status }}</span>
            </div>
        </div>
        <a href="{{ url_for('home_atualizacao') }}" class="btn btn-light">← Voltar</a>
    </div>

    <!-- IMPORTANTE: este form NÃO posta para a rota; o fluxo é todo via JS -->
    <form id="form-editar" class="needs-validation" novalidate>
        <input type="hidden" name="ano" value="{{ ano }}">
        <input type="hidden" name="militar_id" value="{{ militar.id }}">

        <div class="card p-3 mb-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Militar</label>
                    <input class="form-control" value="{{ militar.nome_completo }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Posto/Graduação</label>
                    <input class="form-control" value="{{ posto_grad_sigla or '-' }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">OBM</label>
                    <input class="form-control" value="{{ obm_sigla or '-' }}" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ano</label>
                    <input class="form-control" value="{{ ano }}" readonly>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Tipo de declaração</label>
                    <select class="form-select" id="tipo-select" name="tipo" required>
                        <option value="" disabled>Selecione…</option>
                        <option value="positiva" {{ 'selected' if decl.tipo=='positiva' else '' }}>Positiva (com
                            vínculo)</option>
                        <option value="negativa" {{ 'selected' if decl.tipo=='negativa' else '' }}>Negativa (sem
                            vínculo)</option>
                    </select>
                    <div class="invalid-feedback">Escolha o tipo de declaração.</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Meio de entrega</label>
                    <select class="form-select" name="meio_entrega" disabled>
                        <option value="digital" selected>Digital</option>
                        <option value="presencial">Presencial</option>
                    </select>
                </div>

                <div class="col-12">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" name="observacoes" rows="2"
                        placeholder="(opcional)">{{ decl.observacoes or '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="h6 m-0">Vínculos externos</h2>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-vinculo">+ Adicionar
                    vínculo</button>
            </div>

            <div id="vinculos-container" class="d-grid gap-3">
                {% for v in decl.vinculos %}
                <div class="border rounded p-3 vinculo-card">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Empregador</label>
                            <input class="form-control" name="empregador_nome[]" value="{{ v.empregador_nome }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" name="empregador_tipo[]">
                                {% for opt in ['publico','privado','cooperativa','profissional liberal'] %}
                                <option value="{{ opt }}" {{ 'selected' if v.empregador_tipo==opt else '' }}>{{
                                    opt|capitalize }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">CNPJ/CPF</label>
                            <input class="form-control" name="empregador_doc[]" value="{{ v.empregador_doc }}">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Natureza</label>
                            <select class="form-select" name="natureza_vinculo[]">
                                {% for opt in ['efetivo','contratado','prestacao_servicos','profissional liberal'] %}
                                <option value="{{ opt }}" {{ 'selected' if v.natureza_vinculo==opt else '' }}>{{
                                    opt.replace('_',' ')|capitalize }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Cargo/Função</label>
                            <input class="form-control" name="cargo_funcao[]" value="{{ v.cargo_funcao }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Carga horária semanal (h)</label>
                            <input type="number" class="form-control" name="carga_horaria_semanal[]" min="1" max="80"
                                value="{{ v.carga_horaria_semanal }}">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Horário início</label>
                            <input type="time" class="form-control" name="horario_inicio[]"
                                value="{{ v.horario_inicio.strftime('%H:%M') if v.horario_inicio else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Horário fim</label>
                            <input type="time" class="form-control" name="horario_fim[]"
                                value="{{ v.horario_fim.strftime('%H:%M') if v.horario_fim else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data de início</label>
                            <input type="date" class="form-control" name="data_inicio[]"
                                value="{{ v.data_inicio.strftime('%Y-%m-%d') if v.data_inicio else '' }}">
                        </div>

                        <div class="col-md-3 d-flex align-items-end justify-content-end">
                            <button type="button" class="btn btn-outline-danger remove-btn">Remover</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- template para novos vínculos -->
            <template id="tpl-vinculo">
                <div class="border rounded p-3 vinculo-card">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Empregador</label>
                            <input class="form-control" name="empregador_nome[]">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" name="empregador_tipo[]">
                                <option value="publico">Público</option>
                                <option value="privado">Privado</option>
                                <option value="cooperativa">Cooperativa</option>
                                <option value="autonomo">Autônomo</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">CNPJ/CPF</label>
                            <input class="form-control" name="empregador_doc[]">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Natureza</label>
                            <select class="form-select" name="natureza_vinculo[]">
                                <option value="efetivo">Efetivo</option>
                                <option value="contratado">Contratado</option>
                                <option value="prestacao_servicos">Prestação de serviços</option>
                                <option value="autonomo">Autônomo</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Cargo/Função</label>
                            <input class="form-control" name="cargo_funcao[]">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Carga horária semanal (h)</label>
                            <input type="number" class="form-control" name="carga_horaria_semanal[]" min="1" max="80">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Horário início</label>
                            <input type="time" class="form-control" name="horario_inicio[]">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Horário fim</label>
                            <input type="time" class="form-control" name="horario_fim[]">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data de início</label>
                            <input type="date" class="form-control" name="data_inicio[]">
                        </div>
                        <div class="col-md-3 d-flex align-items-end justify-content-end">
                            <button type="button" class="btn btn-outline-danger remove-btn">Remover</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div class="d-flex gap-2">
            <a href="{{ url_for('acumulo.lista', ano=ano) }}" class="btn btn-light">Cancelar</a>
            <button type="button" class="btn btn-outline-secondary" id="btn-gerar-modelo">Gerar modelo preenchido
                (DOCX)</button>
        </div>
    </form>
</div>

<script>
    const tipoSelect = document.getElementById('tipo-select');
    const container = document.getElementById('vinculos-container');
    const addBtn = document.getElementById('add-vinculo');
    const tpl = document.getElementById('tpl-vinculo');
    const form = document.getElementById('form-editar');
    const btnModelo = document.getElementById('btn-gerar-modelo');

    function toggleVinculos() {
        const isPositiva = tipoSelect.value === 'positiva';
        addBtn.disabled = !isPositiva;
        container.querySelectorAll('input, select, button.remove-btn').forEach(el => {
            if (el.classList.contains('remove-btn')) el.disabled = !isPositiva;
            else { el.required = isPositiva; el.disabled = !isPositiva; }
        });
    }
    function addVinculo() {
        const node = tpl.content.cloneNode(true);
        node.querySelector('.remove-btn').addEventListener('click', e => {
            e.target.closest('.vinculo-card').remove();
        });
        container.appendChild(node);
        toggleVinculos();
    }
    addBtn.addEventListener('click', addVinculo);
    tipoSelect.addEventListener('change', () => {
        if (tipoSelect.value === 'positiva' && container.children.length === 0) addVinculo();
        toggleVinculos();
    });
    toggleVinculos();
    container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', e => e.target.closest('.vinculo-card').remove());
    });

    function getFirstVinculoFields() {
        // pega o primeiro .vinculo-card com nome preenchido
        const cards = Array.from(container.querySelectorAll('.vinculo-card'));
        for (const card of cards) {
            const get = (n) => card.querySelector(`[name="${n}[]"]`)?.value?.trim() || '';
            const nome = get('empregador_nome');
            if (nome) {
                return {
                    empregador_nome: nome,
                    empregador_tipo: get('empregador_tipo'),
                    empregador_doc: (get('empregador_doc') || '').replace(/\D+/g, ''),
                    natureza_vinculo: get('natureza_vinculo'),
                    cargo_funcao: get('cargo_funcao'),
                    carga_horaria_semanal: get('carga_horaria_semanal'),
                    horario_inicio: get('horario_inicio'),
                    horario_fim: get('horario_fim'),
                    data_inicio: get('data_inicio'),
                };
            }
        }
        return null;
    }

    function valida() {
        const tipo = tipoSelect.value;
        if (!tipo) return false;
        if (tipo === 'positiva') {
            const v = getFirstVinculoFields();
            if (!v) return false;
            // valida mínimos
            const req = ['empregador_nome', 'empregador_tipo', 'empregador_doc', 'natureza_vinculo', 'cargo_funcao', 'carga_horaria_semanal', 'horario_inicio', 'horario_fim', 'data_inicio'];
            return req.every(k => v[k]);
        }
        return true;
    }

    const ua = navigator.userAgent || '';
    const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
    const isStandalonePWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    btnModelo.addEventListener('click', async () => {
    if (!valida()) { form.classList.add('was-validated'); return; }

    // 1) iOS/Safari: pré-abre aba em branco SINCRONAMENTE (preserva gesto do usuário)
    const downloadTab = window.open('about:blank', '_blank');

    const fd = new FormData(form);
    try {
      // 2) prepara no backend
      const prep = await fetch('{{ url_for("acumulo.prepara_geracao") }}', { method: 'POST', body: fd });
      const data = await prep.json();
      if (!prep.ok || !data.ok) throw new Error(data.error || 'Falha ao preparar');

      const militarId = fd.get('militar_id');

      // 3) monta querystring
      const params = new URLSearchParams({
        ano: fd.get('ano') || '',
        tipo: fd.get('tipo') || '',
        empregador_nome: fd.get('empregador_nome') || '',
        empregador_doc: fd.get('empregador_doc') || '',
        natureza_vinculo: fd.get('natureza_vinculo') || '',
        cargo_funcao: fd.get('cargo_funcao') || '',
        carga_horaria_semanal: fd.get('carga_horaria_semanal') || '',
        horario_inicio: fd.get('horario_inicio') || '',
        horario_fim: fd.get('horario_fim') || '',
        data_inicio: fd.get('data_inicio') || '',
      });
      if ((fd.get('tipo') || '').toLowerCase() !== 'positiva') {
        ['empregador_nome','empregador_doc','natureza_vinculo','cargo_funcao','carga_horaria_semanal','horario_inicio','horario_fim','data_inicio']
          .forEach(k => params.delete(k));
      }

      const urlDownload = '{{ url_for("acumulo.modelo_docx", militar_id=0) }}'.replace('/0', `/${militarId}`) + '?' + params.toString();
      const urlUpload   = '{{ url_for("acumulo.upload_assinado", militar_id=0) }}'.replace('/0', `/${militarId}`) + '?ano=' + encodeURIComponent(fd.get('ano'));

      // 4) envia o download para a ABA PRÉ-ABERTA
      if (downloadTab) {
        downloadTab.location = urlDownload;
      } else {
        // fallback (popup bloqueado): usa mesma aba
        window.location.href = urlDownload;
      }

      // 5) dá um pequeno delay antes de redirecionar a aba atual (evita cancelar o download no iOS)
      setTimeout(() => {
        window.location.href = urlUpload;
      }, 600);

    } catch (e) {
      // se falhar, fecha a aba em branco pra não ficar lixo
      try { downloadTab?.close(); } catch(_) {}
      alert('Erro: ' + e.message);
    }
  });
</script>

{% endblock %}