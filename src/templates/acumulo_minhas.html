{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root {
    --brand-red: #B5121B;
    --brand-red-600: #9e1119;
    --glass-bg: rgba(255, 255, 255, .06);
    --glass-brd: rgba(255, 255, 255, .16);
    --ink-200: #e8eef6;
    --ink-400: #c0cfda;
  }

  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  .brand-header {
    background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  .glass-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  .btn-primary {
    background: var(--brand-red);
    border-color: var(--brand-red);
  }
  .btn-primary:hover { background: var(--brand-red-600); border-color: var(--brand-red-600); }

  .btn-outline-primary {
    color: var(--brand-red);
    border-color: var(--brand-red);
  }
  .btn-outline-primary:hover { color:#fff; background:var(--brand-red); }

  .badge-soft { border:1px solid rgba(255,255,255,.3); background:rgba(255,255,255,.08); }

  .list-plain { list-style:none; margin:0; padding:0; }
  .list-plain li {
    display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    padding:.6rem 0; border-bottom:1px dashed rgba(255,255,255,.18);
  }
  .list-plain li:last-child { border-bottom:0; }

  .small-muted { color:#94a3b8; }

  .modal-backdrop-custom{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1050}
  .modal-backdrop-custom.show{display:flex}
  .modal-card{background:#fff;color:#111;border-radius:12px;max-width:560px;width:96vw;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid rgba(0,0,0,.08)}
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
  <div class="container-xxl">

    <!-- Cabeçalho -->
    <div class="brand-header p-3 p-md-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded" alt="CBMAM">
          <div>
            <h1 class="h5 m-0">Minhas declarações — {{ ano }}</h1>
            <div class="small opacity-75">
              {% if militar %}{{ militar.nome_completo }}{% else %}Usuário{% endif %} · PG: {{ posto_grad_sigla or '-' }}
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('home_atualizacao') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
          {% if militar %}
          <button type="button" id="btn-nova-declaracao" class="btn btn-primary">
            <i class="bi bi-file-earmark-plus me-1"></i> Nova declaração
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Total enviadas</div>
          <div class="h4 m-0">{{ kpi_decl_total }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Pendentes</div>
          <div class="h4 m-0">{{ kpi_decl_pendentes }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Validadas</div>
          <div class="h4 m-0">{{ kpi_decl_validadas }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Inconformes</div>
          <div class="h4 m-0">{{ kpi_decl_inconformes }}</div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Coluna esquerda: Rascunho -->
      <div class="col-12 col-lg-6">
        <div class="glass-card p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h6 m-0"><i class="bi bi-cloud me-1"></i> Rascunho</h2>
            {% if rascunho %}
            <button id="btn-excluir-rascunho" class="btn btn-sm btn-outline-light">
              <i class="bi bi-trash me-1"></i> Excluir
            </button>
            {% endif %}
          </div>

          {% if rascunho %}
            {% set pj = rascunho.payload if rascunho.payload is mapping else {} %}
            <div class="mb-2 small-muted">
              Atualizado em {{ (rascunho.updated_at or rascunho.created_at).strftime('%d/%m/%Y %H:%M') if (rascunho.updated_at or rascunho.created_at) else '—' }}
            </div>

            <ul class="list-plain">
              <li><span>Tipo</span><strong>{{ (pj.tipo or '—')|capitalize }}</strong></li>
              {% if (pj.tipo or '') == 'positiva' %}
                <li><span>Órgão</span><strong>{{ (pj.vinculos[0].empregador_nome if pj.vinculos and pj.vinculos|length>0 else pj.get('empregador_nome')) or '—' }}</strong></li>
                <li><span>Esfera</span><strong>{{ (pj.vinculos[0].empregador_tipo if pj.vinculos and pj.vinculos|length>0 else pj.get('empregador_tipo')) or '—' }}</strong></li>
                <li><span>Vínculos</span><strong>{{ (pj.vinculos|length) if pj.vinculos is sequence else 1 }}</strong></li>
              {% endif %}
              <li><span>Observações</span><strong>{{ pj.observacoes or '—' }}</strong></li>
            </ul>

            <div class="mt-3 d-flex gap-2">
              {% if militar %}
                <a class="btn btn-outline-primary" href="{{ url_for('acumulo.novo', militar_id=militar.id, ano=ano) }}">
                  <i class="bi bi-pencil-square me-1"></i> Retomar preenchimento
                </a>
                <a class="btn btn-primary" href="{{ url_for('acumulo.upload_assinado', militar_id=militar.id, ano=ano) }}">
                  <i class="bi bi-upload me-1"></i> Enviar documentos assinados
                </a>
              {% endif %}
            </div>
          {% else %}
            <div class="small-muted">Você não possui rascunho para {{ ano }}.</div>
          {% endif %}
        </div>
      </div>

      <!-- Coluna direita: Enviadas -->
      <div class="col-12 col-lg-6">
        <div class="glass-card p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h6 m-0"><i class="bi bi-inboxes me-1"></i> Declarações enviadas</h2>
          </div>

          {% if declaracoes %}
            <ul class="list-plain">
              {% for d in declaracoes %}
              <li>
                <div>
                  <div><strong>{{ d.ano_referencia }}</strong> — {{ d.tipo or '—' }}</div>
                  <div class="small-muted">
                    Enviado em {{ d.created_at.strftime('%d/%m/%Y %H:%M') if d.created_at else '—' }}
                    {% if d.updated_at %} · Atualizado em {{ d.updated_at.strftime('%d/%m/%Y %H:%M') }}{% endif %}
                  </div>
                </div>
                <div class="text-nowrap">
                  {% set st = (d.status or '')|lower %}
                  {% if st == 'validado' %}
                    <span class="badge text-bg-success">validado</span>
                  {% elif st == 'inconforme' %}
                    <span class="badge text-bg-danger">inconforme</span>
                    {# BLOQUEIO do "Corrigir" se prazo_fechado == True #}
                    {% if not prazo_fechado %}
                      <a class="btn btn-sm btn-outline-light ms-2" href="{{ url_for('acumulo.editar', decl_id=d.id) }}">Corrigir</a>
                    {% else %}
                      <span class="small-muted ms-2">Edição bloqueada (prazo encerrado)</span>
                    {% endif %}
                  {% else %}
                    <span class="badge text-bg-warning text-dark">pendente</span>
                  {% endif %}
                  <a class="btn btn-sm btn-outline-primary ms-2" href="{{ url_for('acumulo.detalhe', decl_id=d.id) }}">Abrir</a>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="small-muted">Nenhum envio seu para {{ ano }} ainda.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal: prazo fechado -->
<div id="modal-prazo-fechado" class="modal-backdrop-custom" aria-hidden="true">
  <div class="modal-card">
    <div class="p-3 border-bottom">
      <h5 class="m-0">Prazo encerrado</h5>
      <div class="small text-muted mt-1">
        O prazo para envio da declaração encerrou em <strong>{{ prazo_limite.strftime('%d/%m/%Y') }}</strong>.
      </div>
    </div>
    <div class="p-3 d-flex justify-content-end gap-2">
      <button type="button" class="btn btn-primary" id="fechar-prazo-fechado">OK</button>
    </div>
  </div>
</div>

<!-- Modal: já enviou (pendente) -->
<div id="modal-bloqueio" class="modal-backdrop-custom" aria-hidden="true">
  <div class="modal-card">
    <div class="p-3 border-bottom">
      <h5 class="m-0">Declaração já enviada</h5>
      <div class="small text-muted mt-1">
        Você já enviou uma declaração para {{ ano }} e ela está <strong>aguardando análise</strong>.
        Aguarde o processamento para enviar outra.
      </div>
    </div>
    <div class="p-3 d-flex justify-content-end gap-2">
      {% if decl_pendente_id %}
      <a class="btn btn-outline-primary" href="{{ url_for('acumulo.detalhe', decl_id=decl_pendente_id) }}">
        Abrir minha declaração
      </a>
      {% endif %}
      <button type="button" class="btn btn-secondary" id="fechar-bloqueio">Fechar</button>
    </div>
  </div>
</div>

{% if militar %}
<script>
(() => {
  const btnExcluir = document.getElementById('btn-excluir-rascunho');
  if (btnExcluir){
    btnExcluir.addEventListener('click', async () => {
      if (!confirm('Remover o rascunho deste ano? Esta ação não pode ser desfeita.')) return;
      btnExcluir.disabled = true;
      btnExcluir.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Excluindo…';
      try {
        const url = {{ url_for('acumulo.excluir_rascunho', militar_id=militar.id, ano=ano) | tojson }};
        const resp = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'fetch' }});
        const data = await resp.json().catch(() => ({ ok:false }));
        if (!resp.ok || !data.ok) throw new Error(data.error || 'Falha ao excluir rascunho.');
        location.reload();
      } catch(e){
        alert(e.message || 'Erro ao excluir rascunho.');
        btnExcluir.disabled = false;
        btnExcluir.textContent = 'Excluir';
      }
    });
  }
})();
</script>

<script>
(() => {
  const temPendente  = {{ (tem_pendente or False) | tojson }};
  const novaUrl      = {{ (militar and url_for('acumulo.novo', militar_id=militar.id, ano=ano) or '#') | tojson }};
  const prazoFechado = {{ (prazo_fechado or False) | tojson }};

  const btnNova    = document.getElementById('btn-nova-declaracao');

  // modal pendente
  const modalPend  = document.getElementById('modal-bloqueio');
  const fecharPend = document.getElementById('fechar-bloqueio');
  function abrirPend(){ modalPend?.classList.add('show'); modalPend?.setAttribute('aria-hidden','false'); }
  function fecharPendFn(){ modalPend?.classList.remove('show'); modalPend?.setAttribute('aria-hidden','true'); }
  fecharPend?.addEventListener('click', fecharPendFn);
  modalPend?.addEventListener('click', (e) => { if (e.target === modalPend) fecharPendFn(); });

  // modal prazo
  const modalPrazo  = document.getElementById('modal-prazo-fechado');
  const fecharPrazo = document.getElementById('fechar-prazo-fechado');
  function abrirPrazo(){ modalPrazo?.classList.add('show'); modalPrazo?.setAttribute('aria-hidden','false'); }
  function fecharPrazoFn(){ modalPrazo?.classList.remove('show'); modalPrazo?.setAttribute('aria-hidden','true'); }
  fecharPrazo?.addEventListener('click', fecharPrazoFn);
  modalPrazo?.addEventListener('click', (e) => { if (e.target === modalPrazo) fecharPrazoFn(); });

  btnNova?.addEventListener('click', (e) => {
    // trava totalmente a propagação pra evitar qualquer outro handler navegando
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    // 1) PRAZO FECHADO => SEMPRE bloqueia e mostra modal
    if (prazoFechado) {
      abrirPrazo();
      return false;
    }

    // 2) Já enviou e está pendente => bloqueia nova com modal
    if (temPendente) {
      abrirPend();
      return false;
    }

    // 3) Fluxo normal
    if (novaUrl && novaUrl !== '#') {
      window.location.href = novaUrl;
    }
    return false;
  }, true); // <— captura primeiro, antes de qualquer outro listener
})();
</script>

{% endif %}
{% endblock %}
