{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root {
    --brand-red: #B5121B;
    --brand-red-600: #9e1119;
    --glass-bg: rgba(255, 255, 255, .06);
    --glass-brd: rgba(255, 255, 255, .16);
    --ink-200: #e8eef6;
    --ink-400: #c0cfda;
  }

  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
  }

  .brand-header {
    background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
  }

  .glass-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
  }

  .btn-primary {
    background: var(--brand-red);
    border-color: var(--brand-red);
  }

  .btn-primary:hover {
    background: var(--brand-red-600);
    border-color: var(--brand-red-600);
  }

  .btn-outline-primary {
    color: var(--brand-red);
    border-color: var(--brand-red);
  }

  .btn-outline-primary:hover {
    color: #fff;
    background: var(--brand-red);
  }

  .badge-soft {
    border: 1px solid rgba(255, 255, 255, .3);
    background: rgba(255, 255, 255, .08);
  }

  .list-plain {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .list-plain li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding: .6rem 0;
    border-bottom: 1px dashed rgba(255, 255, 255, .18);
  }

  .list-plain li:last-child {
    border-bottom: 0;
  }

  .small-muted {
    color: #94a3b8;
  }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
  <div class="container-xxl">

    <!-- Cabeçalho -->
    <div class="brand-header p-3 p-md-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded"
            alt="CBMAM">
          <div>
            <h1 class="h5 m-0">Minhas declarações — {{ ano }}</h1>
            <div class="small opacity-75">
              {% if militar %}{{ militar.nome_completo }}{% else %}Usuário{% endif %} · PG: {{ posto_grad_sigla or '-'
              }}
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('home_atualizacao') }}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i>
            Voltar</a>
          {% if militar %}
          <a href="{{ url_for('acumulo.novo', militar_id=militar.id, ano=ano) }}" class="btn btn-primary">
            <i class="bi bi-file-earmark-plus me-1"></i> Nova declaração
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Total enviadas</div>
          <div class="h4 m-0">{{ kpi_decl_total }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Pendentes</div>
          <div class="h4 m-0">{{ kpi_decl_pendentes }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Validadas</div>
          <div class="h4 m-0">{{ kpi_decl_validadas }}</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="glass-card p-3 text-center">
          <div class="small-muted">Inconformes</div>
          <div class="h4 m-0">{{ kpi_decl_inconformes }}</div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Coluna esquerda: Rascunho -->
      <div class="col-12 col-lg-6">
        <div class="glass-card p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h6 m-0"><i class="bi bi-cloud me-1"></i> Rascunho</h2>
            {% if rascunho %}
            <button id="btn-excluir-rascunho" class="btn btn-sm btn-outline-light">
              <i class="bi bi-trash me-1"></i> Excluir
            </button>
            {% endif %}
          </div>

          {% if rascunho %}
          {% set pj = rascunho.payload if rascunho.payload is mapping else {} %}
          <div class="mb-2 small-muted">Atualizado em {{ (rascunho.updated_at or rascunho.created_at).strftime('%d/%m/%Y
            %H:%M') if rascunho.updated_at or rascunho.created_at else '—' }}</div>

          <ul class="list-plain">
            <li><span>Tipo</span><strong>{{ (pj.tipo or '—')|capitalize }}</strong></li>
            {% if (pj.tipo or '') == 'positiva' %}
            <li><span>Órgão</span><strong>{{ (pj.vinculos[0].empregador_nome if pj.vinculos and pj.vinculos|length>0
                else pj.get('empregador_nome')) or '—' }}</strong></li>
            <li><span>Esfera</span><strong>{{ (pj.vinculos[0].empregador_tipo if pj.vinculos and pj.vinculos|length>0
                else pj.get('empregador_tipo')) or '—' }}</strong></li>
            <li><span>Vínculos</span><strong>{{ (pj.vinculos|length) if pj.vinculos is sequence else 1 }}</strong></li>
            {% endif %}
            <li><span>Observações</span><strong>{{ pj.observacoes or '—' }}</strong></li>
          </ul>

          <div class="mt-3 d-flex gap-2">
            {% if militar %}
            <a class="btn btn-outline-primary" href="{{ url_for('acumulo.novo', militar_id=militar.id, ano=ano) }}">
              <i class="bi bi-pencil-square me-1"></i> Retomar preenchimento
            </a>
            <a class="btn btn-primary" href="{{ url_for('acumulo.upload_assinado', militar_id=militar.id, ano=ano) }}">
              <i class="bi bi-upload me-1"></i> Enviar documentos assinados
            </a>
            {% endif %}
          </div>
          {% else %}
          <div class="small-muted">Você não possui rascunho para {{ ano }}.</div>
          {% endif %}
        </div>
      </div>

      <!-- Coluna direita: Enviadas -->
      <div class="col-12 col-lg-6">
        <div class="glass-card p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h6 m-0"><i class="bi bi-inboxes me-1"></i> Declarações enviadas</h2>
          </div>

          {% if declaracoes %}
          <ul class="list-plain">
            {% for d in declaracoes %}
            <li>
              <div>
                <div><strong>{{ d.ano_referencia }}</strong> — {{ d.tipo or '—' }}</div>
                <div class="small-muted">
                  Enviado em {{ d.created_at.strftime('%d/%m/%Y %H:%M') if d.created_at else '—' }}
                  {% if d.updated_at %} · Atualizado em {{ d.updated_at.strftime('%d/%m/%Y %H:%M') }}{% endif %}
                </div>
              </div>
              <div class="text-nowrap">
                {% set st = (d.status or '')|lower %}
                {% if st == 'validado' %}
                <span class="badge text-bg-success">validado</span>
                {% elif st == 'inconforme' %}
                <span class="badge text-bg-danger">inconforme</span>
                <a class="btn btn-sm btn-outline-light ms-2"
                  href="{{ url_for('acumulo.editar', decl_id=d.id) }}">Corrigir</a>
                {% else %}
                <span class="badge text-bg-warning text-dark">pendente</span>
                {% endif %}
                <a class="btn btn-sm btn-outline-primary ms-2"
                  href="{{ url_for('acumulo.detalhe', decl_id=d.id) }}">Abrir</a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="small-muted">Nenhum envio seu para {{ ano }} ainda.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

{% if militar %}
<script>
  (() => {
    const btnExcluir = document.getElementById('btn-excluir-rascunho');
    if (!btnExcluir) return;

    btnExcluir.addEventListener('click', async () => {
      if (!confirm('Remover o rascunho deste ano? Esta ação não pode ser desfeita.')) return;
      btnExcluir.disabled = true;
      btnExcluir.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Excluindo…';

      try {
        const url = {{ url_for('acumulo.excluir_rascunho', militar_id = militar.id, ano = ano) | tojson
      }};
    const resp = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'fetch' } });
    const data = await resp.json().catch(() => ({ ok: false }));
    if (!resp.ok || !data.ok) throw new Error(data.error || 'Falha ao excluir rascunho.');
    location.reload();
  }catch (e) {
    alert(e.message || 'Erro ao excluir rascunho.');
    btnExcluir.disabled = false;
    btnExcluir.textContent = 'Excluir';
  }
  });
}) ();
</script>
{% endif %}
{% endblock %}