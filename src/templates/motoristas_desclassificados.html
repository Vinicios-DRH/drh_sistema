{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root {
    --ink-200:#e8eef6;
    --glass-brd: rgba(255,255,255,.12);
  }

  body {
    background: linear-gradient(135deg,#0e1726 0%,#0b2e4f 45%,#0b3a63 100%) fixed;
  }

  .page-wrapper { position: relative; }

  .brand-header {
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  .glass-panel {
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.5);
    border-radius: 18px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    color:#111;
  }

  .container-fluid { max-width: 100% !important; }
  .brand-header, .glass-panel { width: 100%; }

  .table { background: transparent; }
  .table-responsive { overflow-x: auto; }

  .table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(255,255,255,.9);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .table-striped > tbody > tr:nth-of-type(odd) > * {
    background-color: rgba(0,0,0,.02);
  }
  .table-hover > tbody > tr:hover > * {
    background-color: rgba(0,0,0,.04);
  }

  .table th, .table td { white-space: nowrap; }
  @media (max-width: 992px){
    .table th, .table td { white-space: normal; word-break: break-word; }
  }

  .input-group .form-control { min-width: 260px; }

  @media (min-width:1200px){
    .container-fluid { padding-left: 1.25rem; padding-right: 1.25rem; }
  }

  .glass-chart {
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.5);
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 1rem;
  }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4 page-wrapper">
  <div class="container-fluid px-2 px-md-3">

    <!-- Cabeçalho -->
    <div class="brand-header p-3 p-md-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logobm.png') }}" width="48" height="48" class="rounded" alt="CBMAM">
          <div>
            <h1 class="h5 mb-1">Motoristas Desclassificados</h1>
            <div class="small text-light opacity-75">
              DRH • Sistema CBMAM
              {% if motoristas %}
                • página {{ motoristas.page }}{% if motoristas.pages %}/{{ motoristas.pages }}{% endif %}
                • mostrando {{ motoristas.items|length }} registro(s)
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Busca -->
        <form method="GET" action="{{ url_for('motoristas_desclassificados') }}" class="d-flex align-items-stretch flex-wrap gap-2">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="search" class="form-control" placeholder="Buscar por nome..." value="{{ search }}">
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-arrow-return-left me-1"></i> Buscar
          </button>
          {% if search %}
          <a href="{{ url_for('motoristas_desclassificados') }}" class="btn btn-outline-light">
            <i class="bi bi-x-lg"></i>
          </a>
          {% endif %}
        </form>
      </div>
    </div>

    <!-- Painel de vidro -->
    <div class="glass-panel p-3 p-md-4">

      <div class="mb-3">
        <strong>Total desclassificados:</strong> {{ total_desclassificados }}
      </div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" style="width:100%">
          <thead>
            <tr>
              <th>Nome Completo</th>
              <th>Matrícula</th>
              <th>Posto/Graduação</th>
              <th>Categoria</th>
              <th>Boletim Geral</th>
              <th>SIGED</th>
              <th>Desclassificado em</th>
              <th>Por</th>
            </tr>
          </thead>
          <tbody>
            {% for motorista in motoristas.items %}
            <tr>
              <td>
                <a href="{{ url_for('atualizar_motorista', motorista_id=motorista.id) }}">
                  {{ motorista.militar.nome_completo }}
                </a>
              </td>
              <td>{{ motorista.militar.matricula }}</td>
              <td>{{ motorista.militar.posto_grad.sigla if motorista.militar.posto_grad else '' }}</td>
              <td>{{ motorista.categoria.sigla if motorista.categoria else '' }}</td>
              <td>{{ motorista.boletim_geral }}</td>
              <td>{{ motorista.siged }}</td>
              <td>
                {% if motorista.desclassificar_em %}
                  {{ motorista.desclassificar_em.strftime('%d/%m/%Y %H:%M') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if motorista.usuario_desclassificacao %}
                  {{ motorista.usuario_desclassificacao.nome }}
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-search"></i> Nenhum desclassificado encontrado.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginação -->
      <nav class="d-flex justify-content-center mt-3" aria-label="Paginação">
        <ul class="pagination mb-0">
          {% if motoristas.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('motoristas_desclassificados', page=motoristas.prev_num, search=search) }}" aria-label="Anterior">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for page_num in motoristas.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
            {% if page_num %}
            <li class="page-item {% if page_num == motoristas.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('motoristas_desclassificados', page=page_num, search=search) }}">{{ page_num }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          {% if motoristas.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('motoristas_desclassificados', page=motoristas.next_num, search=search) }}" aria-label="Próximo">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>

      <!-- Gráficos -->
      <div class="row g-3 mt-4">
        <div class="col-md-6">
          <div class="glass-chart h-100">
            <h6 class="text-center mb-3">Desclassificados por Categoria</h6>
            <div id="grafico_categorias"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="glass-chart h-100">
            <h6 class="text-center mb-3">Desclassificados por OBM</h6>
            <div id="grafico_obms"></div>
          </div>
        </div>
        <div class="col-12">
          <div class="glass-chart mt-3">
            <h6 class="text-center mb-3">Evolução Mensal</h6>
            <div id="grafico_mensal"></div>
          </div>
        </div>
      </div>

      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script>
        Plotly.newPlot('grafico_categorias', {{ grafico_categorias|safe }});
        Plotly.newPlot('grafico_obms', {{ grafico_obms|safe }});
        Plotly.newPlot('grafico_mensal', {{ grafico_mensal|safe }});
      </script>

    </div>
  </div>
</section>
{% endblock %}
