{% extends 'base.html' %}

{% block head %}
<style>
  :root{
    --ink-200:#e8eef6;
    --glass-brd:rgba(255,255,255,.12);
    --brand-red:#B5121B;
    --brand-red-600:#9F1119;
  }

  body{
    background:linear-gradient(135deg,#0e1726 0%,#0b2e4f 45%,#0b3a63 100%) fixed;
  }

  /* Cabeçalho / toolbar */
  .brand-header{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    border:1px solid var(--glass-brd);
    border-radius:14px;
    color:var(--ink-200);
    backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
    box-shadow:0 8px 22px rgba(0,0,0,.35);
  }

  /* Painéis de conteúdo */
  .glass-panel{
    background:rgba(255,255,255,.92);
    color:#111;
    border:1px solid rgba(255,255,255,.5);
    border-radius:14px;
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
    box-shadow:0 8px 22px rgba(0,0,0,.35);
  }

  /* Botões compactos na cor da marca */
  .btn-brand{background:var(--brand-red);border-color:var(--brand-red);color:#fff}
  .btn-brand:hover{background:var(--brand-red-600);border-color:var(--brand-red-600);color:#fff}

  /* Tabela pro: cabeçalho sticky + scroll vertical */
  .table-wrap{
    max-height:60vh;           /* <- dá o scroll vertical */
    overflow:auto;
    border:1px solid rgba(0,0,0,.06);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.08);
    background:#fff;
  }
  .table-wrap table{margin:0}
  .table-wrap thead th{
    position:sticky; top:0; z-index:2;
    background:#f8fafc; color:#334155;
    text-transform:uppercase; font-size:.72rem; letter-spacing:.02em;
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .table-sm th, .table-sm td{ padding:.4rem .55rem; }  /* deixa mais enxuta */
  tbody td{ vertical-align:middle; }
  tbody tr:hover{ background:rgba(181,18,27,.06); }

  /* Switch menor e na cor da marca */
  .form-switch .form-check-input{ width:2.2rem; height:1.1rem; }
  .form-check-input:checked{background-color:var(--brand-red);border-color:var(--brand-red)}
  .form-check-input:focus{box-shadow:0 0 0 .15rem rgba(181,18,27,.25)}

  /* Células editáveis — feedback visual */
  td[contenteditable="true"]{outline:0;border-radius:6px}
  td[contenteditable="true"]:hover{box-shadow:inset 0 0 0 1px rgba(0,0,0,.08)}
  td[contenteditable="true"]:focus{box-shadow:0 0 0 .2rem rgba(181,18,27,.25)}
  td.saving{position:relative}
  td.saving::after{
    content:"";position:absolute;right:.35rem;top:50%;transform:translateY(-50%);
    width:12px;height:12px;border-radius:50%;
    border:2px solid rgba(181,18,27,.35);border-top-color:var(--brand-red);
    animation:spin .7s linear infinite
  }
  @keyframes spin{to{transform:translateY(-50%) rotate(1turn)}}

  /* Animação de entrada das linhas (levinha) */
  @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .fade-row{opacity:0}
  .fade-row.visible{animation:fadeUp .35s ease-out forwards}
</style>
{% endblock %}

{% block body %}
<div class="container py-4">

  <!-- Toolbar -->
  <div class="brand-header p-3 px-md-4 mb-3">
    <div class="d-flex flex-column flex-lg-row align-items-stretch align-items-lg-center justify-content-between gap-2">
      <h1 class="h5 m-0">Controle de Convocações</h1>

      <div class="d-flex flex-column flex-sm-row gap-2">
        <!-- Busca -->
        <form class="input-group input-group-sm" method="get" action="{{ url_for('controle_convocacao') }}">
          <input type="text" class="form-control form-control-sm" placeholder="Buscar por nome..." name="search"
                 value="{{ request.args.get('search', '') }}">
          <button class="btn btn-sm btn-brand" type="submit">Pesquisar</button>
        </form>

        <!-- Exportar (preserva filtros) -->
        <form method="get" action="{{ url_for('exportar_convocacoes') }}">
          {% for key, value in request.args.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
          {% endfor %}
          <button type="submit" class="btn btn-sm btn-success">Exportar Excel</button>
        </form>

        <!-- Limpar -->
        <a class="btn btn-sm btn-outline-light" href="{{ url_for('controle_convocacao') }}">Limpar filtros</a>
      </div>
    </div>
  </div>

  <!-- Tabela + filtros -->
  <div class="glass-panel p-3 p-md-4">
    <form method="get" action="{{ url_for('controle_convocacao') }}" id="filtros-form">
      {% if request.args.get('search') %}
        <input type="hidden" name="search" value="{{ request.args.get('search') }}">
      {% endif %}

      <div class="table-wrap">
        <table class="table table-striped table-hover table-sm align-middle mb-0">
          <thead class="text-nowrap">
            <tr>
              <th>ORD.</th>
              <th>Classificação</th>
              <th>Inscrição</th>
              <th>Nome</th>
              <th>Nota Final</th>
              <th>Ordem Convocação</th>
              <th>Apresentou</th>
              <th>Situação</th>
              <th>Matrícula</th>
              <th>Nº Mat. DOE</th>
              <th>BG Mat. DOE</th>
              <th>Portaria Conv.</th>
              <th>BG Portaria</th>
              <th>DOE Portaria</th>
              <th>Notif. Pessoal</th>
              <th>Termo Desist.</th>
              <th>SIGED Desist.</th>
              <th>Criado em</th>
            </tr>
            <tr>
              <th><input name="id" value="{{ request.args.get('id', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="classificacao" value="{{ request.args.get('classificacao', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="inscricao" value="{{ request.args.get('inscricao', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="nome" value="{{ request.args.get('nome', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="nota_final" value="{{ request.args.get('nota_final', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="ordem_de_convocacao" value="{{ request.args.get('ordem_de_convocacao', '') }}" class="form-control form-control-sm" /></th>
              <th>
                <select name="apresentou" class="form-select form-select-sm">
                  <option value="">Todos</option>
                  <option value="sim" {% if request.args.get('apresentou')=='sim' %}selected{% endif %}>Sim</option>
                  <option value="nao" {% if request.args.get('apresentou')=='nao' %}selected{% endif %}>Não</option>
                </select>
              </th>
              <th><input name="situacao_convocacao_id" value="{{ request.args.get('situacao_convocacao_id', '') }}" class="form-control form-control-sm" /></th>
              <th>
                <select name="matricula" class="form-select form-select-sm">
                  <option value="">Todos</option>
                  <option value="sim" {% if request.args.get('matricula')=='sim' %}selected{% endif %}>Sim</option>
                  <option value="nao" {% if request.args.get('matricula')=='nao' %}selected{% endif %}>Não</option>
                </select>
              </th>
              <th><input name="numero_da_matricula_doe" value="{{ request.args.get('numero_da_matricula_doe', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="bg_matricula_doe" value="{{ request.args.get('bg_matricula_doe', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="portaria_convocacao" value="{{ request.args.get('portaria_convocacao', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="bg_portaria_convocacao" value="{{ request.args.get('bg_portaria_convocacao', '') }}" class="form-control form-control-sm" /></th>
              <th><input name="doe_portaria_convocacao" value="{{ request.args.get('doe_portaria_convocacao', '') }}" class="form-control form-control-sm" /></th>
              <th>
                <select name="notificacao_pessoal" class="form-select form-select-sm">
                  <option value="">Todos</option>
                  <option value="sim" {% if request.args.get('notificacao_pessoal')=='sim' %}selected{% endif %}>Sim</option>
                  <option value="nao" {% if request.args.get('notificacao_pessoal')=='nao' %}selected{% endif %}>Não</option>
                </select>
              </th>
              <th>
                <select name="termo_desistencia" class="form-select form-select-sm">
                  <option value="">Todos</option>
                  <option value="sim" {% if request.args.get('termo_desistencia')=='sim' %}selected{% endif %}>Sim</option>
                  <option value="nao" {% if request.args.get('termo_desistencia')=='nao' %}selected{% endif %}>Não</option>
                </select>
              </th>
              <th><input name="siged_desistencia" value="{{ request.args.get('siged_desistencia', '') }}" class="form-control form-control-sm" /></th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            {% set ordem_base = (convocacoes.page - 1) * convocacoes.per_page %}
            {% for c in convocacoes.items %}
            <tr class="fade-row">
              <td>{{ ordem_base + loop.index }}º</td>
              <td>{{ c.classificacao }}</td>
              <td>{{ c.inscricao }}</td>
              <td class="text-break" style="min-width:180px;">{{ c.nome }}</td>
              <td>{{ c.nota_final }}</td>

              <td contenteditable="true" data-id="{{ c.id }}" data-campo="ordem_de_convocacao">{{ c.ordem_de_convocacao }}</td>

              <td>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input boolean-toggle" type="checkbox" role="switch"
                         data-id="{{ c.id }}" data-campo="apresentou" {% if c.apresentou %}checked{% endif %}>
                </div>
              </td>

              <td contenteditable="true" data-id="{{ c.id }}" data-campo="situacao_convocacao_id">
                {{ c.situacao.situacao if c.situacao else '-' }}
              </td>

              <td>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input boolean-toggle" type="checkbox" role="switch"
                         data-id="{{ c.id }}" data-campo="matricula" {% if c.matricula %}checked{% endif %}>
                </div>
              </td>

              <td contenteditable="true" data-id="{{ c.id }}" data-campo="numero_da_matricula_doe">{{ c.numero_da_matricula_doe }}</td>
              <td contenteditable="true" data-id="{{ c.id }}" data-campo="bg_matricula_doe">{{ c.bg_matricula_doe }}</td>
              <td contenteditable="true" data-id="{{ c.id }}" data-campo="portaria_convocacao">{{ c.portaria_convocacao }}</td>
              <td contenteditable="true" data-id="{{ c.id }}" data-campo="bg_portaria_convocacao">{{ c.bg_portaria_convocacao }}</td>
              <td contenteditable="true" data-id="{{ c.id }}" data-campo="doe_portaria_convocacao">{{ c.doe_portaria_convocacao }}</td>

              <td>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input boolean-toggle" type="checkbox" role="switch"
                         data-id="{{ c.id }}" data-campo="notificacao_pessoal" {% if c.notificacao_pessoal %}checked{% endif %}>
                </div>
              </td>

              <td>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input boolean-toggle" type="checkbox" role="switch"
                         data-id="{{ c.id }}" data-campo="termo_desistencia" {% if c.termo_desistencia %}checked{% endif %}>
                </div>
              </td>

              <td contenteditable="true" data-id="{{ c.id }}" data-campo="siged_desistencia">{{ c.siged_desistencia }}</td>
              <td>{{ c.data_criacao.strftime('%d/%m/%Y') if c.data_criacao else '-' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="18" class="text-center py-4">Nenhuma convocação encontrada.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>

    {% if convocacoes.pages > 1 %}
      {% set args = request.args.to_dict() %}
      <nav class="mt-3" aria-label="Paginação">
        <ul class="pagination pagination-sm justify-content-center flex-wrap gap-1">
          {% set prev_args = args.copy() %}
          {% set _ = prev_args.update({'page': convocacoes.prev_num}) %}
          <li class="page-item {% if not convocacoes.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('controle_convocacao', **prev_args) }}">&laquo;</a>
          </li>

          {% for p in range(1, convocacoes.pages + 1) %}
            {% if p >= convocacoes.page - 2 and p <= convocacoes.page + 2 %}
              {% set page_args = args.copy() %}
              {% set _ = page_args.update({'page': p}) %}
              <li class="page-item {% if convocacoes.page == p %}active{% endif %}">
                <a class="page-link" href="{{ url_for('controle_convocacao', **page_args) }}">{{ p }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% set next_args = args.copy() %}
          {% set _ = next_args.update({'page': convocacoes.next_num}) %}
          <li class="page-item {% if not convocacoes.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('controle_convocacao', **next_args) }}">&raquo;</a>
          </li>
        </ul>
      </nav>
    {% endif %}
  </div>

  <!-- Gráfico compacto -->
  <div class="glass-panel p-3 p-md-4 mt-3">
    <h2 class="h6 mb-2">Convocações por Situação</h2>
    <div style="height:260px;">  <!-- controla o tamanho -->
      <canvas id="convChart" style="max-height:100%;"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Gráfico: respeita a altura fixa do contêiner
  document.addEventListener('DOMContentLoaded', () => {
    const contagem = {{ contagem_situacoes | tojson | safe }};
    const ctx = document.getElementById('convChart').getContext('2d');
    const base = getComputedStyle(document.documentElement).getPropertyValue('--brand-red').trim() || '#B5121B';

    function tint(hex, amt){
      let c = hex.replace('#','');
      if(c.length===3) c = c.split('').map(x=>x+x).join('');
      const n = parseInt(c,16);
      let r=(n>>16)+amt, g=((n>>8)&255)+amt, b=(n&255)+amt;
      r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b));
      return '#' + (r<<16|g<<8|b).toString(16).padStart(6,'0');
    }

    const labels = Object.keys(contagem);
    const vals   = Object.values(contagem);
    const colors = vals.map((_,i)=>tint(base, 18*i - 18));

    new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 1 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,   // usa a altura do contêiner (260px)
        plugins: { legend: { position: 'bottom' } }
      }
    });
  });
</script>

<script>
  // Filtros com debounce + animação das linhas
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filtros-form');
    let timer;
    function debounceSubmit(){ clearTimeout(timer); timer = setTimeout(()=>form.submit(), 450); }

    form.querySelectorAll('input, select').forEach(el=>{
      if(el.tagName==='INPUT') el.addEventListener('input', debounceSubmit);
      else el.addEventListener('change', ()=>form.submit());
    });

    // Anima cada linha na carga
    document.querySelectorAll('tbody tr.fade-row').forEach((r,i)=>{
      r.style.animationDelay = (i*50)+'ms';
      r.classList.add('visible');
    });
  });
</script>

<script>
  // Edição inline com feedback (blur/Enter confirma; Esc cancela)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
      let original = cell.innerText.trim();

      cell.addEventListener('focus', () => { original = cell.innerText.trim(); });

      cell.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){ e.preventDefault(); cell.blur(); }
        if(e.key === 'Escape'){ cell.innerText = original; cell.blur(); }
      });

      cell.addEventListener('paste', (e) => {
        e.preventDefault();
        const t = (e.clipboardData || window.clipboardData).getData('text');
        document.execCommand('insertText', false, t.replace(/\n/g,' '));
      });

      cell.addEventListener('blur', () => {
        const novo = cell.innerText.trim();
        if (novo === original) return;
        cell.classList.add('saving');

        fetch('{{ url_for("atualizar_campo_convocacao") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
          body: JSON.stringify({ id: cell.dataset.id, campo: cell.dataset.campo, valor: novo })
        })
        .then(r => r.json())
        .then(resp => {
          if (!resp.sucesso) { alert(resp.erro || 'Erro ao salvar'); cell.innerText = original; }
        })
        .catch(() => { alert('Erro de rede'); cell.innerText = original; })
        .finally(()=> cell.classList.remove('saving'));
      });
    });

    document.querySelectorAll('.boolean-toggle').forEach(toggle => {
      toggle.addEventListener('change', () => {
        const prev = !toggle.checked;
        fetch('{{ url_for("atualizar_campo_convocacao") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
          body: JSON.stringify({ id: toggle.dataset.id, campo: toggle.dataset.campo, valor: toggle.checked })
        })
        .then(r => r.json())
        .then(resp => {
          if (!resp.sucesso) { alert(resp.erro || 'Erro ao salvar'); toggle.checked = prev; }
        })
        .catch(() => { alert('Erro de rede'); toggle.checked = prev; });
      });
    });
  });
</script>
{% endblock %}
