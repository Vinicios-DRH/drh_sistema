{% extends 'base.html' %}

{% block head %}
<style>

    /* ——— BG igual à ficha + containers de vidro ——— */
    :root{
    --ink-200:#e8eef6;
    --glass-brd: rgba(255,255,255,.12);
    }

    /* Gradiente do app */
    body{
    background: linear-gradient(135deg,#0e1726 0%,#0b2e4f 45%,#0b3a63 100%) fixed;
    }

    /* Wrapper para ajudar em posicionamentos “no vidro” */
    .page-wrapper{ position: relative; }

    /* Cabeçalho com vidro (igual à ficha) */
    .brand-header{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* Painel claro “frosted” para a tabela (texto escuro) */
    .glass-panel{
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.5);
    border-radius: 18px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    color:#111;
    }

    /* Evita fundo branco chapado da tabela dentro do vidro */
    .table{ background: transparent; }
  
    /* Força contraste nas colunas OBMs e Funções */
    th.col-obms, td.col-obms,
    th.col-funcoes, td.col-funcoes {
        color: #111 !important;       /* texto escuro */
        font-weight: 600;             /* um pouco mais forte no header e células */
    }

    /* “Chips” para cada item de OBM/Função */
    .chip {
        display: inline-block;
        padding: .2rem .5rem;
        margin: .125rem .125rem 0 0;
        border-radius: 9999px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        font-weight: 600;
        font-size: .75rem;
        line-height: 1;
        color: #111;
        white-space: nowrap;
    }

    /* Caso a tabela tenha estilos que deixam o td opaco */
    .table td, .table th { opacity: 1 !important; }

    /* Cabeçalho sticky e “frosted” dentro do glass-panel */
    .table thead th{
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(255,255,255,.9);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }

    .table-striped > tbody > tr:nth-of-type(odd) > *{
        background-color: rgba(0,0,0,.02);
    }
    .table-hover > tbody > tr:hover > *{
        background-color: rgba(0,0,0,.04);
    }
</style>
{% endblock %}


{% block body %}
<section class="py-3 py-md-4 page-wrapper">
    <div class="container">
        <!-- Cabeçalho com ações e contador -->
        <div class="brand-header p-3 p-md-4 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <!-- Marca + resumo -->
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ url_for('static', filename='img/logobm.png') }}" width="48" height="48" class="rounded" alt="CBMAM">
                    <div>
                        <h1 class="h5 mb-1">Militares</h1>
                        <div class="small text-light opacity-75">
                        DRH • Sistema CBMAM
                        {% if total is defined %}
                            • mostrando <strong>{{ start }}</strong>–<strong>{{ end }}</strong> de <strong>{{ total }}</strong>
                            {% if pages is defined %} • página {{ page }}{% if pages %}/{{ pages }}{% endif %}{% endif %}
                        {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ações -->
                <form method="get" action="{{ url_for('militares') }}"
                    class="d-flex align-items-stretch flex-wrap gap-2">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" name="search"
                            placeholder="Buscar por nome, CPF, RG, matrícula…"
                            value="{{ request.args.get('search', '') }}"
                            class="form-control" aria-label="Buscar militar">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-arrow-return-left me-1"></i> Buscar
                    </button>

                    {% if request.args.get('search') %}
                    <a href="{{ url_for('militares') }}" class="btn btn-outline-light" title="Limpar busca">
                        <i class="bi bi-x-lg"></i>
                    </a>
                    {% endif %}

                    <button type="button" class="btn btn-outline-light"
                            data-bs-toggle="modal" data-bs-target="#filtrarMilitar">
                        <i class="bi bi-funnel me-1"></i> Filtros
                    </button>

                    {# opcional: ajuste a rota do “novo” se já existir #}
                    {% if has_novo_militar %}
                    <a href="{{ url_for('novo_militar') }}" class="btn btn-warning text-dark">
                        <i class="bi bi-plus-circle me-1"></i> Novo
                    </a>
                    {% endif %}
                </form>
            </div>
        </div>


            <!-- Painel de vidro envolvendo filtros + tabela + paginação -->
        <div class="glass-panel p-3 p-md-4">

            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th>Nome Completo</th>
                            <th>Nome de Guerra</th>
                            <th>Posto/Grad</th>
                            <th>Quadro</th>
                            <th>CPF</th>
                            <th>RG</th>
                            <th>Matrícula</th>
                            <th class="col-obms">OBMs</th>
                            <th class="col-funcoes">Funções</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if militares|length == 0 %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-search"></i> Nenhum militar encontrado com os critérios informados.
                            </td>
                        </tr>
                        {% else %}
                        {% for militar in militares %}
                        <tr>
                            <td><a href="{{ url_for('exibir_militar', militar_id=militar.id) }}">{{ militar.nome_completo }}</a></td>
                            <td>{{ militar.nome_guerra }}</td>
                            <td>{{ militar.posto_grad }}</td>
                            <td>{{ militar.quadro }}</td>
                            <td>{{ militar.cpf_fmt or militar.cpf }}</td>
                            <td>{{ militar.rg }}</td>
                            <td>{{ militar.matricula }}</td>

                            <td class="col-obms">
                            {% if militar.obms and militar.obms|length %}
                                {% set MAX = 3 %}
                                {% for obm in militar.obms[:MAX] %}
                                <span class="chip">{{ obm }}</span>
                                {% endfor %}
                                {% if militar.obms|length > MAX %}
                                <span class="chip">+{{ militar.obms|length - MAX }}</span>
                                {% endif %}
                            {% else %} — {% endif %}
                            </td>

                            <td class="col-funcoes">
                            {% if militar.funcoes and militar.funcoes|length %}
                                {% set MAX = 3 %}
                                {% for funcao in militar.funcoes[:MAX] %}
                                <span class="chip">{{ funcao }}</span>
                                {% endfor %}
                                {% if militar.funcoes|length > MAX %}
                                <span class="chip">+{{ militar.funcoes|length - MAX }}</span>
                                {% endif %}
                            {% else %} — {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <nav class="d-flex justify-content-center mt-3">
                <ul class="pagination mb-0">
                    <li class="page-item {{ 'disabled' if not has_prev }}">
                    <a class="page-link" href="{{ url_for('militares', page=prev_page, search=request.args.get('search', '')) }}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                    </li>

                    {# páginas 1, ..., (p-1,p,p+1), ..., last #}
                    {% set last_out = 0 %}
                    {% for p in range(1, pages + 1) %}
                    {% if p == 1 or p == pages or (p >= page - 1 and p <= page + 1) %}
                        <li class="page-item {{ 'active' if p == page }}">
                        <a class="page-link" href="{{ url_for('militares', page=p, search=request.args.get('search', '')) }}">{{ p }}</a>
                        </li>
                        {% set last_out = p %}
                    {% elif last_out != 'dots' %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% set last_out = 'dots' %}
                    {% endif %}
                    {% endfor %}

                    <li class="page-item {{ 'disabled' if not has_next }}">
                    <a class="page-link" href="{{ url_for('militares', page=next_page, search=request.args.get('search', '')) }}" aria-label="Próxima">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</section>

<div class="modal fade " id="filtrarMilitar" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Filtros Avançados</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 p-md-4 p-xl-5">
                <form class="row g-3" id="formFiltros" method="POST" action="{{ url_for('tabela_militares') }}">
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.obm_ids_1.label(class="form-control-label") }}
                            {{ form_militar.obm_ids_1(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.posto_grad_id.label(class="form-control-label") }}
                            {{ form_militar.posto_grad_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.quadro_id.label(class="form-control-label") }}
                            {{ form_militar.quadro_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.especialidade_id.label(class="form-control-label") }}
                            {{ form_militar.especialidade_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.localidade_id.label(class="form-control-label") }}
                            {{ form_militar.localidade_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.situacao_id.label(class="form-control-label") }}
                            {{ form_militar.situacao_id(class="form-control") }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            {{ form_militar.funcao_ids_1.label(class="form-control-label") }}
                            {{ form_militar.funcao_ids_1(class="form-control") }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnEnviarFiltros">Filtrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
