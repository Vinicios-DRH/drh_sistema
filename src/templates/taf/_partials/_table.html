{# =========================
_table.html (corrigido)
Agora mostra: VALOR + NOTA por atividade
Espera que o backend envie:
r["<ativ_id>__valor"] e r["<ativ_id>__nota"]
        ========================= #}

        {% macro cell_valor_nota(v, n) -%}
        {% if v %}
        <div class="d-flex flex-column align-items-center gap-1">
            <span class="badge bg-secondary">{{ v }}</span>
            {% if n %}
            <span class="badge bg-light text-dark border">nota: {{ n }}</span>
            {% endif %}
        </div>
        {% else %}
        <span class="text-muted">—</span>
        {% endif %}
        {%- endmacro %}

        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                    <div class="fw-semibold">Resultados</div>
                    <div class="text-muted small">
                        Clique em “Detalhes” para auditoria completa por militar.
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="tafTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-normal" data-bs-toggle="tab"
                            data-bs-target="#pane-normal" type="button" role="tab">
                            Normal
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-especial" data-bs-toggle="tab" data-bs-target="#pane-especial"
                            type="button" role="tab">
                            Especial
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- ================= NORMAL ================= -->
                    <div class="tab-pane fade show active" id="pane-normal" role="tabpanel">
                        <div class="table-responsive">
                            <table id="tafTableNormal" class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Período</th>
                                        <th>Militar</th>
                                        <th>PG</th>
                                        <th>Quadro</th>
                                        <th>OBM</th>
                                        <th class="text-center">Sexo</th>
                                        <th class="text-center">Modalidade</th>

                                        {% for ativ_id in normal_ativs %}
                                        <th class="text-center text-nowrap">{{ ativ_label.get(ativ_id, ativ_id) }}</th>
                                        {% endfor %}

                                        <th class="text-center">Status</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for r in rows %}
                                    <tr>
                                        <td class="text-nowrap">
                                            {{ r.primeira_data }} → {{ r.ultima_data }}
                                        </td>

                                        <td class="fw-semibold">
                                            {{ r.nome }}
                                            <div class="text-muted small">
                                                Lançamentos: {{ r.qtd_lancamentos }}
                                            </div>
                                        </td>

                                        <td class="text-nowrap">{{ r.posto or "-" }}</td>
                                        <td class="text-nowrap">{{ r.quadro or "-" }}</td>
                                        <td class="text-nowrap">{{ r.obm or "-" }}</td>
                                        <td class="text-center">{{ r.sexo or "-" }}</td>
                                        <td class="text-center">{{ r.modalidade or "-" }}</td>

                                        {% for ativ_id in normal_ativs %}
                                        {% set v = r.get(ativ_id ~ '__valor') if r is mapping else attribute(r, ativ_id
                                        ~ '__valor') %}
                                        {% set n = r.get(ativ_id ~ '__nota') if r is mapping else attribute(r, ativ_id ~
                                        '__nota') %}
                                        <td class="text-center">
                                            {{ cell_valor_nota(v, n) }}
                                        </td>
                                        {% endfor %}

                                        <td class="text-center">
                                            {% if r.status == "APTO" %}
                                            <span class="badge bg-success">APTO</span>
                                            {% elif r.status == "INAPTO" %}
                                            <span class="badge bg-danger">INAPTO</span>
                                            {% else %}
                                            <span class="badge bg-secondary">SEM NOTA</span>
                                            {% endif %}
                                        </td>

                                        <td class="text-center">
                                            <a class="btn btn-sm btn-outline-primary"
                                                href="{{ url_for('taf_admin.historico_militar', militar_id=r.militar_id) }}">
                                                <i class="fas fa-magnifying-glass me-1"></i> Detalhes
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>
                        </div>
                    </div>

                    <!-- ================= ESPECIAL ================= -->
                    <div class="tab-pane fade" id="pane-especial" role="tabpanel">
                        <div class="table-responsive">
                            <table id="tafTableEspecial" class="table table-striped table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Período</th>
                                        <th>Militar</th>
                                        <th>PG</th>
                                        <th>Quadro</th>
                                        <th>OBM</th>
                                        <th class="text-center">Sexo</th>
                                        <th class="text-center">Modalidade</th>

                                        {% for ativ_id in especial_ativs %}
                                        <th class="text-center text-nowrap">{{ ativ_label.get(ativ_id, ativ_id) }}</th>
                                        {% endfor %}

                                        <th class="text-center">Status</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for r in rows %}
                                    <tr>
                                        <td class="text-nowrap">
                                            {{ r.primeira_data }} → {{ r.ultima_data }}
                                        </td>

                                        <td class="fw-semibold">
                                            {{ r.nome }}
                                            <div class="text-muted small">
                                                Lançamentos: {{ r.qtd_lancamentos }}
                                            </div>
                                        </td>

                                        <td class="text-nowrap">{{ r.posto or "-" }}</td>
                                        <td class="text-nowrap">{{ r.quadro or "-" }}</td>
                                        <td class="text-nowrap">{{ r.obm or "-" }}</td>
                                        <td class="text-center">{{ r.sexo or "-" }}</td>
                                        <td class="text-center">{{ r.modalidade or "-" }}</td>

                                        {% for ativ_id in especial_ativs %}
                                        {% set v = r.get(ativ_id ~ '__valor') if r is mapping else attribute(r, ativ_id
                                        ~ '__valor') %}
                                        {% set n = r.get(ativ_id ~ '__nota') if r is mapping else attribute(r, ativ_id ~
                                        '__nota') %}
                                        <td class="text-center">
                                            {{ cell_valor_nota(v, n) }}
                                        </td>
                                        {% endfor %}

                                        <td class="text-center">
                                            {% if r.status == "APTO" %}
                                            <span class="badge bg-success">APTO</span>
                                            {% elif r.status == "INAPTO" %}
                                            <span class="badge bg-danger">INAPTO</span>
                                            {% else %}
                                            <span class="badge bg-secondary">SEM NOTA</span>
                                            {% endif %}
                                        </td>

                                        <td class="text-center">
                                            <a class="btn btn-sm btn-outline-primary"
                                                href="{{ url_for('taf_admin.historico_militar', militar_id=r.militar_id) }}">
                                                <i class="fas fa-magnifying-glass me-1"></i> Detalhes
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>

                <!-- Paginação simples -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted small">
                        Página {{ page }} • exibindo {{ rows|length }} de ~{{ total }}
                    </div>

                    <div class="d-flex gap-2">
                        {% if page > 1 %}
                        <a class="btn btn-sm btn-outline-secondary"
                            href="{{ url_for('taf_admin.painel', page=page-1, per_page=per_page, q=q, status=status, obm=obm, modalidade=modalidade, sexo=sexo, dt_ini=dt_ini, dt_fim=dt_fim) }}">
                            <i class="fas fa-chevron-left me-1"></i> Anterior
                        </a>
                        {% endif %}

                        {% if rows|length == per_page %}
                        <a class="btn btn-sm btn-outline-secondary"
                            href="{{ url_for('taf_admin.painel', page=page+1, per_page=per_page, q=q, status=status, obm=obm, modalidade=modalidade, sexo=sexo, dt_ini=dt_ini, dt_fim=dt_fim) }}">
                            Próxima <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>