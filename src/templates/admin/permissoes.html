{# templates/admin/permissoes.html #}
{% extends "admin/base_admin.html" %}

{% block admin_breadcrumbs %}
<a href="{{ url_for('home') }}">Início</a>
<span class="crumb-sep">›</span>
<span>Admin</span>
<span class="crumb-sep">›</span>
<span>Permissões</span>
{% endblock %}

{% block admin_actions %}
{# exemplo: botão de limpar filtros #}
<a class="tb-btn" href="{{ url_for('admin_permissoes.index') }}">
    <i class="fas fa-broom me-2"></i> Limpar
</a>
{% endblock %}

{% block admin_content %}
{# === AQUI VAI O CONTEÚDO ATUAL (tabela, modal, scripts) === #}

<div class="adm-hero mb-3 d-flex align-items-start justify-content-between gap-3" style="background: linear-gradient(135deg, rgba(79,140,255,.16), rgba(255,255,255,.02));
              border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px 18px;">
    <div>
        <h3 class="mb-1" style="font-weight:900;">Permissões de Usuários</h3>
        <div class="adm-muted">Gerencie acessos por código. SUPER USER sempre tem acesso total.</div>
    </div>
    <span class="badge rounded-pill"
        style="background: rgba(79,140,255,.18); border:1px solid rgba(79,140,255,.35); color:#eaf0ff; font-weight:800;">
        Painel
    </span>
</div>

<div class="adm-card mb-3">
    <div class="card-body">
        <form class="row g-2 align-items-end" method="GET" action="{{ url_for('admin_permissoes.index') }}">
            <div class="col-md-6">
                <label class="form-label adm-muted mb-1">Buscar</label>
                <input class="form-control" name="q" value="{{ q }}"
                    style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;border-radius:12px;"
                    placeholder="Nome, CPF ou email...">
            </div>

            <div class="col-md-4">
                <label class="form-label adm-muted mb-1">Permissão</label>
                <select class="form-select" name="codigo"
                    style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;border-radius:12px;">
                    <option value="">Todas</option>
                    {% for p in catalogo %}
                    <option value="{{ p.codigo }}" {% if codigo==p.codigo %}selected{% endif %}>
                        {{ p.nome }} ({{ p.codigo }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 d-grid">
                <button class="btn" style="border-radius:12px;font-weight:900;background:linear-gradient(135deg, rgba(79,140,255,.95), rgba(79,140,255,.65));
                         border:1px solid rgba(79,140,255,.55);color:#fff;">
                    Aplicar
                </button>
            </div>
        </form>
    </div>
</div>

<div class="adm-card">
    <div class="table-responsive">
        <table class="table align-middle mb-0" style="color:#eaf0ff;">
            <thead>
                <tr>
                    <th
                        style="min-width: 280px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                        Usuário</th>
                    <th
                        style="min-width: 200px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                        Função</th>
                    <th
                        style="min-width: 220px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                        Email</th>
                    <th
                        style="min-width: 170px; background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                        CPF</th>
                    <th style="background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                        Permissões</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr style="border-top:1px solid rgba(255,255,255,.08);">
                    <td>
                        <div class="fw-bold">{{ u.nome }}</div>
                        <div class="adm-muted small">ID: {{ u.id }}</div>

                        <button type="button" class="btn btn-sm mt-2 btn-obms"
                            style="border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#eaf0ff;"
                            data-user-id="{{ u.id }}" data-user-nome="{{ u.nome }}">
                            Gerenciar OBMs delegadas
                        </button>
                    </td>

                    <td>
                        <span class="badge text-bg-secondary">
                            {{ u.funcao_user.ocupacao if u.funcao_user else "—" }}
                        </span>
                    </td>

                    <td class="adm-muted">{{ u.email or "—" }}</td>
                    <td class="adm-muted">{{ u.cpf or "—" }}</td>

                    <td>
                        <div class="perm-grid" data-user="{{ u.id }}">
                            {% for p in catalogo %}
                            {% if (not codigo) or (codigo == p.codigo) %}
                            {% set ativo = user_perm.get(u.id, {}).get(p.codigo, False) %}
                            <div class="perm-chip">
                                <div class="perm-chip-main">
                                    <div class="perm-name">{{ p.nome }}</div>
                                    <div class="perm-code">{{ p.codigo }}</div>
                                </div>

                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input perm-toggle" type="checkbox"
                                        data-user-id="{{ u.id }}" data-codigo="{{ p.codigo }}" {% if ativo %}checked{%
                                        endif %}>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>

                        {% if (not codigo) and (catalogo|length > 10) %}
                        <div class="mt-2">
                            <button class="btn btn-sm perm-more"
                                style="border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#eaf0ff;"
                                data-user="{{ u.id }}">
                                Ver mais
                            </button>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card-footer d-flex align-items-center justify-content-between"
        style="border-top:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.02);">
        <div class="adm-muted small">
            Página {{ pagination.page }} de {{ pagination.pages }} — {{ pagination.total }} usuários
        </div>

        <nav>
            <ul class="pagination mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link"
                        style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;"
                        href="{{ url_for('admin_permissoes.index', page=pagination.prev_num, q=q, codigo=codigo) }}">
                        Anterior
                    </a>
                </li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link"
                        style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;"
                        href="{{ url_for('admin_permissoes.index', page=pagination.next_num, q=q, codigo=codigo) }}">
                        Próxima
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

{# Modal mantém como está (só deixa escuro) #}
<div class="modal fade" id="modalObms" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: linear-gradient(135deg, rgba(12,18,32,.98), rgba(10,22,40,.98));
                  border:1px solid rgba(255,255,255,.12); border-radius: 18px; color:#eaf0ff;">
            <div class="modal-header" style="border-bottom:1px solid rgba(255,255,255,.12);">
                <div>
                    <h5 class="modal-title mb-0">OBMs delegadas</h5>
                    <div class="adm-muted small">Usuário: <span id="obmsUserNome"></span></div>
                </div>
                <button type="button" class="btn-close" style="filter:invert(1)" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-md-7">
                        <label class="form-label adm-muted">Adicionar OBM</label>
                        <select class="form-select" id="selectObm"
                            style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;border-radius:12px;"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label adm-muted">Tipo</label>
                        <select class="form-select" id="selectTipo"
                            style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#eaf0ff;border-radius:12px;">
                            <option value="DELEGADO">DELEGADO</option>
                            <option value="SUPERVISAO">SUPERVISÃO</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn" style="border-radius:12px;font-weight:900;background:linear-gradient(135deg, rgba(79,140,255,.95), rgba(79,140,255,.65));
                             border:1px solid rgba(79,140,255,.55);color:#fff;" id="btnAddObm">Adicionar</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0" style="color:#eaf0ff;">
                        <thead>
                            <tr>
                                <th
                                    style="background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                                    OBM</th>
                                <th
                                    style="background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                                    Tipo</th>
                                <th
                                    style="background:rgba(255,255,255,.04); border-bottom:1px solid rgba(255,255,255,.12);">
                                    Status</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyDelegadas"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{# === Seus scripts originais (iguais) === #}
<script>
    (function () {
        const toggles = document.querySelectorAll(".perm-toggle");

        async function postToggle(userId, codigo, ativo) {
            const res = await fetch("{{ url_for('admin_permissoes.toggle') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userId, codigo: codigo, ativo: ativo })
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data.ok) throw new Error(data.error || "Falha ao atualizar permissão.");
            return data;
        }

        toggles.forEach(t => {
            t.addEventListener("change", async (e) => {
                const el = e.currentTarget;
                const userId = el.dataset.userId;
                const codigo = el.dataset.codigo;
                const ativo = el.checked;

                el.disabled = true;
                try { await postToggle(userId, codigo, ativo); }
                catch (err) { el.checked = !ativo; alert(err.message || "Erro ao atualizar."); }
                finally { el.disabled = false; }
            });
        });
    })();
</script>

<script>
    (function () {
        let currentUserId = null;
        let modal = null;

        async function fetchJson(url, opts) {
            const res = await fetch(url, opts);
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.ok === false) throw new Error(data.error || "Erro.");
            return data;
        }

        function renderDelegadas(delegadas) {
            const tb = document.getElementById("tbodyDelegadas");
            tb.innerHTML = "";

            delegadas.forEach(d => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${d.obm_sigla} (ID ${d.obm_id})</td>
            <td><span class="badge text-bg-secondary">${d.tipo}</span></td>
            <td>
              <div class="form-check form-switch m-0">
                <input class="form-check-input obm-toggle" type="checkbox"
                  data-id="${d.id}" ${d.ativo ? "checked" : ""}>
              </div>
            </td>
          `;
                tb.appendChild(tr);
            });

            tb.querySelectorAll(".obm-toggle").forEach(el => {
                el.addEventListener("change", async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const ativo = e.currentTarget.checked;
                    e.currentTarget.disabled = true;
                    try {
                        await fetchJson("{{ url_for('admin_permissoes.toggle_obm_delegada') }}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ id: id, ativo: ativo })
                        });
                    } catch (err) {
                        e.currentTarget.checked = !ativo;
                        alert(err.message);
                    } finally {
                        e.currentTarget.disabled = false;
                    }
                });
            });
        }

        async function openModal(userId, userNome) {
            currentUserId = userId;
            document.getElementById("obmsUserNome").textContent = userNome;

            const data = await fetchJson(`{{ url_for('admin_permissoes.get_obms_user', user_id=0) }}`.replace("/0", `/${userId}`));

            const sel = document.getElementById("selectObm");
            sel.innerHTML = "";
            data.obms.forEach(o => {
                const opt = document.createElement("option");
                opt.value = o.id;
                opt.textContent = `${o.sigla} (ID ${o.id})`;
                sel.appendChild(opt);
            });

            renderDelegadas(data.delegadas);

            if (!modal) modal = new bootstrap.Modal(document.getElementById("modalObms"));
            modal.show();
        }

        document.querySelectorAll(".btn-obms").forEach(btn => {
            btn.addEventListener("click", (e) => {
                openModal(e.currentTarget.dataset.userId, e.currentTarget.dataset.userNome);
            });
        });

        document.getElementById("btnAddObm").addEventListener("click", async () => {
            const obmId = parseInt(document.getElementById("selectObm").value, 10);
            const tipo = document.getElementById("selectTipo").value;

            try {
                await fetchJson("{{ url_for('admin_permissoes.add_obm_delegada') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: currentUserId, obm_id: obmId, tipo: tipo })
                });

                const data = await fetchJson(`{{ url_for('admin_permissoes.get_obms_user', user_id=0) }}`.replace("/0", `/${currentUserId}`));
                renderDelegadas(data.delegadas);

            } catch (err) {
                alert(err.message);
            }
        });

    })();
</script>

{% endblock %}