{% extends "base.html" %}
{% block body %}

<style>
    .page-title {
        font-weight: 600;
        letter-spacing: .2px
    }

    .subtle {
        color: var(--bs-secondary-color)
    }

    .card-soft {
        border: 1px solid var(--bs-border-color);
        border-radius: 16px
    }

    .section-title {
        font-weight: 600;
        font-size: 1rem;
        margin: 0
    }

    .hint {
        font-size: .85rem
    }

    .vinculo-card {
        border: 1px dashed var(--bs-border-color);
        border-radius: 12px;
        padding: 1rem;
        background: var(--bs-body-bg)
    }

    .remove-btn {
        opacity: .8
    }
</style>

<div class="container-xxl py-3 mt-5">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div>
            <h1 class="page-title h4 mb-1">
                Nova Declaração — {{ militar.nome_guerra or militar.nome_completo }}
            </h1>
            <div class="subtle">Preencha a declaração (positiva ou negativa) e anexe o documento assinado.</div>
        </div>
        <a href="{{ url_for('acumulo.lista') }}" class="btn btn-light">← Voltar</a>
    </div>

    <!-- Form -->
    <form method="post" enctype="multipart/form-data" action="" class="needs-validation" novalidate>
        <input type="hidden" name="ano" value="{{ ano }}">

        <!-- Cabeçalho do militar -->
        <div class="card card-soft p-3 mb-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Militar</label>
                    <input class="form-control" value="{{ militar.nome_completo }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Posto/Graduação</label>
                    <input class="form-control" value="{{ posto_grad_sigla or '-' }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">OBM</label>
                    <input class="form-control" value="{{ obm_sigla or '-' }}" readonly>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ano</label>
                    <input class="form-control" value="{{ ano }}" readonly>
                </div>
            </div>
        </div>

        <!-- Tipo + Anexo -->
        <div class="card card-soft p-3 mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Tipo de declaração</label>
                    <select class="form-select" id="tipo-select" name="tipo" required>
                        <option value="" selected disabled>Selecione…</option>
                        <option value="positiva">Positiva (com vínculo)</option>
                        <option value="negativa">Negativa (sem vínculo)</option>
                    </select>
                    <div class="invalid-feedback">Escolha o tipo de declaração.</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Meio de entrega</label>
                    <select class="form-select" name="meio_entrega">
                        <option value="digital" selected>Digital</option>
                        <option value="presencial">Presencial</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Arquivo (somente PDF)</label>
                    <input type="file" class="form-control" name="arquivo_declaracao" accept=".pdf,.jpg,.jpeg,.png"
                        required>
                    <div class="hint subtle mt-1">Envie a declaração assinada (modelo DRH).</div>
                    <div class="invalid-feedback">Anexe o arquivo da declaração.</div>
                </div>

                <div class="col-12">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" name="observacoes" rows="3" placeholder="(opcional)"></textarea>
                </div>
            </div>
        </div>
        <!-- Vínculo externo (único) -->
        <div class="card card-soft p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="section-title">Vínculo externo</h2>
                <div class="subtle">Preencha somente se a declaração for <strong>positiva</strong>.</div>
            </div>

            <div id="vinculo-unique" class="vinculo-card">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Empregador</label>
                        <input class="form-control" name="empregador_nome" maxlength="150">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="empregador_tipo">
                            <option value="" selected disabled>Selecione…</option>
                            <option value="publico">Público</option>
                            <option value="privado">Privado</option>
                            <option value="cooperativa">Cooperativa</option>
                            <option value="autonomo">Autônomo</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">CNPJ/CPF</label>
                        <input class="form-control" name="empregador_doc" pattern="^\d{11}$|^\d{14}$"
                            placeholder="somente dígitos">
                        <div class="invalid-feedback">Informe 11 (CPF) ou 14 (CNPJ) dígitos.</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Natureza do vínculo</label>
                        <select class="form-select" name="natureza_vinculo">
                            <option value="" selected disabled>Selecione…</option>
                            <option value="efetivo">Efetivo</option>
                            <option value="contratado">Contratado</option>
                            <option value="prestacao_servicos">Prestação de serviços</option>
                            <option value="autonomo">Autônomo</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Cargo/Função</label>
                        <input class="form-control" name="cargo_funcao" maxlength="120">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Carga horária semanal (h)</label>
                        <input type="number" class="form-control" name="carga_horaria_semanal" min="1" max="80">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Horário início</label>
                        <input type="time" class="form-control" name="horario_inicio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Horário fim</label>
                        <input type="time" class="form-control" name="horario_fim">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data de início no segundo vínculo</label>
                        <input type="date" class="form-control" name="data_inicio">
                    </div>
                </div>
            </div>
        </div>
        <!-- Ações -->
        <div class="d-flex gap-2">
            <a href="{{ url_for('acumulo.lista') }}" class="btn btn-light">Voltar</a>
            <button class="btn btn-success" type="submit">Salvar</button>

            <button class="btn btn-outline-secondary" type="submit"
                formaction="{{ url_for('acumulo.modelo_docx', militar_id=militar.id) }}" formmethod="post"
                formtarget="_blank" formnovalidate id="btn-docx">
                Gerar modelo preenchido (DOCX)
            </button>

        </div>
    </form>
</div>

<script>
    const tipoSelect = document.getElementById('tipo-select');
    const vinculo = document.getElementById('vinculo-unique');

    function toggleVinculo() {
        const isPositiva = tipoSelect.value === 'positiva';
        // habilita/obriga somente se positiva
        vinculo.querySelectorAll('input, select').forEach(el => {
            el.required = isPositiva;
            el.disabled = !isPositiva;
        });
        // opcional: visualmente "apagar" quando negativa
        vinculo.style.opacity = isPositiva ? 1 : 0.6;
    }

    tipoSelect.addEventListener('change', toggleVinculo);
    toggleVinculo();

    (() => {
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                // quem disparou o submit (botão)
                const submitter = event.submitter || document.activeElement;

                // Se o botão tem formnovalidate, não bloqueia o envio
                const skipValidation =
                    submitter && (submitter.hasAttribute('formnovalidate') ||
                        submitter.dataset.skipValidate === '1');

                if (!skipValidation && !form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // (Opcional) habilitar/desabilitar o botão DOCX conforme o tipo
    const btnDocx = document.getElementById('btn-docx');
    function toggleVinculo() {
        const isPositiva = tipoSelect.value === 'positiva';
        vinculo.querySelectorAll('input, select').forEach(el => {
            el.required = isPositiva;
            el.disabled = !isPositiva;
        });
        vinculo.style.opacity = isPositiva ? 1 : 0.6;
        if (btnDocx) btnDocx.disabled = !isPositiva;   // só gera modelo p/ positiva
    }
</script>

{% endblock %}