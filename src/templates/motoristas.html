{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
  /* ——— Paleta / vidro ——— */
  :root{
    --ink-200:#e8eef6;
    --glass-brd: rgba(255,255,255,.12);
  }

  /* BG gradiente do app */
  body{
    background: linear-gradient(135deg,#0e1726 0%,#0b2e4f 45%,#0b3a63 100%) fixed;
  }

  .page-wrapper{ position: relative; }

  /* Cabeçalho com vidro */
  .brand-header{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border: 1px solid var(--glass-brd);
    border-radius: 16px;
    color: var(--ink-200);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  /* Painel claro “frosted” (conteúdo) */
  .glass-panel{
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.5);
    border-radius: 18px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    color:#111;
  }

  /* Largura total */
  .container-fluid { max-width: 100% !important; }
  .brand-header, .glass-panel { width: 100%; }

  /* Tabela dentro do vidro */
  .table { background: transparent; }
  .table-responsive { overflow-x: auto; }

  /* Cabeçalho sticky e levemente fosco */
  .table thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(255,255,255,.9);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .table-striped > tbody > tr:nth-of-type(odd) > *{
    background-color: rgba(0,0,0,.02);
  }
  .table-hover > tbody > tr:hover > *{
    background-color: rgba(0,0,0,.04);
  }

  /* Evita “aperto” feio nas colunas longas */
  .table th, .table td { white-space: nowrap; }
  @media (max-width: 992px){
    .table th, .table td { white-space: normal; word-break: break-word; }
  }

  /* Inputs e botões do header */
  .input-group .form-control{
    min-width: 260px;
  }

  /* Espaçamento lateral sutil em telas grandes */
  @media (min-width:1200px){
    .container-fluid { padding-left: 1.25rem; padding-right: 1.25rem; }
  }

  /* Modal filtros com visual limpo */
  .filter-card{
    border:1px solid rgba(0,0,0,.06);
    border-radius:14px;
    padding:1rem;
    background:#fff;
  }
  .filter-title{
    font-weight:700;
    font-size:.9rem;
    margin-bottom:.5rem;
  }
  .modal-xl .modal-footer{
    position: sticky; bottom: -1rem; background: #fff; z-index: 2;
  }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4 page-wrapper">
  <div class="container-fluid px-2 px-md-3">

    <!-- Cabeçalho “vidro” com título + ações -->
    <div class="brand-header p-3 p-md-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <!-- Marca + resumo -->
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logobm.png') }}" width="48" height="48" class="rounded" alt="CBMAM">
          <div>
            <h1 class="h5 mb-1">Motoristas</h1>
            <div class="small text-light opacity-75">
              DRH • Sistema CBMAM
              {% if motoristas is defined %}
                • página {{ motoristas.page }}{% if motoristas.pages %}/{{ motoristas.pages }}{% endif %}
                • exibindo {{ motoristas.items|length }} registro(s)
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Ações (busca + filtros) -->
        <form method="GET" action="{{ url_for('motoristas') }}" class="d-flex align-items-stretch flex-wrap gap-2">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="search" class="form-control"
                   placeholder="Buscar por nome..."
                   value="{{ search or '' }}" aria-label="Buscar motorista">
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="bi bi-arrow-return-left me-1"></i> Buscar
          </button>

          {% if search %}
          <a href="{{ url_for('motoristas') }}" class="btn btn-outline-light" title="Limpar busca">
            <i class="bi bi-x-lg"></i>
          </a>
          {% endif %}

          <button type="button" class="btn btn-outline-light" id="btn-filtro"
                  data-bs-toggle="modal" data-bs-target="#filtrarMilitar">
            <i class="bi bi-funnel me-1"></i> Filtros
          </button>
        </form>
      </div>
    </div>

    <!-- Painel de vidro com a tabela + paginação + gráficos -->
    <div class="glass-panel p-3 p-md-4">

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" style="width:100%">
          <thead>
          <tr>
            <th>Nome Completo</th>
            <th>Matrícula</th>
            <th>Posto/Graduação</th>
            <th>Categoria</th>
            <th>Boletim Geral</th>
            <th>SIGED</th>
          </tr>
          </thead>
          <tbody>
          {% for motorista in motoristas.items %}
            <tr>
              <td>
                <a href="{{ url_for('atualizar_motorista', motorista_id=motorista.id) }}">
                  {{ motorista.militar.nome_completo }}
                </a>
              </td>
              <td>{{ motorista.militar.matricula }}</td>
              <td>{{ motorista.militar.posto_grad.sigla }}</td>
              <td>{{ motorista.categoria.sigla }}</td>
              <td>{{ motorista.boletim_geral }}</td>
              <td>{{ motorista.siged }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="bi bi-search"></i> Nenhum motorista encontrado.
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginação -->
      <nav class="d-flex justify-content-center mt-3" aria-label="Paginação">
        <ul class="pagination mb-0">
          {% if motoristas.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('motoristas', page=motoristas.prev_num, search=search) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for page_num in motoristas.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=3) %}
            {% if page_num %}
              <li class="page-item {% if page_num == motoristas.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('motoristas', page=page_num, search=search) }}">{{ page_num }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          {% if motoristas.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('motoristas', page=motoristas.next_num, search=search) }}" aria-label="Próximo">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>

      <!-- Gráficos em painéis de vidro -->
      <div class="row g-3 mt-4">
        <div class="col-lg-4">
          <div class="glass-panel p-3 h-100">
            <h6 class="text-center mb-3">Percentual de Classificados</h6>
            <div id="grafico_motoristas"></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="glass-panel p-3 h-100">
            <h6 class="text-center mb-3">Classificados por Categoria</h6>
            <div id="grafico_categorias"></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="glass-panel p-3 h-100">
            <h6 class="text-center mb-3">Classificados por OBM</h6>
            <div id="grafico_obms"></div>
          </div>
        </div>
      </div>

      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <script>
        Plotly.newPlot('grafico_motoristas', {{ grafico_motoristas|safe }});
        Plotly.newPlot('grafico_categorias', {{ grafico_categorias|safe }});
        Plotly.newPlot('grafico_obms', {{ grafico_obms|safe }});
      </script>

    </div>
  </div>
</section>

<!-- Modal Filtros -->
<div class="modal fade" id="filtrarMilitar" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Filtros Avançados</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-3 p-md-4 p-xl-5">
        <form class="row g-3" id="formFiltros" method="get" action="{{ url_for('motoristas') }}">
          <div class="col-md-4">
            <div class="filter-card">
              <div class="filter-title">OBM</div>
              {{ form_filtro.obm_id(class="form-select") }}
            </div>
          </div>
          <div class="col-md-4">
            <div class="filter-card">
              <div class="filter-title">Posto/Graduação</div>
              {{ form_filtro.posto_grad_id(class="form-select") }}
            </div>
          </div>
          <div class="col-md-4">
            <div class="filter-card">
              <div class="filter-title">Categoria</div>
              {{ form_filtro.categoria_id(class="form-select") }}
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btnEnviarFiltros">Filtrar</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %}
