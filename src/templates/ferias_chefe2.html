{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<style>
  :root {
    --brand-blue-700: #0d2036;
    --brand-blue-600: #0c3761;
  }

  /* Fundo padrão */
  body {
    background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
    min-height: 100vh;
  }

  .page-wrap {
    padding: 18px 10px;
  }

  /* ===== ALERTA FLUTUANTE (na frente da navbar) ===== */
  .alert-stack {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: min(960px, 96vw);
    z-index: 3000;
    /* acima da navbar e dropdowns */
    pointer-events: none;
    /* não bloqueia cliques abaixo */
  }

  .alert-stack .alert {
    pointer-events: auto;
    /* permite clicar no X */
    box-shadow: 0 10px 24px rgba(0, 0, 0, .18);
    border-radius: 12px;
    margin-bottom: 8px;
  }

  /* Card principal (padrão adotado) */
  .glass-card {
    background: rgba(255, 255, 255, .96);
    border: 1px solid rgba(0, 0, 0, .06);
    border-radius: 16px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, .12);
    overflow: hidden;
  }

  /* Cabeçalho com alto contraste */
  .brand-top {
    background: linear-gradient(90deg, var(--brand-blue-700) 0%, var(--brand-blue-600) 100%);
    color: #fff;
    padding: 16px 18px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
  }

  .brand-top h4 {
    margin: 0;
    font-weight: 900;
  }

  .muted {
    opacity: .85;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: end;
    padding: 14px 18px;
    border-bottom: 1px solid rgba(0, 0, 0, .06);
    background: rgba(255, 255, 255, .55);
  }

  .toolbar .grow {
    flex: 1 1 320px;
    min-width: 260px;
  }

  /* Área da tabela */
  .table-wrap {
    padding: 12px 12px 18px;
  }

  @media (min-width: 992px) {
    .table-wrap {
      padding: 18px;
    }
  }

  .table-sticky thead th {
    position: sticky;
    top: 0;
    z-index: 3;
    background: #f8f9fa;
  }
</style>
{% endblock %}

{% block body %}

<!-- ======= ALERTAS SEMPRE NA FRENTE DA NAVBAR ======= -->
<div class="alert-stack" aria-live="polite" aria-atomic="true">
  {% if dia_atual < 10 or dia_atual> 20 %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      ⚠️ As alterações de férias estão disponíveis apenas do dia <b>10</b> ao <b>20</b> de cada mês.
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endif %}

    {% with msgs=get_flashed_messages(with_categories=true) %}
    {% if msgs %}
    {% for category, msg in msgs %}
    {% set cat = category if category in ['primary','secondary','success','danger','warning','info','light','dark'] else
    'info' %}
    <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
      {{ msg|safe }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<div class="container-fluid page-wrap">
  <div class="glass-card">

    <!-- Cabeçalho -->
    <div class="brand-top d-flex align-items-start justify-content-between flex-wrap gap-2">
      <div>
        <h4><i class="bi bi-calendar-week"></i> Gestão de PAFs • CBMAM</h4>
        <div class="muted small">Selecione a OBM para carregar a grade de férias e aplicar alterações.</div>
      </div>
      <span class="badge bg-primary">CBMAM</span>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="grow">
        <label class="form-label small mb-1">Selecione a OBM</label>
        <select id="obmSelect" class="form-select">
          <option value="">— Selecione —</option>
          {% for obm in lista_obms %}
          <option value="{{ obm.id }}">{{ obm.sigla }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="d-flex gap-2 flex-wrap ms-auto">
        <button class="btn btn-success" id="btnGrafico" disabled>
          <i class="bi bi-bar-chart-line"></i> Ver Gráfico
        </button>
      </div>
    </div>

    <!-- Tabela (carregada dinamicamente) -->
    <div class="table-wrap">
      <div id="tabelaContainer"></div>
    </div>
  </div>

  <div class="text-center text-white-50 small mt-3">
    Sistema de Controle de Férias CBMAM &copy; {{ ano_atual }}
  </div>
</div>

<!-- Modal do Gráfico -->
<div class="modal fade" id="modalGrafico" tabindex="-1" aria-labelledby="modalGraficoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalGraficoLabel"><i class="bi bi-bar-chart-line"></i> Gráfico de Férias</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center" id="graficoBody">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Carregando gráfico...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Janela liberada (10..20) OU Super User (id=6)
  window.CAN_EDIT = {{ ((10 <= dia_atual <= 20) or(current_user.funcao_user_id == 6)) | tojson }};
  window.PAF_ANO_VIGENTE = {{ ano_vigente | tojson }};

  // Regras especiais (vindas do backend)
  window.MILITARES_40 = [513, 768, 946, 1, 251, 506, 410, 1026, 356, 798, 702, 463, 387, 888, 902, 948, 749, 612];
  window.MILITARES_20_20 = [513, 768, 946, 1, 251, 506, 410, 1026, 356, 798, 702, 463, 387, 888, 902, 948, 749, 612];

  const CAN_EDIT = Boolean(window.CAN_EDIT);
  const hoje = new Date();
  const ANO_ATUAL = Number(window.PAF_ANO_VIGENTE || new Date().getFullYear());
  const LIMITE_ANO = new Date(ANO_ATUAL, 11, 31);
  const pad = v => String(v).padStart(2, '0');
  const fmtISO = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
  const firstDayNextMonth = () => new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);

  function parseInputDate(s) {
    if (!s) return null;
    const t = String(s).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(t)) { const [y, m, d] = t.split('-').map(Number); return new Date(y, m - 1, d); }
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) { const [d, m, y] = t.split('/').map(Number); return new Date(y, m - 1, d); }
    return null;
  }
  function setMinMax(input, minDate) {
    if (!input || input.type !== 'date') return;
    const min = minDate || firstDayNextMonth();
    input.min = fmtISO(min);
    input.max = fmtISO(LIMITE_ANO);
  }
  function ensureAfterMin(input) {
    if (!input || input.type !== 'date' || !input.min) return true;
    if (input.value && input.value < input.min) {
      alert('Selecione uma data a partir de ' + input.min.split('-').reverse().join('/'));
      input.value = ''; input.focus(); return false;
    }
    return true;
  }

  function getNum(row, name) { return parseInt(row.querySelector(`[name="${name}"]`)?.value || 0, 10); }
  function totals(row, mid) {
    const d1 = getNum(row, `qtd_dias_1_${mid}`);
    const d2 = getNum(row, `qtd_dias_2_${mid}`);
    const d3 = getNum(row, `qtd_dias_3_${mid}`);
    return { d1, d2, d3, total12: d1 + d2, total123: d1 + d2 + d3 };
  }
  function clearPeriodo(row, mid, p) {
    const s = row.querySelector(`[name="qtd_dias_${p}_${mid}"]`);
    const i = row.querySelector(`[name="inicio_${p}_${mid}"]`);
    const f = row.querySelector(`[name="fim_${p}_${mid}"]`);
    if (s) s.value = ''; if (i) i.value = ''; if (f) f.value = '';
  }
  function lockPeriodo(row, mid, p, lock, title = '') {
    ['qtd_dias', 'inicio', 'fim'].forEach(k => {
      const el = row.querySelector(`[name="${k}_${p}_${mid}"]`);
      if (el) { el.disabled = !!lock; el.readOnly = !!lock; el.title = title || ''; }
    });
  }

  function calcularFim(row, mid, p) {
    const i = row.querySelector(`[name="inicio_${p}_${mid}"]`);
    const s = row.querySelector(`[name="qtd_dias_${p}_${mid}"]`);
    const f = row.querySelector(`[name="fim_${p}_${mid}"]`);
    if (!i || !s || !f) return;
    const di = parseInputDate(i.value);
    const n = parseInt(s.value || 0, 10);
    if (!di || !n) { f.value = ''; return; }
    const out = new Date(di.getFullYear(), di.getMonth(), di.getDate() + n - 1);
    if (out.getFullYear() !== ANO_ATUAL || out > LIMITE_ANO) {
      alert('Este período ultrapassa 31/12 do ano atual. Ajuste a data ou a quantidade de dias.');
      clearPeriodo(row, mid, p); return;
    }
    f.value = fmtISO(out);
  }

  function validarSequencia(row, mid) {
    const i1 = parseInputDate(row.querySelector(`[name="inicio_1_${mid}"]`)?.value || '');
    const f1 = parseInputDate(row.querySelector(`[name="fim_1_${mid}"]`)?.value || '');
    const i2 = parseInputDate(row.querySelector(`[name="inicio_2_${mid}"]`)?.value || '');
    const f2 = parseInputDate(row.querySelector(`[name="fim_2_${mid}"]`)?.value || '');
    const i3 = parseInputDate(row.querySelector(`[name="inicio_3_${mid}"]`)?.value || '');
    const f3 = parseInputDate(row.querySelector(`[name="fim_3_${mid}"]`)?.value || '');

    const base2 = f1 || i1;
    if (i2 && base2 && i2 <= base2) { alert('O 2º período não pode começar antes de terminar o 1º.'); clearPeriodo(row, mid, 2); }

    const base3 = (f2 || i2 || f1 || i1);
    if (i3 && base3 && i3 <= base3) { alert('O 3º período não pode começar antes de terminar o período anterior.'); clearPeriodo(row, mid, 3); }

    [['1', f1], ['2', f2], ['3', f3]].forEach(([p, fim]) => {
      if (fim && (fim.getFullYear() !== ANO_ATUAL || fim > LIMITE_ANO)) {
        alert('O término das férias não pode ultrapassar 31/12 do ano atual.');
        clearPeriodo(row, mid, p);
      }
    });
  }

  function aplicarOpcoesSegundo(row, mid, podeTer40, forcar20x20) {
    const dias1 = getNum(row, `qtd_dias_1_${mid}`);
    const sel2 = row.querySelector(`[name="qtd_dias_2_${mid}"]`);
    if (!sel2) return;
    const teto = podeTer40 ? 40 : 30;
    const valores = Array.from(sel2.options).map(o => parseInt(o.value, 10)).filter(n => !isNaN(n));
    let permitidas;
    if (podeTer40 && forcar20x20) { permitidas = (dias1 + 20 <= 40) ? [20] : []; }
    else { permitidas = valores.filter(v => (dias1 + v) <= teto); }
    Array.from(sel2.options).forEach(opt => {
      if (!opt.value) return;
      opt.disabled = !permitidas.includes(parseInt(opt.value, 10));
    });
    const atual = parseInt(sel2.value || 0, 10);
    if (!permitidas.includes(atual)) { sel2.value = ''; clearPeriodo(row, mid, 2); }
  }

  function refreshRow(row) {
    const mid = row.dataset.militarId;
    const midNum = Number(mid);
    const podeTer40 = (row.dataset.podeTer40 === 'true') || (window.MILITARES_40 || []).includes(midNum);
    const forcar20x20 = (window.MILITARES_20_20 || []).includes(midNum);
    const teto = podeTer40 ? 40 : 30;

    if (!CAN_EDIT) { row.querySelectorAll('input,select,button.botao-salvar').forEach(el => el.disabled = true); return; }

    const s1 = row.querySelector(`[name="qtd_dias_1_${mid}"]`);
    const i1 = row.querySelector(`[name="inicio_1_${mid}"]`);
    const f1 = row.querySelector(`[name="fim_1_${mid}"]`);
    const s2 = row.querySelector(`[name="qtd_dias_2_${mid}"]`);
    const i2 = row.querySelector(`[name="inicio_2_${mid}"]`);
    const f2 = row.querySelector(`[name="fim_2_${mid}"]`);
    const s3 = row.querySelector(`[name="qtd_dias_3_${mid}"]`);
    const i3 = row.querySelector(`[name="inicio_3_${mid}"]`);
    const f3 = row.querySelector(`[name="fim_3_${mid}"]`);

    // 1º período
    if (i1) setMinMax(i1, firstDayNextMonth());
    if (f1) f1.disabled = true;
    const v1 = parseInputDate(i1?.value || '');
    if (v1 && v1 < firstDayNextMonth()) {
      lockPeriodo(row, mid, '1', true, 'Período em mês passado/atual (somente leitura)');
    } else {
      if (s1) s1.disabled = false;
      if (i1) i1.disabled = false;
    }
    calcularFim(row, mid, 1);

    const { d1, total12 } = totals(row, mid);

    // 2º período
    const podeUsar2 = d1 > 0 && d1 < teto;
    [s2, i2, f2].forEach(el => { if (el) el.disabled = !podeUsar2; });
    if (podeUsar2) {
      aplicarOpcoesSegundo(row, mid, podeTer40, forcar20x20);
      let min2 = firstDayNextMonth();
      const vf1 = parseInputDate(f1?.value || '');
      if (vf1) {
        const d = new Date(vf1.getFullYear(), vf1.getMonth(), vf1.getDate() + 1);
        if (d > min2) min2 = d;
      }
      if (i2) setMinMax(i2, min2);
      if (f2) f2.disabled = true;
      const v2 = parseInputDate(i2?.value || '');
      if (v2 && v2 < min2) lockPeriodo(row, mid, '2', true, 'Período em mês passado/atual (somente leitura)');
    }
    calcularFim(row, mid, 2);

    // 3º período (não para 20+20)
    const podeUsar3 = !forcar20x20 && total12 < teto;
    [s3, i3, f3].forEach(el => { if (el) el.disabled = !podeUsar3; });
    if (podeUsar3) {
      let min3 = firstDayNextMonth();
      const vf2 = parseInputDate(f2?.value || '');
      const vf1b = parseInputDate(f1?.value || '');
      if (vf2) {
        const d = new Date(vf2.getFullYear(), vf2.getMonth(), vf2.getDate() + 1);
        if (d > min3) min3 = d;
      } else if (vf1b) {
        const d = new Date(vf1b.getFullYear(), vf1b.getMonth(), vf1b.getDate() + 1);
        if (d > min3) min3 = d;
      }
      if (i3) setMinMax(i3, min3);
      if (f3) f3.disabled = true;
      const v3 = parseInputDate(i3?.value || '');
      if (v3 && v3 < min3) lockPeriodo(row, mid, '3', true, 'Período em mês passado/atual (somente leitura)');
    }
    calcularFim(row, mid, 3);

    validarSequencia(row, mid);
  }

  function ligarListenersLinha(row) {
    const mid = row.dataset.militarId;
    ['1', '2', '3'].forEach(p => {
      const s = row.querySelector(`[name="qtd_dias_${p}_${mid}"]`);
      const i = row.querySelector(`[name="inicio_${p}_${mid}"]`);
      if (i) {
        i.addEventListener('change', () => {
          if (!ensureAfterMin(i)) return;
          calcularFim(row, mid, p);
          refreshRow(row);
        });
      }
      if (s) {
        s.addEventListener('change', () => {
          calcularFim(row, mid, p);
          refreshRow(row);
        });
      }
    });

    row.querySelectorAll('.botao-salvar').forEach(btn => {
      btn.addEventListener('click', () => {
        const formData = new URLSearchParams();
        formData.append('militar_id', mid);
        ['mes_usufruto', 'qtd_dias_1', 'inicio_1', 'fim_1', 'qtd_dias_2', 'inicio_2', 'fim_2', 'qtd_dias_3', 'inicio_3', 'fim_3']
          .forEach(c => formData.append(c, row.querySelector(`[name="${c}_${mid}"]`)?.value || ''));
        formData.append('ano_referencia', ANO_ATUAL);
        fetch('/pafs/update', { method: 'POST', body: formData })
          .then(r => r.json()).then(resp => alert(resp.message))
          .catch(() => alert('Erro ao salvar.'));
      });
    });

    refreshRow(row);
  }

  function inicializarListeners() {
    document.querySelectorAll('tr[data-militar-id]').forEach(ligarListenersLinha);
  }

  function getAno() { return ANO_ATUAL; }

  // Carregar tabela por OBM
  document.getElementById('obmSelect').addEventListener('change', function () {
    const obmId = this.value;
    document.getElementById('btnGrafico').disabled = !obmId;
    const alvo = document.getElementById('tabelaContainer');
    if (!obmId) { alvo.innerHTML = ''; return; }

    fetch(`/pafs/tabela/${obmId}?ano=${getAno()}`)
      .then(r => r.text())
      .then(html => {
        alvo.innerHTML = html;

        // Garante classes de estilo padrão na tabela carregada
        const tbl = document.getElementById('militaresTable');
        if (tbl) {
          tbl.classList.add('table', 'table-striped', 'table-bordered', 'align-middle', 'w-100', 'table-sticky');
        }

        // DataTables (se disponível)
        if (typeof $ !== 'undefined' && $.fn && $.fn.dataTable) {
          const t = $('#militaresTable');
          if ($.fn.dataTable.isDataTable(t)) t.DataTable().destroy();
          t.DataTable({
            scrollX: true,
            scrollY: '400px',
            paging: true,
            language: {
              url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/Portuguese.json'
            }
          });
          t.on('draw.dt', () => inicializarListeners());
        }
        inicializarListeners();
      });
  });

  // Modal de gráfico
  document.getElementById('btnGrafico').addEventListener('click', function () {
    const obmId = document.getElementById('obmSelect').value;
    if (!obmId) return;
    const body = document.getElementById('graficoBody');
    body.innerHTML = `<div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando gráfico...</p>`;
    fetch(`/grafico-ferias/${obmId}`)
      .then(r => r.text())
      .then(data => {
        const img = document.createElement('img');
        img.src = 'data:image/png;base64,' + data;
        img.style.maxWidth = '100%';
        body.innerHTML = '';
        body.appendChild(img);
        new bootstrap.Modal(document.getElementById('modalGrafico')).show();
      })
      .catch(() => { body.innerHTML = '<div class="alert alert-danger mb-0">Não foi possível carregar o gráfico.</div>'; });
  });

  // Janela fechada -> trava tudo assim que a tabela for inserida
  if (!CAN_EDIT) {
    const obs = new MutationObserver(() => {
      document.querySelectorAll('#tabelaContainer input, #tabelaContainer select, #tabelaContainer button.botao-salvar')
        .forEach(el => el.disabled = true);
    });
    obs.observe(document.getElementById('tabelaContainer'), { childList: true, subtree: true });
  }
</script>
{% endblock %}