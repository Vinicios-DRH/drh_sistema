{% extends 'base.html' %}

{% block head %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    body {
        background-color: #f4f6f9;
        min-height: 100vh;
    }

    .filtro-container {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
        border-top: 5px solid #002b5c;
    }

    footer {
        background-color: #f8f9fa;
        padding: 15px 0;
        text-align: center;
        border-top: 1px solid #ddd;
        font-size: 0.9rem;
        color: #555;
    }
</style>
{% endblock %}

{% block body %}
<main class="container mt-5">
    <div class="filtro-container">
        {% if dia_atual < 10 or dia_atual> 20 %}
            <div class="alert alert-warning text-center" role="alert">
                ⚠️ As alterações de férias estão disponíveis apenas do dia 10 ao 20 de cada mês.
            </div>
            {% endif %}
            <h4>Gestão de PAFs - CBMAM</h4>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label><strong>Selecione a OBM:</strong></label>
                    <select id="obmSelect" class="form-select">
                        <option value="">-- Selecione --</option>
                        {% for obm in lista_obms %}
                        <option value="{{ obm.id }}">{{ obm.sigla }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-primary" id="btnGrafico" disabled>
                        <i class="bi bi-bar-chart-line"></i> Ver Gráfico
                    </button>
                </div>
            </div>
    </div>

    <div id="tabelaContainer"></div>
</main>

<footer>Sistema de Controle de Férias CBMAM &copy; {{ ano_atual }}</footer>

<script>
    // janela liberada se hoje (no servidor) é 10..20 ou se é o usuário especial (id 6)
    window.CAN_EDIT = {{ ((10 <= dia_atual <= 20) or(current_user.funcao_user_id == 6)) | tojson }};
</script>

<script>
    // use APENAS o flag vindo do servidor
    const CAN_EDIT = Boolean(window.CAN_EDIT);

    // Se não pode editar, trava tudo (como antes)
    if (!CAN_EDIT) {
        document.addEventListener("DOMContentLoaded", () => {
            const observer = new MutationObserver(() => {
                document
                    .querySelectorAll("#tabelaContainer input, #tabelaContainer select, #tabelaContainer button.botao-salvar")
                    .forEach(el => { if (!el.hasAttribute("data-keep-disabled")) el.disabled = true; });
            });
            observer.observe(document.getElementById("tabelaContainer"), { childList: true, subtree: true });
        });
    }

    // Util: travar/soltar linha inteira
    function bloquearLinha(row, bloquear = true) {
        row.querySelectorAll("input, select, button.botao-salvar").forEach(el => {
            if (!el.hasAttribute("data-keep-disabled")) el.disabled = bloquear;
        });
    }

    // ===== utilitários de data =====
    const hoje = new Date();

    function parseInputDate(s) {
        if (!s) return null;
        const t = s.trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(t)) { const [y, m, d] = t.split('-').map(Number); return new Date(y, m - 1, d); }
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) { const [d, m, y] = t.split('/').map(Number); return new Date(y, m - 1, d); }
        return null;
    }

    function isFuturoEstrito(data) {
        if (!data || isNaN(+data)) return false;
        const a = data.getFullYear(), m = data.getMonth() + 1;
        const aNow = hoje.getFullYear(), mNow = hoje.getMonth() + 1;
        return (a > aNow) || (a === aNow && m > mNow);
    }

    function obterMesNumero(nomeMesRaw) {
        if (!nomeMesRaw) return null;
        const nome = String(nomeMesRaw).trim().toLowerCase();
        const mapa = { "janeiro": 1, "fevereiro": 2, "março": 3, "marco": 3, "abril": 4, "maio": 5, "junho": 6, "julho": 7, "agosto": 8, "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12 };
        return mapa[nome] ?? null;
    }

    // soma atual dos dias
    function getTotais(row, militarId) {
        const d1 = parseInt(row.querySelector(`[name="qtd_dias_1_${militarId}"]`)?.value || 0, 10);
        const d2 = parseInt(row.querySelector(`[name="qtd_dias_2_${militarId}"]`)?.value || 0, 10);
        const d3 = parseInt(row.querySelector(`[name="qtd_dias_3_${militarId}"]`)?.value || 0, 10);
        return { d1, d2, d3, total12: d1 + d2, total123: d1 + d2 + d3 };
    }

    // TRAVA dura do 3º período quando 1º+2º já batem o limite
    function travarTerceiroSeBateu(row, militarId, maxDias) {
        const { total12 } = getTotais(row, militarId);
        const diasSel3 = row.querySelector(`[name="qtd_dias_3_${militarId}"]`);
        const ini3 = row.querySelector(`[name="inicio_3_${militarId}"]`);
        const fim3 = row.querySelector(`[name="fim_3_${militarId}"]`);

        if (total12 >= maxDias) {
            if (diasSel3) { diasSel3.value = ''; diasSel3.disabled = true; }
            if (ini3) { ini3.value = ''; ini3.disabled = true; }
            if (fim3) { fim3.value = ''; fim3.disabled = true; }
            return true; // ficou bloqueado
        }
        return false;
    }

    // ===== bloqueio/habilitação por período =====
    function bloquearPeriodo(row, militarId, periodo, bloquear) {
        const diasSel = row.querySelector(`[name="qtd_dias_${periodo}_${militarId}"]`);
        const inicio = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
        const fim = row.querySelector(`[name="fim_${periodo}_${militarId}"]`);
        [diasSel, inicio, fim].forEach(el => { if (el) el.disabled = !!bloquear; });
    }

    // regra central: só habilita por data se for futuro ESTRITO; PRIORIDADE: teto de dias
    function aplicarRegraPeriodo(row, militarId, periodo, maxDias) {
        // prioridade: se é o 3º, nunca reabilite quando 1º+2º >= maxDias
        if (periodo === "3" && travarTerceiroSeBateu(row, militarId, maxDias)) {
            return true; // está bloqueado
        }

        // 1) tenta pela data de início do período
        const inicioVal = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`)?.value || "";
        const dtInicio = parseInputDate(inicioVal);
        let habilitar = false;

        if (dtInicio) {
            habilitar = isFuturoEstrito(dtInicio);
        } else {
            // 2) fallback: usa "Mês Usufruto" + ano (deduzido do início_1 se existir; senão ano atual)
            const mesSel = row.querySelector(`[name="mes_usufruto_${militarId}"]`)?.value;
            const mesNum = obterMesNumero(mesSel);
            let anoBase = hoje.getFullYear();
            const inicio1 = row.querySelector(`[name="inicio_1_${militarId}"]`)?.value;
            const dt1 = parseInputDate(inicio1);
            if (dt1) anoBase = dt1.getFullYear();

            if (mesNum) {
                const dtRef = new Date(anoBase, mesNum - 1, 1);
                habilitar = isFuturoEstrito(dtRef);
            } else {
                habilitar = false;
            }
        }

        bloquearPeriodo(row, militarId, periodo, !habilitar);
        return !habilitar; // true = bloqueado
    }

    function ativarListenersPeriodo(row, militarId, periodo, maxDias, atualizarCampos) {
        const diasInput = row.querySelector(`[name="qtd_dias_${periodo}_${militarId}"]`);
        const inicioInput = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`);

        if (inicioInput) {
            inicioInput.addEventListener('change', () => {
                aplicarRegraPeriodo(row, militarId, periodo, maxDias);
                if (periodo === "2") aplicarRegraPeriodo(row, militarId, "3", maxDias);
                calcularFim(row, militarId, periodo);
            });
        }

        if (diasInput) {
            diasInput.addEventListener('change', () => {
                atualizarCampos(); // recalcula opcoes e estados
                if (periodo === "2") aplicarRegraPeriodo(row, militarId, "3", maxDias);
                calcularFim(row, militarId, periodo);
            });
        }
    }

    function ligarListenerMesUsufruto(row, militarId, maxDias, atualizarCampos) {
        const mesSelect = row.querySelector(`[name="mes_usufruto_${militarId}"]`);
        if (!mesSelect) return;
        mesSelect.addEventListener('change', () => {
            ["1", "2", "3"].forEach(p => aplicarRegraPeriodo(row, militarId, p, maxDias));
            ["1", "2", "3"].forEach(p => calcularFim(row, militarId, p));
        });
    }

    // calcula o fim quando permitido
    function calcularFim(row, militarId, periodo) {
        const inicio = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
        const dias = row.querySelector(`[name="qtd_dias_${periodo}_${militarId}"]`);
        const fim = row.querySelector(`[name="fim_${periodo}_${militarId}"]`);
        if (!inicio || !dias || !fim) return;

        const dt = parseInputDate(inicio.value);
        const n = parseInt(dias.value || 0, 10);
        if (!dt || !n) return;
        if (!isFuturoEstrito(dt)) return;

        const out = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate() + n - 1);
        const pad = v => String(v).padStart(2, '0');
        if (fim.type === 'date') fim.value = `${out.getFullYear()}-${pad(out.getMonth() + 1)}-${pad(out.getDate())}`;
        else fim.value = `${pad(out.getDate())}/${pad(out.getMonth() + 1)}/${out.getFullYear()}`;
    }

    // ===== inicialização por linha =====
    function inicializarListeners() {
        document.querySelectorAll("tr[data-militar-id]").forEach(row => {
            const militarId = row.dataset.militarId;
            const podeTer40 = row.dataset.podeTer40 === 'true';
            const maxDias = podeTer40 ? 40 : 30;

            if (!CAN_EDIT) { bloquearLinha(row, true); return; }

            // --- função local que recalcula opções dos períodos 2/3 e aplica o teto ---
            function atualizarCampos() {
                const dias1 = parseInt(row.querySelector(`[name="qtd_dias_1_${militarId}"]`).value || 0);
                const dias2Select = row.querySelector(`[name="qtd_dias_2_${militarId}"]`);
                const dias2 = parseInt(dias2Select?.value || 0);
                const dias3Select = row.querySelector(`[name="qtd_dias_3_${militarId}"]`);

                // Liberação do 2º período (mesma regra que você já tinha)
                let opcoesSegundo = [];
                if (podeTer40) {
                    if (dias1 === 20) opcoesSegundo = [10];
                    else if (dias1 === 10) opcoesSegundo = [20];
                    else opcoesSegundo = [10, 20].filter(x => dias1 + x <= 40);
                } else {
                    if (dias1 === 20) opcoesSegundo = [10, 20].filter(x => dias1 + x <= 30);
                    else if (dias1 === 15) opcoesSegundo = [15];
                    else if (dias1 === 10) opcoesSegundo = [10, 15, 20].filter(x => dias1 + x <= 30);
                    else opcoesSegundo = [10, 15, 20, 30].filter(x => dias1 + x <= 30);
                }

                function atualizarSelect(select, opcoesPermitidas) {
                    if (!select) return;
                    Array.from(select.options).forEach(opt => {
                        if (!opt.value) return;
                        opt.disabled = !opcoesPermitidas.includes(parseInt(opt.value, 10));
                    });
                    // habilita o select se houver alguma opção válida (o bloqueio por data ainda se aplica)
                    select.disabled = opcoesPermitidas.length === 0 ? true : select.disabled;
                }
                atualizarSelect(dias2Select, opcoesSegundo);

                if (!opcoesSegundo.includes(dias2)) {
                    if (dias2Select) dias2Select.value = '';
                    limparDatas(militarId, 2);
                    if (dias3Select) dias3Select.value = '';
                    limparDatas(militarId, 3);
                }

                // Se 1º+2º bateu o teto → trava 3º na marra
                travarTerceiroSeBateu(row, militarId, maxDias);
            }

            function limparDatas(militarId, periodo) {
                const i = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
                const f = row.querySelector(`[name="fim_${periodo}_${militarId}"]`);
                if (i) i.value = '';
                if (f) f.value = '';
            }

            // aplica bloqueio/habilitação por período já na carga
            ["1", "2", "3"].forEach(p => aplicarRegraPeriodo(row, militarId, p, maxDias));
            // listeners dos períodos e do mês usufruto
            ["1", "2", "3"].forEach(p => ativarListenersPeriodo(row, militarId, p, maxDias, atualizarCampos));
            ligarListenerMesUsufruto(row, militarId, maxDias, atualizarCampos);

            // revalida datas já preenchidas (mês passado/atual trava)
            ["1", "2", "3"].forEach(p => calcularFim(row, militarId, p));

            // mudanças no 1º período devem repercutir nos demais
            const dias1Input = row.querySelector(`[name="qtd_dias_1_${militarId}"]`);
            const inicio1Input = row.querySelector(`[name="inicio_1_${militarId}"]`);
            const refreshDepoisDoPrimeiro = () => {
                atualizarCampos();
                aplicarRegraPeriodo(row, militarId, "2", maxDias);
                aplicarRegraPeriodo(row, militarId, "3", maxDias);
            };
            if (dias1Input) dias1Input.addEventListener('change', refreshDepoisDoPrimeiro);
            if (inicio1Input) inicio1Input.addEventListener('change', refreshDepoisDoPrimeiro);

            // garantia extra na carga
            atualizarCampos();
            travarTerceiroSeBateu(row, militarId, maxDias);
        });

        // Botões salvar (fora do foreach das linhas)
        document.querySelectorAll(".botao-salvar").forEach(botao => {
            botao.addEventListener("click", () => {
                const militarId = botao.dataset.militarId;
                const formData = new URLSearchParams();
                formData.append("militar_id", militarId);
                ["mes_usufruto", "qtd_dias_1", "inicio_1", "fim_1", "qtd_dias_2", "inicio_2", "fim_2", "qtd_dias_3", "inicio_3", "fim_3"]
                    .forEach(campo => formData.append(campo, document.querySelector(`[name="${campo}_${militarId}"]`).value));
                fetch("/pafs/update", { method: "POST", body: formData })
                    .then(res => res.json()).then(resp => alert(resp.message)).catch(() => alert("Erro ao salvar."));
            });
        });
    }

    // === OBM → carrega tabela e liga tudo
    document.getElementById("obmSelect").addEventListener("change", function () {
        const obmId = this.value;
        document.getElementById("btnGrafico").disabled = !obmId;
        if (!obmId) { document.getElementById("tabelaContainer").innerHTML = ""; return; }

        fetch(`/pafs/tabela/${obmId}`)
            .then(r => r.text())
            .then(html => {
                document.getElementById("tabelaContainer").innerHTML = html;
                $('#militaresTable').DataTable({
                    scrollX: true, scrollY: "400px", paging: true,
                    language: { search: "Pesquisar:", lengthMenu: "Mostrar _MENU_ registros", info: "Mostrando _START_ a _END_ de _TOTAL_ registros", paginate: { previous: "Anterior", next: "Próximo" } }
                });
                inicializarListeners();
                $('#militaresTable').on('draw.dt', function () { inicializarListeners(); });
            });
    });

    // Gráfico (inalterado)
    document.getElementById("btnGrafico").addEventListener("click", function () {
        const obmId = document.getElementById("obmSelect").value;
        fetch(`/grafico-ferias/${obmId}`)
            .then(r => r.text())
            .then(data => {
                document.getElementById("grafico-img").src = 'data:image/png;base64,' + data;
                document.getElementById("graficoModal").style.display = "block";
            });
    });
</script>

{% endblock %}