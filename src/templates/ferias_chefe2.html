{% extends 'base.html' %}

{% block head %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    body {
        background-color: #f4f6f9;
        min-height: 100vh;
    }

    .filtro-container {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        margin-bottom: 20px;
        border-top: 5px solid #002b5c;
    }

    footer {
        background-color: #f8f9fa;
        padding: 15px 0;
        text-align: center;
        border-top: 1px solid #ddd;
        font-size: 0.9rem;
        color: #555;
    }
</style>
{% endblock %}

{% block body %}
<main class="container mt-5">
    <div class="filtro-container">
        {% if dia_atual < 10 or dia_atual> 20 %}
            <div class="alert alert-warning text-center" role="alert">
                ‚ö†Ô∏è As altera√ß√µes de f√©rias est√£o dispon√≠veis apenas do dia 10 ao 20 de cada m√™s.
            </div>
            {% endif %}
            <h4>Gest√£o de PAFs - CBMAM</h4>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label><strong>Selecione a OBM:</strong></label>
                    <select id="obmSelect" class="form-select">
                        <option value="">-- Selecione --</option>
                        {% for obm in lista_obms %}
                        <option value="{{ obm.id }}">{{ obm.sigla }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-primary" id="btnGrafico" disabled>
                        <i class="bi bi-bar-chart-line"></i> Ver Gr√°fico
                    </button>
                </div>
            </div>
    </div>

    <div id="tabelaContainer"></div>
</main>

<footer>Sistema de Controle de F√©rias CBMAM &copy; {{ ano_atual }}</footer>

<script>
    const hoje = new Date();
    const diaAtual = hoje.getDate();
    const dentroDoPeriodo = diaAtual >= 10 && diaAtual <= 20; // true entre 10 e 20

    const foraDoPeriodo = diaAtual < 10 || diaAtual > 20;

    if (foraDoPeriodo) {
        document.addEventListener("DOMContentLoaded", () => {
            // Desativa todos os inputs e selects da tabela (ap√≥s carregamento da tabela)
            const observer = new MutationObserver(() => {
                document.querySelectorAll("#tabelaContainer input, #tabelaContainer select, #tabelaContainer button.botao-salvar").forEach(el => {
                    if (!el.hasAttribute("data-keep-disabled")) {
                        el.disabled = true;
                    }
                });
            });

            observer.observe(document.getElementById("tabelaContainer"), {
                childList: true,
                subtree: true
            });
        });
    }

    // Ao selecionar OBM
    document.getElementById("obmSelect").addEventListener("change", function () {
        const obmId = this.value;
        document.getElementById("btnGrafico").disabled = !obmId;

        if (!obmId) {
            document.getElementById("tabelaContainer").innerHTML = "";
            return;
        }

        fetch(`/pafs/tabela/${obmId}`)
            .then(r => r.text())
            .then(html => {
                document.getElementById("tabelaContainer").innerHTML = html;
                $('#militaresTable').DataTable({
                    scrollX: true, scrollY: "400px", paging: true,
                    language: { search: "Pesquisar:", lengthMenu: "Mostrar _MENU_ registros", info: "Mostrando _START_ a _END_ de _TOTAL_ registros", paginate: { previous: "Anterior", next: "Pr√≥ximo" } }
                });
                inicializarListeners();  // <- Importante: chama o script de controle ap√≥s carregar tabela

                // üëá Garante reexecu√ß√£o ap√≥s pagina√ß√£o, filtro, etc
                $('#militaresTable').on('draw.dt', function () {
                    inicializarListeners();
                });
            });
    });

    // Ao clicar no gr√°fico
    document.getElementById("btnGrafico").addEventListener("click", function () {
        const obmId = document.getElementById("obmSelect").value;
        fetch(`/grafico-ferias/${obmId}`)
            .then(r => r.text())
            .then(data => {
                document.getElementById("grafico-img").src = 'data:image/png;base64,' + data;
                document.getElementById("graficoModal").style.display = "block";
            });
    });

    function atualizarBotaoSalvar(militarId, maxDias) {
        const btnSalvar = document.querySelector(`button.botao-salvar[data-militar-id="${militarId}"]`);
        const dias1 = parseInt(document.querySelector(`[name="qtd_dias_1_${militarId}"]`).value || 0);
        const dias2 = parseInt(document.querySelector(`[name="qtd_dias_2_${militarId}"]`).value || 0);
        const dias3 = parseInt(document.querySelector(`[name="qtd_dias_3_${militarId}"]`).value || 0);

        const total = dias1 + dias2 + dias3;
        // Bot√£o habilita s√≥ se total > 0 e <= maxDias
        btnSalvar.disabled = (total > maxDias || total === 0 || total < 10);
    }

    function bloquearLinha(row, bloquear = true) {
        row.querySelectorAll("input, select, button.botao-salvar").forEach(el => {
            if (!el.hasAttribute("data-keep-disabled")) el.disabled = bloquear;
        });
    }

    function obterMesNumero(nomeMesRaw) {
        if (!nomeMesRaw) return null;
        const nomeMes = String(nomeMesRaw).trim().toLowerCase();
        const mapa = {
            "janeiro": 1, "fevereiro": 2, "mar√ßo": 3, "marco": 3, "abril": 4, "maio": 5, "junho": 6,
            "julho": 7, "agosto": 8, "setembro": 9, "outubro": 10, "novembro": 11, "dezembro": 12
        };
        return mapa[nomeMes] ?? null;
    }

    // L√™ m√™s do select e ano do in√≠cio_1 aceitando 'YYYY-MM-DD' OU 'dd/mm/YYYY'
    function resolverAnoMesUsufruto(militarId) {
        const mesSelect = document.querySelector(`[name="mes_usufruto_${militarId}"]`);
        const mesUsuf = obterMesNumero(mesSelect ? mesSelect.value : null);

        let anoUsuf = null;
        const inicio1 = document.querySelector(`[name="inicio_1_${militarId}"]`);
        if (inicio1 && inicio1.value) {
            const v = inicio1.value.trim();
            if (v.includes("-")) {
                const y = parseInt(v.split("-")[0], 10);          // YYYY-MM-DD
                if (!Number.isNaN(y)) anoUsuf = y;
            } else if (v.includes("/")) {
                const y = parseInt(v.split("/")[2], 10);          // dd/mm/YYYY
                if (!Number.isNaN(y)) anoUsuf = y;
            }
        }
        if (!anoUsuf) anoUsuf = (new Date()).getFullYear();
        return { ano: anoUsuf, mes: mesUsuf };
    }

    function deveBloquearPorMes(anoUsuf, mesUsuf) {
        const hoje = new Date();
        const anoAtual = hoje.getFullYear();
        const mesAtual = hoje.getMonth() + 1;

        if (anoUsuf < anoAtual) return true;                           // anos passados
        if (anoUsuf === anoAtual && mesUsuf !== null && mesUsuf <= mesAtual) return true; // m√™s atual/anteriores
        return false;                                                  // meses seguintes
    }

    function parseInputDate(str) {
        if (!str) return null;
        const s = str.trim();

        // YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            const [y, m, d] = s.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        // dd/mm/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
            const [d, m, y] = s.split('/').map(Number);
            return new Date(y, m - 1, d);
        }

        return null; // formato desconhecido
    }

    function formatISO(d) {
        // para salvar no input tipo date, se usar esse formato
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function isAtualOuAnterior(data) {
        if (!data || isNaN(+data)) return false; // sem data -> n√£o bloqueia
        const ano = data.getFullYear();
        const mes = data.getMonth() + 1;

        const anoAtual = hoje.getFullYear();
        const mesAtual = hoje.getMonth() + 1;

        if (ano < anoAtual) return true;
        if (ano === anoAtual && mes <= mesAtual) return true;
        return false;
    }

    function bloquearPeriodo(row, militarId, periodo, bloquear) {
        const diasSel = row.querySelector(`[name="qtd_dias_${periodo}_${militarId}"]`);
        const inicioInp = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
        const fimInp = row.querySelector(`[name="fim_${periodo}_${militarId}"]`);
        [diasSel, inicioInp, fimInp].forEach(el => { if (el) el.disabled = !!bloquear; });
    }

    function aplicarRegraPeriodo(row, militarId, periodo) {
        const inicioVal = row.querySelector(`[name="inicio_${periodo}_${militarId}"]`)?.value || "";
        const dataInicio = parseInputDate(inicioVal);
        const bloquear = isAtualOuAnterior(dataInicio);
        bloquearPeriodo(row, militarId, periodo, bloquear);
        return bloquear;
    }

    function inicializarListeners() {
        document.querySelectorAll("tr[data-militar-id]").forEach(row => {
            const militarId = row.dataset.militarId;
            const podeTer40 = row.dataset.podeTer40 === 'true';
            const maxDias = podeTer40 ? 40 : 30;

            // ===== Regra global (fora do per√≠odo 10‚Äì20) =====
            if (!dentroDoPeriodo) {
                bloquearLinha(row, true);
                return; // n√£o anexa listeners quando tudo est√° travado
            }

            // ===== Dentro do per√≠odo 10‚Äì20: trava/libera por PER√çODO conforme a data de IN√çCIO =====
            ["1", "2", "3"].forEach(p => aplicarRegraPeriodo(row, militarId, p));

            // Quando o usu√°rio alterar a data de IN√çCIO, reaplicar a regra naquele per√≠odo
            ["1", "2", "3"].forEach(p => {
                const inicioInp = row.querySelector(`[name="inicio_${p}_${militarId}"]`);
                if (inicioInp) {
                    inicioInp.addEventListener('change', () => {
                        aplicarRegraPeriodo(row, militarId, p);
                    });
                }
            });
            // ===================== SUA L√ìGICA EXISTENTE =====================

            function atualizarCampos() {
                const dias1 = parseInt(document.querySelector(`[name="qtd_dias_1_${militarId}"]`).value || 0);
                const dias2Select = document.querySelector(`[name="qtd_dias_2_${militarId}"]`);
                const dias2 = parseInt(dias2Select.value || 0);
                const dias3Select = document.querySelector(`[name="qtd_dias_3_${militarId}"]`);

                // Libera√ß√£o do 2¬∫ per√≠odo:
                let opcoesSegundo = [];
                if (podeTer40) {
                    if (dias1 === 20) opcoesSegundo = [10];
                    else if (dias1 === 10) opcoesSegundo = [20];
                    else opcoesSegundo = [10, 20].filter(x => dias1 + x <= 40);
                } else {
                    if (dias1 === 20) opcoesSegundo = [10, 20].filter(x => dias1 + x <= 30);
                    else if (dias1 === 15) opcoesSegundo = [15];
                    else if (dias1 === 10) opcoesSegundo = [10, 15, 20].filter(x => dias1 + x <= 30);
                    else opcoesSegundo = [10, 15, 20, 30].filter(x => dias1 + x <= 30);
                }

                atualizarSelect(dias2Select, opcoesSegundo);

                if (!opcoesSegundo.includes(dias2)) {
                    dias2Select.value = ''; limparDatas(militarId, 2);
                    dias3Select.value = ''; limparDatas(militarId, 3);
                }

                const total = dias1 + dias2;
                if (total >= maxDias) {
                    // Desabilita o 3¬∫ per√≠odo, limpa seus campos
                    dias3Select.value = '';
                    dias3Select.disabled = true;
                    limparDatas(militarId, 3);

                    // Desabilita tamb√©m campos de data do 3¬∫ per√≠odo
                    const inicio3 = document.querySelector(`[name="inicio_3_${militarId}"]`);
                    const fim3 = document.querySelector(`[name="fim_3_${militarId}"]`);
                    if (inicio3) inicio3.disabled = true;
                    if (fim3) fim3.disabled = true;
                } else {
                    // Habilita campos do 3¬∫ per√≠odo
                    dias3Select.disabled = false;
                    const inicio3 = document.querySelector(`[name="inicio_3_${militarId}"]`);
                    const fim3 = document.querySelector(`[name="fim_3_${militarId}"]`);
                    if (inicio3) inicio3.disabled = false;
                    if (fim3) fim3.disabled = false;
                }
            }

            function calcularFim(periodo) {
                const inicioInput = document.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
                const diasInput = document.querySelector(`[name="qtd_dias_${periodo}_${militarId}"]`);
                const fimInput = document.querySelector(`[name="fim_${periodo}_${militarId}"]`);

                const inicioStr = inicioInput.value;
                const dias = parseInt(diasInput.value || 0, 10);

                const dataInicio = parseInputDate(inicioStr);
                if (!dataInicio || !dias) { fimInput.value = ''; return; }

                // Se o in√≠cio √© m√™s atual/anteriores, mant√©m bloqueado e n√£o calcula
                if (isAtualOuAnterior(dataInicio)) { fimInput.value = ''; aplicarRegraPeriodo(document, militarId, periodo); return; }

                // Calcula fim (mantendo formato dd/mm/YYYY ‚Äì ajuste se seu input for type="date")
                const fim = new Date(dataInicio.getFullYear(), dataInicio.getMonth(), dataInicio.getDate() + dias - 1);
                const dd = String(fim.getDate()).padStart(2, '0');
                const mm = String(fim.getMonth() + 1).padStart(2, '0');
                const yyyy = fim.getFullYear();
                fimInput.value = `${dd}/${mm}/${yyyy}`;
            }

            ["1", "2", "3"].forEach(periodo => {
                const inicioInput = document.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
                const fimInput = document.querySelector(`[name="fim_${periodo}_${militarId}"]`);
                if (inicioInput && inicioInput.value) {
                    const dataInicio = parseInputDate(inicioInput.value);
                    const deveBloquear = isAtualOuAnterior(dataInicio);
                    inicioInput.disabled = deveBloquear;
                    if (fimInput) fimInput.disabled = deveBloquear;
                }
            });

            function atualizarSelect(select, opcoesPermitidas) {
                Array.from(select.options).forEach(opt => {
                    if (!opt.value) return;
                    opt.disabled = !opcoesPermitidas.includes(parseInt(opt.value));
                });
                select.disabled = false;
            }

            function limparDatas(militarId, periodo) {
                document.querySelector(`[name="inicio_${periodo}_${militarId}"]`).value = '';
                document.querySelector(`[name="fim_${periodo}_${militarId}"]`).value = '';
            }

            // Revalida√ß√£o inicial (se j√° houver datas)
            ["1", "2", "3"].forEach(periodo => {
                const inicioInput = document.querySelector(`[name="inicio_${periodo}_${militarId}"]`);
                const fimInput = document.querySelector(`[name="fim_${periodo}_${militarId}"]`);
                if (inicioInput && inicioInput.value) {
                    const dataInicio = parseInputDate(inicioInput.value);
                    let deveBloquear = false;
                    if (dataInicio) {
                        const anoInicio = dataInicio.getFullYear();
                        const mesInicio = dataInicio.getMonth() + 1; // 1‚Äì12
                        const anoAtual = hoje.getFullYear();
                        const mesAtual = hoje.getMonth() + 1;

                        if (anoInicio < anoAtual) deveBloquear = true;
                        else if (anoInicio === anoAtual && mesInicio <= mesAtual) deveBloquear = true;
                    }
                    inicioInput.disabled = deveBloquear;
                    fimInput.disabled = deveBloquear;
                }
            });

            atualizarCampos();
            atualizarBotaoSalvar(militarId, maxDias);
        });

        // Bot√µes salvar (fora do foreach das linhas)
        document.querySelectorAll(".botao-salvar").forEach(botao => {
            botao.addEventListener("click", () => {
                const militarId = botao.dataset.militarId;
                const formData = new URLSearchParams();
                formData.append("militar_id", militarId);
                ["mes_usufruto", "qtd_dias_1", "inicio_1", "fim_1", "qtd_dias_2", "inicio_2", "fim_2", "qtd_dias_3", "inicio_3", "fim_3"]
                    .forEach(campo => {
                        formData.append(campo, document.querySelector(`[name="${campo}_${militarId}"]`).value);
                    });
                fetch("/pafs/update", { method: "POST", body: formData })
                    .then(res => res.json()).then(resp => alert(resp.message)).catch(() => alert("Erro ao salvar."));
            });
        });
    }

</script>

{% endblock %}