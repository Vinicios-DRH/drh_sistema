{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  :root{ --brand-red:#B5121B; --brand-red-600:#9e1119; --glass-bg:rgba(255,255,255,.06); --glass-brd:rgba(255,255,255,.16); --ink-200:#e8eef6; --ink-400:#c0cfda; }
  body{background:linear-gradient(135deg,#0e1726 0%,#0b2e4f 45%,#0b3a63 100%) fixed;}
  .brand-header{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid var(--glass-brd);border-radius:16px;color:var(--ink-200);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(0,0,0,.35);}
  .glass-card{background:var(--glass-bg);border:1px solid var(--glass-brd);border-radius:16px;color:var(--ink-200);box-shadow:0 10px 30px rgba(0,0,0,.35);}
  .btn-primary{background:var(--brand-red);border-color:var(--brand-red);} .btn-primary:hover{background:var(--brand-red-600);border-color:var(--brand-red-600);}
  .small-muted{color:#94a3b8;}
  .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .6rem;font-size:.78rem;border-radius:999px;border:1px solid var(--glass-brd);background:rgba(255,255,255,.06)}
  .table thead th{color:#cbd5e1;font-weight:600;border-color:rgba(255,255,255,.14)}
  .table td,.table th{color:#e5eef9;border-color:rgba(255,255,255,.08)}

  /* modal minimal no padrão dos outros */
  .modal-backdrop-custom{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1050}
  .modal-backdrop-custom.show{display:flex}
  .modal-card{background:#fff;color:#111;border-radius:12px;max-width:560px;width:96vw;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid rgba(0,0,0,.08)}
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
  <div class="container-xxl">

    <!-- Cabeçalho -->
    <div class="brand-header p-3 p-md-4 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded" alt="CBMAM">
          <div>
            <h1 class="h5 m-0">Meus PAFs — {{ ano }}</h1>
            <div class="small opacity-75">
              {% if militar %}{{ militar.nome_completo }}{% else %}Usuário{% endif %}
              {% if posto_grad_sigla|default('') %} · PG: {{ posto_grad_sigla }}{% endif %}
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-light" href="{{ url_for('home_atualizacao') }}"><i class="bi bi-arrow-left"></i> Voltar</a>
          <!-- mantém como link, mas o JS intercepta se já enviou -->
          <a class="btn btn-primary" id="btn-novo-paf" href="{{ url_for('paf.novo', ano=ano) }}">
            <i class="bi bi-plus-lg me-1"></i> Novo PAF
          </a>
        </div>
      </div>
    </div>

    {% set meses_full = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"] %}
    {% macro mes_nome(v) -%}
      {%- if v is not none and (v|string)|int >= 1 and (v|string)|int <= 12 -%}
        {{ meses_full[(v|string)|int - 1] }}
      {%- elif v -%}
        {{ v }}
      {%- else -%}
        —
      {%- endif -%}
    {%- endmacro %}

    {% set badge_cls = {
      'pendente': 'badge text-bg-warning text-dark',
      'aguardando': 'badge text-bg-warning text-dark',
      'em_analise': 'badge text-bg-info',
      'aprovado': 'badge text-bg-success',
      'validado': 'badge text-bg-success',
      'indeferido': 'badge text-bg-danger',
      'definido': 'badge text-bg-primary'
    } %}

    <!-- Lista -->
    <div class="glass-card p-3 p-md-4">
      {% if pafs %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width:80px">#</th>
                <th>Opções escolhidas</th>
                <th style="width:160px">Status</th>
                <th style="width:220px">Mês definido</th>
                <th style="width:200px">Atualizado</th>
              </tr>
            </thead>
            <tbody>
              {% for p in pafs %}
              {% set st = (p.status or '')|lower %}
              <tr>
                <td class="text-muted">#{{ p.id }}</td>
                <td>
                  <span class="chip">{{ mes_nome(p.opcao_1) }}</span>
                  <span class="chip">{{ mes_nome(p.opcao_2) }}</span>
                  <span class="chip">{{ mes_nome(p.opcao_3) }}</span>
                </td>
                <td><span class="{{ badge_cls.get(st, 'badge text-bg-secondary') }}">{{ p.status or '—' }}</span></td>
                <td>
                  {% if p.mes_definido %}
                    <span class="chip"><i class="bi bi-check2-circle me-1"></i>{{ mes_nome(p.mes_definido) }}</span>
                  {% else %}<span class="small-muted">—</span>{% endif %}
                </td>
                <td class="small">
                  {{ (p.updated_at or p.created_at).strftime('%d/%m/%Y %H:%M') if (p.updated_at or p.created_at) else '—' }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="small-muted">Você ainda não enviou PAF este ano.</div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Modal: já enviou PAF -->
{% set ja_enviou = (pafs|length > 0) %}
{% set ultimo = pafs|first if ja_enviou else None %}
<div id="modal-ja-enviou" class="modal-backdrop-custom" aria-hidden="true">
  <div class="modal-card">
    <div class="p-3 border-bottom">
      <h5 class="m-0">PAF já enviado</h5>
      <div class="small text-muted mt-1">
        Você já enviou um PAF para {{ ano }}. Não é possível enviar outro.
      </div>
    </div>
    <div class="p-3 d-flex justify-content-end gap-2">
      {% if ultimo %}
        <a class="btn btn-outline-primary" href="{{ url_for('paf.detalhe', paf_id=ultimo.id) }}">Abrir meu PAF</a>
      {% endif %}
      <button type="button" class="btn btn-secondary" id="fechar-ja-enviou">Fechar</button>
    </div>
  </div>
</div>

<script>
(() => {
  const jaEnviou = {{ (pafs|length > 0)|tojson }};
  const btn = document.getElementById('btn-novo-paf');
  const modal = document.getElementById('modal-ja-enviou');
  const fechar = document.getElementById('fechar-ja-enviou');

  function abrir(){ modal?.classList.add('show'); modal?.setAttribute('aria-hidden','false'); }
  function fecharFn(){ modal?.classList.remove('show'); modal?.setAttribute('aria-hidden','true'); }

  fechar?.addEventListener('click', fecharFn);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) fecharFn(); });

  btn?.addEventListener('click', (e) => {
    if (jaEnviou) { e.preventDefault(); abrir(); }
  });
})();
</script>
{% endblock %}
