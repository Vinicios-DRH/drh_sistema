{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    :root {
        --brand-red: #B5121B;
        --brand-red-600: #9e1119;
        --glass-bg: rgba(255, 255, 255, .06);
        --glass-brd: rgba(255, 255, 255, .16);
        --ink-200: #e8eef6;
        --ink-400: #c0cfda;
    }

    body {
        background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
    }

    .brand-header {
        background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        color: var(--ink-200);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        color: var(--ink-200);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    .btn-primary {
        background: var(--brand-red);
        border-color: var(--brand-red);
    }

    .btn-primary:hover {
        background: var(--brand-red-600);
        border-color: var(--brand-red-600);
    }

    .small-muted {
        color: #94a3b8;
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .15rem .6rem;
        font-size: .78rem;
        border-radius: 999px;
        border: 1px solid var(--glass-brd);
        background: rgba(255, 255, 255, .06)
    }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
    <div class="container-xxl">

        <!-- Cabeçalho -->
        <div class="brand-header p-3 p-md-4 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded"
                        alt="CBMAM">
                    <div>
                        <h1 class="h5 m-0">Editar PAF — {{ ano }}</h1>
                        <div class="small opacity-75">
                            {{ militar.nome_completo if militar else 'Usuário' }}
                            {% if posto_grad_sigla|default('') %} · PG: {{ posto_grad_sigla }}{% endif %}
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('paf.minhas') }}" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>

        {% if motivo_reprovacao %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-octagon me-1"></i>
            <strong>Reprovado pela chefia.</strong> Motivo: {{ motivo_reprovacao }}
        </div>
        {% endif %}

        <div class="row g-3">
            <div class="col-12 col-lg-7">
                <form class="glass-card p-3 p-md-4" method="post" action="{{ url_for('paf.editar', paf_id=paf.id) }}"
                    id="form-paf">
                    <h2 class="h6 m-0 mb-3"><i class="bi bi-calendar2-check me-1"></i> Suas opções de recebimento</h2>

                    {% set meses_full =
                    ["Janeiro",
                    "Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]
                    %}

                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label">Primeira opção</label>
                            <select class="form-select mes" name="opcao_1" required>
                                <option value="">Selecione...</option>
                                {% for m in range(4,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_1|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Segunda opção</label>
                            <select class="form-select mes" name="opcao_2" required>
                                <option value="">Selecione...</option>
                                {% for m in range(4,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_2|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Terceira opção</label>
                            <select class="form-select mes" name="opcao_3" required>
                                <option value="">Selecione...</option>
                                {% for m in range(4,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_3|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mt-3 small text-danger d-none" id="msg-duplicado">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                        As três opções devem ser <strong>diferentes</strong>.
                    </div>

                    <hr class="my-4">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                        <h2 class="h6 m-0">
                            <i class="bi bi-calendar3-range me-1"></i>
                            Planejamento dos Períodos de Férias — {{ ano }}
                        </h2>
                        <div class="small-muted">
                            Direito total:
                            <span class="chip"><i class="bi bi-sun me-1"></i>
                                <span id="lbl-direito">{{ direito_total_dias or 30 }}</span> dias
                            </span>
                        </div>
                    </div>

                    <input type="hidden" name="ano_referencia" value="{{ ano }}">
                    <input type="hidden" name="direito_total_dias" id="direito_total_dias"
                        value="{{ direito_total_dias or 30 }}">

                    <div class="row g-3" id="bloco-ferias">
                        <!-- Período 1 -->
                        <div class="col-12">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>1º Período</strong>
                                    <span class="small-muted" id="p1-restante"></span>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd1" name="qtd1" required>
                                            {% for d in [10,15,20,30] %}
                                            <option value="{{d}}" {{ 'selected' if (qtd1|default('')|int)==d else '' }}>
                                                {{ d }} dias</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio1" name="inicio1"
                                            value="{{ inicio1 }}" min="2024-01-01" max="2026-12-31">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim1" name="fim1" value="{{ fim1 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes1" name="mes1">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Período 2 -->
                        <div class="col-12" id="box-p2">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>2º Período</strong>
                                    <span class="small-muted" id="p2-restante"></span>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd2" name="qtd2">
                                            <option value="">Selecione...</option>
                                            {% for d in [10,15,20] %}
                                            <option value="{{d}}" {{ 'selected' if (qtd2|default('')|int)==d else '' }}>
                                                {{ d }} dias</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio2" name="inicio2"
                                            value="{{ inicio2 }}" min="2024-01-01" max="2026-12-31">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim2" name="fim2" value="{{ fim2 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes2" name="mes2">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div id="p2-gap-msg" class="small text-warning d-none mt-2">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Para 40 dias, deve haver intervalo mínimo de 6 meses entre o início do 1º e 2º
                                        períodos.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Período 3 -->
                        <div class="col-12" id="box-p3">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>3º Período</strong>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd3" name="qtd3">
                                            <option value="">Selecione...</option>
                                            <option value="10" {{ 'selected' if (qtd3|default('')|int)==10 else '' }}>10
                                                dias</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio3" name="inicio3"
                                            value="{{ inicio3 }}" min="2024-01-01" max="2026-12-31">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim3" name="fim3" value="{{ fim3 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes3" name="mes3">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumo/erros -->
                        <div class="col-12">
                            <div class="small-muted">Restando: <span id="dias-restantes">{{ direito_total_dias or 30
                                    }}</span> dias</div>
                            <div id="msg-erro-ferias" class="mt-2 text-danger d-none">
                                <i class="bi bi-x-circle me-1"></i>
                                Verifique os períodos: combinação inválida para o direito total.
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" rows="3"
                            name="observacoes">{{ observacoes|default('') }}</textarea>
                    </div>

                    <div class="d-flex align-items-center gap-2 mt-4">
                        <a href="{{ url_for('paf.minhas') }}" class="btn btn-outline-secondary">Cancelar</a>
                        <button class="btn btn-primary" type="submit" id="btn-submit">
                            <span class="me-1"><i class="bi bi-send"></i></span> Salvar e reenviar
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-12 col-lg-5">
                <div class="glass-card p-3 p-md-4">
                    <h2 class="h6 m-0 mb-2"><i class="bi bi-info-circle me-1"></i> Dica</h2>
                    <div class="small-muted">
                        Revise as três opções de pagamento e ajuste os períodos conforme a orientação da chefia.
                    </div>
                    <div class="small-muted">
                        Você só pode escolher os dias de usufruto até o dia 31/12/2026.
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
    (() => {
        // Configuração de datas permitidas
        const DATA_MINIMA = '2024-01-01';
        const DATA_MAXIMA = '2026-12-31';

        // Elementos do DOM
        const selects = Array.from(document.querySelectorAll('select.mes'));
        const msgDup = document.getElementById('msg-duplicado');
        const btn = document.getElementById('btn-submit');
        const msgErro = document.getElementById('msg-erro-ferias');
        const gapMsg = document.getElementById('p2-gap-msg');
        const diasRestantes = document.getElementById('dias-restantes');

        // Elementos dos períodos
        const qtd1 = document.getElementById('qtd1'), inicio1 = document.getElementById('inicio1'), fim1 = document.getElementById('fim1'), mes1 = document.getElementById('mes1');
        const qtd2 = document.getElementById('qtd2'), inicio2 = document.getElementById('inicio2'), fim2 = document.getElementById('fim2'), mes2 = document.getElementById('mes2');
        const qtd3 = document.getElementById('qtd3'), inicio3 = document.getElementById('inicio3'), fim3 = document.getElementById('fim3'), mes3 = document.getElementById('mes3');
        const boxP2 = document.getElementById('box-p2');
        const boxP3 = document.getElementById('box-p3');

        // Direito total de férias
        const direito = parseInt(document.getElementById('direito_total_dias').value) || 30;

        // ===== VALIDAÇÃO DAS OPÇÕES DE MÊS =====
        function lockDuplicates() {
            const chosen = new Set(selects.map(s => s.value).filter(Boolean));
            selects.forEach(sel => {
                Array.from(sel.options).forEach(opt => {
                    if (!opt.value) return;
                    const isMine = sel.value === opt.value;
                    opt.disabled = !isMine && chosen.has(opt.value);
                });
            });
        }

        function validateDistinct() {
            const vals = selects.map(s => s.value).filter(Boolean);
            const ok = new Set(vals).size === vals.length;
            msgDup?.classList.toggle('d-none', ok);
            return ok;
        }

        function onChange() {
            lockDuplicates();
            validateDistinct();
        }

        selects.forEach(s => s.addEventListener('change', onChange));
        onChange();

        // ===== LÓGICA DINÂMICA DOS PERÍODOS (igual ao template novo) =====
        const pad = v => String(v).padStart(2, '0');
        const addDaysISO = (iso, n) => {
            if (!iso) return "";
            const d = new Date(iso + "T00:00:00");
            d.setDate(d.getDate() + n);
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        };

        const endDateInclusive = (startISO, dias) => {
            if (!startISO || !dias) return "";

            const dataFim = addDaysISO(startISO, Number(dias) - 1);
            const dataMax = new Date(DATA_MAXIMA);
            const dataFimObj = new Date(dataFim + "T00:00:00");

            // Se a data fim ultrapassar 2026, ajusta para 31/12/2026
            if (dataFimObj > dataMax) {
                return DATA_MAXIMA;
            }

            return dataFim;
        };

        const monthFromISO = iso => {
            if (!iso) return "";
            const d = new Date(iso + "T00:00:00");
            return (d.getMonth() + 1).toString();
        };

        const addMonthsISO = (iso, months) => {
            if (!iso) return "";
            const d = new Date(iso + "T00:00:00");
            const day = d.getDate();
            d.setMonth(d.getMonth() + months);
            while (d.getDate() < day) d.setDate(d.getDate() - 1);
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        };

        function setOptionsPreserve(select, vals) {
            const current = select.value;
            const optionsHtml = '<option value="">Selecione...</option>' +
                vals.map(v => `<option value="${v}">${v} dias</option>`).join('');
            select.innerHTML = optionsHtml;
            // preserva seleção se ainda for válida
            if (current && vals.map(String).includes(String(parseInt(current)))) {
                select.value = current;
            }
        }

        function calcRestante() {
            const v1 = parseInt(qtd1.value || 0), v2 = parseInt(qtd2.value || 0), v3 = parseInt(qtd3.value || 0);
            return direito - (v1 + v2 + v3);
        }

        function validCombo30(v1, v2, v3) {
            const arr = [v1 || 0, v2 || 0, v3 || 0].filter(Boolean).sort((a, b) => a - b).join('+');
            return (arr === '30' || arr === '10+20' || arr === '15+15' || arr === '10+10+10');
        }

        function recomputeFimEMes(inicioEl, qtdEl, fimEl, mesEl) {
            const d = inicioEl.value;
            const q = parseInt(qtdEl.value || 0);
            fimEl.value = (d && q) ? endDateInclusive(d, q) : "";
            if (d) mesEl.value = monthFromISO(d);
        }

        function enforceRules() {
            const v1 = parseInt(qtd1.value || 0);
            const v2 = parseInt(qtd2.value || 0);
            const v3 = parseInt(qtd3.value || 0);

            if (direito === 40) {
                // 20 + 20, sem 3º
                setOptionsPreserve(qtd1, [20]);
                setOptionsPreserve(qtd2, [20]);
                setOptionsPreserve(qtd3, []);
                boxP2.classList.remove('d-none');
                boxP3.classList.add('d-none');
                qtd3.value = '';
                inicio3.value = '';
                fim3.value = '';
                mes3.value = '';

                if (inicio1.value) {
                    inicio2.min = addMonthsISO(inicio1.value, 6);
                } else {
                    inicio2.min = DATA_MINIMA;
                }

                gapMsg?.classList.toggle('d-none', !(inicio1.value && inicio2.value));
            } else {
                // 30 dias
                setOptionsPreserve(qtd1, [10, 15, 20, 30]);

                if (v1 === 30) {
                    setOptionsPreserve(qtd2, []);
                    setOptionsPreserve(qtd3, []);
                    boxP2.classList.add('d-none');
                    boxP3.classList.add('d-none');
                    qtd2.value = '';
                    inicio2.value = '';
                    fim2.value = '';
                    mes2.value = '';
                    qtd3.value = '';
                    inicio3.value = '';
                    fim3.value = '';
                    mes3.value = '';
                } else if (v1 === 20) {
                    setOptionsPreserve(qtd2, [10]);
                    setOptionsPreserve(qtd3, []);
                    boxP2.classList.remove('d-none');
                    boxP3.classList.add('d-none');
                    qtd3.value = '';
                    inicio3.value = '';
                    fim3.value = '';
                    mes3.value = '';
                } else if (v1 === 15) {
                    setOptionsPreserve(qtd2, [15]);
                    setOptionsPreserve(qtd3, []);
                    boxP2.classList.remove('d-none');
                    boxP3.classList.add('d-none');
                    qtd3.value = '';
                    inicio3.value = '';
                    fim3.value = '';
                    mes3.value = '';
                } else if (v1 === 10) {
                    setOptionsPreserve(qtd2, [10, 20]);
                    boxP2.classList.remove('d-none');

                    if (v2 === 20) {
                        setOptionsPreserve(qtd3, []);
                        boxP3.classList.add('d-none');
                        qtd3.value = '';
                        inicio3.value = '';
                        fim3.value = '';
                        mes3.value = '';
                    } else if (v2 === 10) {
                        setOptionsPreserve(qtd3, [10]);
                        boxP3.classList.remove('d-none');
                    } else {
                        setOptionsPreserve(qtd3, []);
                        boxP3.classList.add('d-none');
                    }
                } else {
                    setOptionsPreserve(qtd2, []);
                    setOptionsPreserve(qtd3, []);
                    boxP2.classList.add('d-none');
                    boxP3.classList.add('d-none');
                }

                gapMsg?.classList.add('d-none');
                inicio2.min = DATA_MINIMA;
            }

            // recalcula fim e mês automaticamente
            recomputeFimEMes(inicio1, qtd1, fim1, mes1);
            recomputeFimEMes(inicio2, qtd2, fim2, mes2);
            recomputeFimEMes(inicio3, qtd3, fim3, mes3);

            const rest = calcRestante();
            diasRestantes.textContent = String(rest);

            // valida combinação
            const anyChosen = Boolean(v1 || v2 || v3);
            if (!anyChosen) {
                msgErro.classList.add('d-none');
                return;
            }

            const comboOK = (direito === 40) ? (v1 === 20 && v2 === 20 && !v3) : validCombo30(v1, v2, v3);
            msgErro.classList.toggle('d-none', (comboOK && rest === 0));
        }

        // Event listeners para a lógica dinâmica
        [qtd1, qtd2, qtd3, inicio1, inicio2, inicio3].forEach(e => {
            if (e) e.addEventListener('change', () => {
                if (e === inicio1) mes1.value = monthFromISO(inicio1.value);
                if (e === inicio2) mes2.value = monthFromISO(inicio2.value);
                if (e === inicio3) mes3.value = monthFromISO(inicio3.value);
                enforceRules();
            });
        });

        [inicio1, inicio2].forEach(inp => {
            if (inp) inp.addEventListener('change', () => {
                if (direito !== 40) return;
                if (inicio1.value) {
                    const minP2 = addMonthsISO(inicio1.value, 6);
                    inicio2.min = minP2;
                    if (inicio2.value && inicio2.value < minP2) {
                        inicio2.value = '';
                        fim2.value = '';
                        mes2.value = '';
                    }
                }
                gapMsg?.classList.toggle('d-none', !(inicio1.value && inicio2.value));
            });
        });

        // Validação final para submit
        function validateFerias() {
            enforceRules();
            const rest = calcRestante();
            const v1 = parseInt(qtd1.value || 0), v2 = parseInt(qtd2.value || 0), v3 = parseInt(qtd3.value || 0);
            let ok = true;

            if (direito === 40) {
                ok = (v1 === 20 && v2 === 20 && !v3 && inicio1.value && inicio2.value);
                if (ok && inicio1.value && inicio2.value) {
                    const minP2 = addMonthsISO(inicio1.value, 6);
                    if (inicio2.value < minP2) ok = false;
                }
            } else {
                ok = validCombo30(v1, v2, v3);
            }
            ok = ok && rest === 0 && !!inicio1.value && !!mes1.value;

            if (!ok) {
                msgErro.classList.remove('d-none');
            }
            return ok;
        }

        // Inicialização
        enforceRules();
        qtd1.addEventListener('change', enforceRules);
        qtd2.addEventListener('change', enforceRules);
        qtd3.addEventListener('change', enforceRules);

        // Submit guard
        document.getElementById('form-paf')?.addEventListener('submit', (e) => {
            if (!validateDistinct() || !validateFerias()) {
                e.preventDefault();
                alert('Por favor, corrija os erros antes de enviar.');
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        });
    })();
</script>
{% endblock %}