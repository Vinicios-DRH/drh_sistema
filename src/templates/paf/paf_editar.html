{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    :root {
        --brand-red: #B5121B;
        --brand-red-600: #9e1119;
        --glass-bg: rgba(255, 255, 255, .06);
        --glass-brd: rgba(255, 255, 255, .16);
        --ink-200: #e8eef6;
        --ink-400: #c0cfda;
    }

    body {
        background: linear-gradient(135deg, #0e1726 0%, #0b2e4f 45%, #0b3a63 100%) fixed;
    }

    .brand-header {
        background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .02));
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        color: var(--ink-200);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-brd);
        border-radius: 16px;
        color: var(--ink-200);
        box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    .btn-primary {
        background: var(--brand-red);
        border-color: var(--brand-red);
    }

    .btn-primary:hover {
        background: var(--brand-red-600);
        border-color: var(--brand-red-600);
    }

    .small-muted {
        color: #94a3b8;
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .15rem .6rem;
        font-size: .78rem;
        border-radius: 999px;
        border: 1px solid var(--glass-brd);
        background: rgba(255, 255, 255, .06)
    }
</style>
{% endblock %}

{% block body %}
<section class="py-3 py-md-4">
    <div class="container-xxl">

        <!-- Cabeçalho -->
        <div class="brand-header p-3 p-md-4 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ url_for('static', filename='img/logobm.png') }}" width="56" height="56" class="rounded"
                        alt="CBMAM">
                    <div>
                        <h1 class="h5 m-0">Editar PAF — {{ ano }}</h1>
                        <div class="small opacity-75">
                            {{ militar.nome_completo if militar else 'Usuário' }}
                            {% if posto_grad_sigla|default('') %} · PG: {{ posto_grad_sigla }}{% endif %}
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('paf.minhas') }}" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>

        {% if motivo_reprovacao %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-octagon me-1"></i>
            <strong>Reprovado pela chefia.</strong> Motivo: {{ motivo_reprovacao }}
        </div>
        {% endif %}

        <div class="row g-3">
            <div class="col-12 col-lg-7">
                <form class="glass-card p-3 p-md-4" method="post" action="{{ url_for('paf.editar', paf_id=paf.id) }}"
                    id="form-paf">
                    <h2 class="h6 m-0 mb-3"><i class="bi bi-calendar2-check me-1"></i> Suas opções de recebimento</h2>

                    {% set meses_full =
                    ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"]
                    %}

                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label">Primeira opção</label>
                            <select class="form-select mes" name="opcao_1" required>
                                <option value="">Selecione...</option>
                                {% for m in range(1,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_1|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Segunda opção</label>
                            <select class="form-select mes" name="opcao_2" required>
                                <option value="">Selecione...</option>
                                {% for m in range(1,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_2|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Terceira opção</label>
                            <select class="form-select mes" name="opcao_3" required>
                                <option value="">Selecione...</option>
                                {% for m in range(1,13) %}
                                <option value="{{m}}" {{ 'selected' if (opcao_3|default('')|int)==m else '' }}>
                                    {{ meses_full[m-1] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mt-3 small text-danger d-none" id="msg-duplicado">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                        As três opções devem ser <strong>diferentes</strong>.
                    </div>

                    <hr class="my-4">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                        <h2 class="h6 m-0">
                            <i class="bi bi-calendar3-range me-1"></i>
                            Planejamento dos Períodos de Férias — {{ ano }}
                        </h2>
                        <div class="small-muted">
                            Direito total:
                            <span class="chip"><i class="bi bi-sun me-1"></i>
                                <span id="lbl-direito">{{ direito_total_dias or 30 }}</span> dias
                            </span>
                        </div>
                    </div>

                    <input type="hidden" name="ano_referencia" value="{{ ano }}">
                    <input type="hidden" name="direito_total_dias" id="direito_total_dias"
                        value="{{ direito_total_dias or 30 }}">

                    <div class="row g-3" id="bloco-ferias">
                        <!-- Período 1 -->
                        <div class="col-12">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>1º Período</strong>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd1" name="qtd1" required>
                                            {% for d in [10,15,20,30] %}
                                            <option value="{{d}}" {{ 'selected' if (qtd1|default('')|int)==d else '' }}>
                                                {{ d }} dias</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio1" name="inicio1"
                                            value="{{ inicio1 }}">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim1" name="fim1" value="{{ fim1 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes1" name="mes1">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Período 2 -->
                        <div class="col-12" id="box-p2">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>2º Período</strong>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd2" name="qtd2">
                                            <option value="">Selecione...</option>
                                            {% for d in [10,15,20] %}
                                            <option value="{{d}}" {{ 'selected' if (qtd2|default('')|int)==d else '' }}>
                                                {{ d }} dias</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio2" name="inicio2"
                                            value="{{ inicio2 }}">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim2" name="fim2" value="{{ fim2 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes2" name="mes2">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Período 3 -->
                        <div class="col-12" id="box-p3">
                            <div class="p-3 rounded border" style="border-color:var(--glass-brd)">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong>3º Período</strong>
                                </div>
                                <div class="row g-3 align-items-end">
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Quantidade de dias</label>
                                        <select class="form-select" id="qtd3" name="qtd3">
                                            <option value="">Selecione...</option>
                                            <option value="10" {{ 'selected' if (qtd3|default('')|int)==10 else '' }}>10
                                                dias</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data início</label>
                                        <input type="date" class="form-control" id="inicio3" name="inicio3"
                                            value="{{ inicio3 }}">
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Data fim</label>
                                        <input type="date" class="form-control" id="fim3" name="fim3" value="{{ fim3 }}"
                                            readonly>
                                    </div>
                                    <div class="col-12 col-md-3">
                                        <label class="form-label">Mês de usufruto</label>
                                        <select class="form-select" id="mes3" name="mes3">
                                            <option value="">Selecione...</option>
                                            {% for m in range(1,13) %}
                                            <option value="{{m}}">{{ meses_full[m-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div id="msg-erro-ferias" class="mt-2 text-danger d-none">
                                <i class="bi bi-x-circle me-1"></i>
                                Verifique os períodos: combinação inválida para o direito total.
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" rows="3"
                            name="observacoes">{{ observacoes|default('') }}</textarea>
                    </div>

                    <div class="d-flex align-items-center gap-2 mt-4">
                        <a href="{{ url_for('paf.minhas') }}" class="btn btn-outline-secondary">Cancelar</a>
                        <button class="btn btn-primary" type="submit" id="btn-submit">
                            <span class="me-1"><i class="bi bi-send"></i></span> Salvar e reenviar
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-12 col-lg-5">
                <div class="glass-card p-3 p-md-4">
                    <h2 class="h6 m-0 mb-2"><i class="bi bi-info-circle me-1"></i> Dica</h2>
                    <div class="small-muted">
                        Revise as três opções de pagamento e ajuste os períodos conforme a orientação da chefia.
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
    (() => {
        // LIMITE ABSOLUTO
        const LIM_ANO = 2026;
        const LIM_MIN = `${LIM_ANO}-01-01`;
        const LIM_MAX = `${LIM_ANO}-12-31`;

        // elementos de data
        const inicio1 = document.getElementById('inicio1');
        const inicio2 = document.getElementById('inicio2');
        const inicio3 = document.getElementById('inicio3');
        const fim1 = document.getElementById('fim1');
        const fim2 = document.getElementById('fim2');
        const fim3 = document.getElementById('fim3');
        const msgErro = document.getElementById('msg-erro-ferias') || document.createElement('div');

        // Meses distintos (mesmo JS do novo)
        const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const selects = Array.from(document.querySelectorAll('select.mes'));
        const msgDup = document.getElementById('msg-duplicado');
        const btn = document.getElementById('btn-submit');

        // aplica min/max aos date inputs (se existirem)
        [inicio1, inicio2, inicio3, fim1, fim2, fim3].forEach(inp => {
            if (!inp) return;
            inp.setAttribute('min', LIM_MIN);
            inp.setAttribute('max', LIM_MAX);
        });

        // util: verifica se iso-date está dentro do limite
        const inLimit = iso => {
            if (!iso) return true; // vazio não é verificação aqui
            return iso >= LIM_MIN && iso <= LIM_MAX;
        };

        // mostra mensagem simples (pode customizar)
        function showYearError(show) {
            if (!msgErro.parentNode) {
            msgErro.id = 'msg-erro-ferias';
            msgErro.className = 'mt-2 text-danger';
            msgErro.innerHTML = '<i class="bi bi-x-circle me-1"></i> Datas devem ficar até 31/12/2026.';
            const bloco = document.getElementById('bloco-ferias');
            bloco && bloco.appendChild(msgErro);
            }
            msgErro.style.display = show ? 'block' : 'none';
        }

        // checa todos os campos de data atuais e também confere fim calculado
        function checkYearLimits() {
            const dates = [inicio1?.value, inicio2?.value, inicio3?.value, fim1?.value, fim2?.value, fim3?.value];
            const invalid = dates.some(d => d && !inLimit(d));
            // desabilita o botão de submit se inválido
            if (btn) btn.disabled = invalid;
            showYearError(invalid);
            return !invalid;
        }

        // adiciona listeners para checar dinamicamente
        [inicio1, inicio2, inicio3, fim1, fim2, fim3].forEach(el => {
            if (!el) return;
            el.addEventListener('change', () => {
            // se o fim for maior que LIM_MAX, limpa o fim e força o usuário ajustar
            if (el === inicio1 && fim1 && fim1.value && !inLimit(fim1.value)) fim1.value = '';
            if (el === inicio2 && fim2 && fim2.value && !inLimit(fim2.value)) fim2.value = '';
            if (el === inicio3 && fim3 && fim3.value && !inLimit(fim3.value)) fim3.value = '';
            checkYearLimits();
            });
        });
        
        // hook no submit: impede envio se passar do limite
        const form = document.getElementById('form-paf');
        form?.addEventListener('submit', (e) => {
            if (!checkYearLimits()) {
            e.preventDefault();
            alert('Alguma data ultrapassa 31/12/2026. Ajuste antes de enviar.');
            return;
            }
            // se preferir, aqui já desabilita o botão e mostra spinner (UX)
            if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            }
        });
        
        function lockDuplicates() {
            const chosen = new Set(selects.map(s => s.value).filter(Boolean));
            selects.forEach(sel => {
                Array.from(sel.options).forEach(opt => {
                    if (!opt.value) return;
                    const isMine = sel.value === opt.value;
                    opt.disabled = !isMine && chosen.has(opt.value);
                });
            });
        }
        function validateDistinct() {
            const vals = selects.map(s => s.value).filter(Boolean);
            const ok = new Set(vals).size === vals.length;
            msgDup?.classList.toggle('d-none', ok);
            btn.disabled = !ok || vals.length < 3;
            return ok;
        }
        function onChange() { lockDuplicates(); validateDistinct(); }
        selects.forEach(s => s.addEventListener('change', onChange));
        onChange();

        // Autocalcular fim (igual ao novo — simplificado)
        const pad = v => String(v).padStart(2, '0');
        const addDaysISO = (iso, n) => { if (!iso) return ""; const d = new Date(iso + "T00:00:00"); d.setDate(d.getDate() + n); return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`; };
        const endDateInclusive = (startISO, dias) => startISO && dias ? addDaysISO(startISO, Number(dias) - 1) : "";

        function wirePeriodo(qSel, iSel, fSel) {
            const qtd = document.getElementById(qSel);
            const ini = document.getElementById(iSel);
            const fim = document.getElementById(fSel);
            function recompute() { fim.value = endDateInclusive(ini.value, parseInt(qtd.value || 0)) || ""; }
            qtd?.addEventListener('change', recompute);
            ini?.addEventListener('change', recompute);
            recompute();
        }
        wirePeriodo("qtd1", "inicio1", "fim1");
        wirePeriodo("qtd2", "inicio2", "fim2");
        wirePeriodo("qtd3", "inicio3", "fim3");

        // Submit guard
        document.getElementById('form-paf')?.addEventListener('submit', (e) => {
            if (!validateDistinct()) {
                e.preventDefault();
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        });

        // inicial check
        checkYearLimits();
    })();
</script>
{% endblock %}